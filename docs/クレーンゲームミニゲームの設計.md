# クレーンゲームミニゲーム（仮称: XP Crane Catcher Mod）設計

## 目的
- クレーンゲームの操作感を活かして経験値カプセルを掬い上げる楽しさを提供する。
- ミニEXPフレームワークの`create(root, awardXp, opts)`に準拠し、取得したカプセルに応じたEXP報酬を与える。
- 難易度ごとに落下速度・カプセル密度・制限時間を調整してリプレイ性を高める。

## 仕様概要
- フィールド
  - 横幅: 420px、高さ: 480pxの筐体エリアをCanvas上に描画。
  - 底面には傾斜した排出口と、左側にクレーンの待機位置。
  - 天井から経験値カプセル（以下カプセル）が定期的に落下し、底面で跳ねながら停止する。
- クレーンアーム
  - 水平方向のレールを左右に移動。`A/D`キーまたは矢印キー、タッチ・ドラッグにも対応。
  - `SPACE`キーまたはクリックでクレーン下降開始。下降中は横移動不可。
  - アームは下降→掴み判定→上昇→排出口まで移動→放出のシーケンスを自動実行。
  - 掴み判定はアーム中心から半径40px内のカプセルに対して行い、サイズ・重量によって成功率が変動。
- カプセル
  - サイズ3種（S/M/L）、色と形で経験値タイプを表現。
  - 落下中は軽いランダムドリフトと回転を付与。底に触れると弾性0.2のバウンド後、静止。
  - EASY: カプセル密度高、落下速度遅い。HARD: 密度低いが落下速度速く、一部特別カプセルが混ざる。
- 制限
  - 1プレイ60秒。時間内にできるだけ多くのカプセルを獲得。
  - クレーン行動1回あたりアニメーション所要約3秒。操作が早いほど試行回数が増える。
  - アームには保持力メーターを導入し、大型カプセル連続獲得で低下。メーターが低いと掴み中に落下する可能性。

## EXP設計
- カプセル毎の基礎EXP
  - 小: 3EXP、中: 7EXP、大: 15EXP。
  - 特殊（虹色）カプセル: 20EXP + 周囲半径60pxにある未取得カプセルを磁力で吸引して追加獲得。
- 連続ボーナス
  - 連続成功数×2EXPを加算。失敗（掴めず）でリセット。
- タイムボーナス
  - 残り時間1秒につき0.2EXPを終了時に加算。
- シークレットボーナス
  - 30秒以内に大型カプセルを3個獲得で追加10EXP。

## UI
- Canvas上部に残り時間、現在EXP、連続成功数、保持力メーターを表示。
- アーム周辺には掴み範囲の半透明サークルを表示し、下降中は色を変えてわかりやすくする。
- 獲得時はカプセルからEXP値がポップアップし、排出口に落ちたカプセルは消えて結果に加算。
- ゲーム終了後は総獲得EXP、成功回数、特別ボーナス達成状況をまとめたリザルトパネルを表示。
- リスタートボタンと`R`キーによる再挑戦をサポート。

## 内部構造
- エクスポート形式: `window.MINI_GAMES.push({ id: "xp_crane", create })`。`create`は`(root, awardXp, opts)`を受け、`destroy()`を返却。
- 状態管理
  - `state = { timeLeft, score, combo, grip, phase, craneX, targetX, clawY, clawGrabbed, queue }`など。
  - `capsules`配列に `{ x, y, vx, vy, radius, type, grabbed, falling }`を保持。
  - `particles`配列で獲得時の演出を管理。
- 主な処理
  1. `spawnLoop`で一定間隔（難易度で調整）ごとにカプセル生成。
  2. `update(dt)`でカプセル物理（重力、摩擦、床との衝突）、クレーンフェーズの進行、保持力回復を計算。
  3. クレーン下降中にカプセルと距離チェックし、掴み候補を決定。成功率は`grip`とカプセル種で算出。
  4. 掴み成功時は`capsule.grabbed = true`とし、クレーン位置に追従。排出口に到達すると`awardXp(total)`を呼び出し、カプセルを除去。
  5. `combo`と`grip`の更新、特殊カプセルの磁力処理、タイムアップ判定を行う。
  6. `destroy()`では`requestAnimationFrame`ループやイベントリスナーを解除。

## テスト項目
- クレーン操作: 左右入力・タッチ操作でレール上を滑らかに移動できる。
- 掴み判定: アーム半径内のカプセルのみ取得し、サイズ別成功率が適用される。
- 特殊カプセル: 吸引処理で周囲カプセルが排出口まで移動し、EXPが正しく加算される。
- 連続成功ボーナスと保持力メーター: 成功時に加算・減算が反映され、保持力低下時に失敗が増える。
- タイムアップ時にゲームが停止し、リザルト表示とEXP加算が行われる。
- 難易度EASY/NORMAL/HARDで落下間隔やカプセル構成、制限時間が適切に変化する。
