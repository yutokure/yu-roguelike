# タイピングミニゲームの設計

本設計は「ミニゲームAPI書（MiniExp MOD API v0.2）」準拠。60秒でできるリアルタイムタイピング練習ゲーム。キー入力に応じて即時にEXPを授与し、終了時に精度ボーナスで追加EXPを与えます。

- ID: `typing`
- 表示名: タイピングチャレンジ
- エントリ: `games/typing.js`
- バージョン: 0.1.0
- カテゴリ: "スキル"

## ルール/操作
- 60秒間に提示されるワード/短文を順にタイプ。時間切れでラウンド終了。
- キーボード入力（英数字/記号）をフックし、正しい文字ならカーソルが進行。誤入力は即時赤点灯＆ミスカウント。
- バックスペースで現在ワードの未確定文字を削除可能。Enter/Spaceでワード確定。
- 終了時に正タイプ数・ミスタイプ数・精度・WPMを集計して結果表示。

## 設定/難易度
- 開始前に難易度を `EASY / NORMAL / HARD` から選択。
  - EASY: 4〜6文字の一般単語、表示は1行。制限時間60秒（既定）。
  - NORMAL: 5〜10文字、アルファベット+記号（ハイフン/アポストロフィ）を含む文節。残り15秒で残り時間ポップアップ。
  - HARD: 8〜16文字、CamelCase/スネークケース/簡単な記号列、視認性向上のため等幅フォント。残り30秒から背景にタイムゲージを表示し高速化（連続ワード供給間隔を短縮）。
- 任意設定: 「ターゲットWPM」スライダー（40〜120）を用意し、結果画面で達成度を表示（EXPには影響なし）。

## EXP 仕様（必須要件の反映）
- 正タイプ（確定時に正しく入力された1文字）につき `+0.2 EXP`。`awardXp` は1単語確定時にまとめて呼び、複数文字を合算（例: 5文字ワード→+1.0 EXP）。
- ミスタイプはEXP対象外だが、連続正タイプ数（コンボ）が10・25・50に到達した瞬間にそれぞれ追加で `+3 / +8 / +20 EXP` を付与。コンボは誤入力でリセット。
- 終了時に精度（正タイプ ÷ 全入力）を算出:
  - 95%以上で `+30 EXP`
  - 98%以上で `+60 EXP`（95%以上のボーナスに置き換え）
- `awardXp` 呼び出しは以下のタイミング:
  1. ワード確定時に正タイプ分と必要なコンボボーナスを1度に加算（最大0.2×文字数+ボーナス）。
  2. 結果画面表示直前に精度ボーナスを加算。
- 付与メタ例: `{ type:'char', chars:5, combo:10 }`, `{ type:'accuracy', accuracy:0.97 }`。

## 記録/スコア
- `getScore()` は「正タイプ総文字数」を返す。
- 結果画面で以下を表示し履歴として保存（ホストの記録欄で参照想定）:
  - 正タイプ数 / ミスタイプ数
  - 精度 (%)
  - 平均WPM（正タイプ文字数 ÷ 5 ÷ 60秒 × 60）
  - 最高コンボ

## UI/演出
- ルート内構成: 上部に残り時間バー、中央に現在ワード＋次ワードプレビュー、下部に入力フィードと統計。
- 正タイプ文字は緑でハイライト、未入力は白、誤タイプは赤背景で即座に表示。
- コンボ到達時に`window.playSfx?.('pickup')`（存在確認後）とポップアップ「Combo x10! +3 EXP」。
- 残り10秒で全体背景を徐々に赤→オレンジへフェード、タイムアップ時にフラッシュ演出。
- 結果モーダル: 大きく「RESULT」見出しとEXP増加量内訳テーブルを表示。

## 実装方針（API連携）
- `create(root, awardXp, { difficulty })`:
  - 難易度に応じたワードリストをロード（ローカル配列。HARDではコード/記号セット）。
  - DOMを構築し、入力は `keydown`/`input` イベントで処理。`preventDefault()` は必要キー（Space, Backspace）でのみ実施。
  - タイマーは `requestAnimationFrame` + 経過時間管理。タイムアウトで自動終了→結果処理。
  - ワード確定時に正タイプ数を算出し `awardXp`。コンボ閾値を超えたら追加EXPも同じ呼び出しで合算。
  - `stop()` でタイマー停止＋入力無効化、`start()` で再開（再開後は残り時間から継続）。
  - `destroy()` でイベントリスナーとタイマー、DOMノードを除去。
- 乱数: `crypto.getRandomValues` か `Math.random`。ワード重複防止はシャッフルキュー。

## エラー/ガード
- IME入力は対象外（英数モードでプレイする想定）。IME検出時は警告を表示し、`keydown` ベースで処理。
- キー連打で `awardXp` が異常回数呼ばれないよう、1ワードあたり1度だけ呼ぶ。
- 非対応キー/ショートカット（例: Ctrl+R）はブラウザ既定動作を尊重し、ゲーム側で無視。
- タイマー停止時（`stop()`）には入力欄を `disabled` にし、再開で復元。
- コンボボーナス付与フラグは閾値ごとに一度だけ（10到達→付与→20で再付与など）。

## manifest.json 例
```json
{ "id": "typing", "name": "タイピングチャレンジ", "entry": "games/typing.js", "version": "0.1.0", "description": "60秒タイプで正確さとスピードを競う", "category": "スキル" }
```
