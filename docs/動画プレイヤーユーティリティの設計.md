# 動画プレイヤーユーティリティの設計

MiniExp MOD のユーティリティカテゴリに、ローカル動画ファイルや YouTube URL を再生できる「動画プレイヤー」を追加する設計。オフライン収集した学習動画の確認から、攻略配信の参照までゲーム内で気軽に動画を視聴できるツールとして提供する。再生/停止など主要操作を EXP 獲得に紐付け、MiniExp らしいモチベーションを維持しつつ閲覧体験を損なわないことを目的とする。

## 基本仕様
- カテゴリ: ユーティリティ
- 目的: ローカル動画と YouTube の閲覧をワンカードで完結させる。攻略動画・開発ログの視聴を MiniExp 内で完了させ、視聴進捗で EXP を付与する。
- 対応ソース:
  - ローカルファイル (`input[type="file"]` 経由で `video/*` を選択)。HTML5 `<video>` による再生。
  - YouTube URL (`https://www.youtube.com/watch?v=...` や `https://youtu.be/...`) を解析し、YouTube IFrame API で埋め込み再生。
  - 入力エラー時は明示的なバナーで理由を通知。
- 対応フォーマット: ローカルはブラウザ互換フォーマット（MP4/HLS/WebM 等）。YouTube は標準埋め込みストリーム。
- UI レイアウト: 左カラムにプレイヤー本体、右カラムにプレイリスト/履歴/情報カードを配置する 2 カラム構成。

## UI 構成
1. **ヘッダー**
   - タイトル「動画プレイヤー」
   - 現在のソース種別・解像度・進捗を表示するインフォパネル。
   - セッション獲得 EXP を表示。
2. **ソース切替カード**
   - タブ/セグメントボタンで「ローカル」「YouTube」を切替。
   - 各ソースに必要な入力をまとめ、バリデーションメッセージを表示。
   - YouTube 側は URL 入力欄 + 「読み込み」ボタン。成功時に埋め込みを作成。
   - ローカル側はファイル選択ボタン + 選択済みファイル名を表示。
3. **再生ビュー**
   - ローカル: `<video>` (controls, playsinline, picture-in-picture 許可、シーク/音量調整)。
   - YouTube: `<div>` プレースホルダーに `YT.Player` を生成。API 利用不可の場合は fallback `<iframe>`。
   - 共通機能: 再生/一時停止、現在時間、合計時間、音量メーターを既定の UI に委譲。状態テキストを下部に表示。
4. **再生履歴カード**
   - 直近 5 件までをローカル Storage (`mini_video_history_v1`) に保存。
   - エントリ (種別/タイトル/長さ/最終視聴時刻) をリスト化し、クリックで再度読み込み。
   - YouTube は動画タイトル取得のために `oEmbed` へ `fetch`。取得失敗時は URL をそのまま表示。
5. **ショートカット/ヒントパネル**
   - キーボードショートカット（Space: 再生/停止、`→`: +5秒、`←`: -5秒）を提示。
   - YouTube fallback ではショートカットが埋め込み内に渡る旨を記載。

## EXP ルール
- ローカル動画読込成功: +5 EXP
- YouTube 読込成功: +3 EXP
- 再生開始（play イベント / YouTube PLAYING 状態の初回）: +1 EXP
- 再生完了（HTML5 `<video>` ended / YouTube ENDED 状態）: +8 EXP
- 視聴進捗: 60 秒視聴するごとに +1 EXP（HTML5 `timeupdate` で算出）
- 履歴からの再生成功: +2 EXP
- EXP は 1 セッション内で集計し、ミニパネルと `runtime.getScore()` で返却。

## 内部状態・永続化
- `state.currentSource`: `'local' | 'youtube' | null`
- `state.currentMeta`: 選択中のタイトル・長さ・識別子。
- `state.sessionXp`: 現在のセッション EXP。
- `state.progressXpTimer`: 最後に進捗 EXP を与えた再生時間（ローカルのみ）。
- `history`: localStorage に保存する最大 20 件の履歴配列。構造 `{ id, type, title, source, duration, lastViewedAt }`。
- ローカルファイル用に `URL.createObjectURL` を利用し、切替・終了時に `URL.revokeObjectURL` で解放。
- YouTube API ロードは Promise で管理。8 秒以内に読み込めなければ fallback。

## 主な内部関数
- `loadLocalFile(file)` / `loadYouTubeUrl(url)` : ソース読込とバリデーション。
- `parseYouTubeId(url)` : `youtu.be/` やクエリ `v=` を解釈し videoId を返す。
- `ensureYouTubeApi()` : iframe API を遅延ロードし Promise を返す。既に利用可能なら即 resolve。
- `attachHtml5Video()` / `attachYouTubePlayer(videoId)` : 表示領域へプレイヤーを構築。
- `updateInfoPanel()` / `updateHistoryList()` : UI 更新。
- `award(type, amount, payload)` : `awardXp` 呼び出し + `state.sessionXp` 加算。
- `persistHistory()` / `loadHistory()` : localStorage との同期。

## 実装手順
1. `動画プレイヤーユーティリティの設計.md` を作成し、上記仕様を記載。
2. `games/video_player.js` を新規作成。
   - IIFE で `create(root, awardXp)` を定義。
   - UI コンポーネント構築、イベントハンドラ、YouTube API ロードを実装。
   - 履歴保存と EXP 付与ロジックを含める。
   - `window.registerMiniGame` で id `video_player` を登録。
3. `games/manifest.json.js` にエントリを追加。
   - `name: '動画プレイヤー'`, `entry: 'games/video_player.js'`, `category: 'ユーティリティ'`, `description` に EXP ルール概要を記載。
4. 動作確認: ローカルファイルの再生/シーク、YouTube URL 埋め込み、履歴、EXP カウントが正常に機能することを確認。
