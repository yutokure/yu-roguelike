# ドクターマリオ風ミニゲームの設計

本設計は MiniExp MOD API v0.1 に準拠し、落下カプセルでウイルスを4つ並べて消す「ドクターマリオ」風パズルを再現します。チェインによるボーナス、段階的なウイルス生成、EXP付与を実装します。

- ID: `virus_buster`
- 表示名: ドクターマリオ風
- エントリ: `games/virus_buster.js`
- バージョン: 0.1.0
- カテゴリ: パズル

## ルール/操作
- 盤面: 8列×16段。初期状態でウイルスが下半分に配置される。
- 2つ1組のカプセルが落下。上下左右に配置される半分の色を揃えて4連で消去。
- ←/→: 移動、↓: ソフトドロップ（1マス毎に+0.05EXP）、↑/X: 時計回り回転、Z: 反時計回り、Space: ハードドロップ（落下距離×0.2EXP）、R: リスタート。
- ロックディレイと落下速度は難易度依存。

## マッチング/チェイン
- 横/縦の直線で4個以上同色なら消去対象。
- カプセル片とウイルスが混在していても同色なら同時消去。
- 消去後はカプセル片が独立し、重力で落下。連続して新たな消去が発生するとチェイン。

## 難易度
- EASY: 初期ウイルス10体、ウイルス追加+2/段階、落下0.9s/マス、ロック0.65s。
- NORMAL: 初期14体、追加+3、落下0.7s、ロック0.5s。
- HARD: 初期18体、追加+4、落下0.5s、ロック0.4s。

## ステージ進行
- ウイルスを全て消すとステージクリア。レベル+1、所定数ウイルスを再配置して続行。
- ステージクリア時に固定EXP（25 + 5×(level-1)）を付与。

## EXP仕様
- ソフトドロップ: マス移動×0.05EXP。
- ハードドロップ: 落下距離×0.2EXP。
- 消去: `(消去片数×0.6 + 撃破ウイルス数×3) × (1 + 0.5×(チェイン-1))` を1チェイン毎に加算。
- ステージクリア: 25 + 5×(レベル-1)EXP。

## 記録/スコア
- `getScore()` は `{ level, virusesLeft, cleared }` を返却。
- 右パネルにレベル、残りウイルス、累計撃破数、チェイン表示を行う。

## UI/演出
- キャンバス右にステータスパネル・操作ヘルプ。
- チェイン発生時は「n Chain」「Virus x○」を表示しハイライト。
- ステージクリア時にグリーンのメッセージ。
- カプセルの接続部は2色ブリッジを描画。ウイルスは目の付いた丸で表現。

## 実装ポイント
- `grid` は `null` or `{type:'pill'|'virus', color, id, link}`。
- カプセルは `current = {id,x,y,dir,colors}`。`ORIENT` を使って位置を算出。
- `settleAfterLock()` でマッチ探索 → 消去 → `applyGravity()` → 連鎖判定。
- `applyGravity()` は縦連結（link:'down'）はペアで落下、それ以外は個別に落下。
- `cleanupLinks()` で孤立片のリンクを解除。
- `window.registerMiniGame({...})` で `virus_buster` を登録し、manifest と一致させる。

## manifest 追加例
```json
{ "id": "virus_buster", "name": "ドクターマリオ風", "entry": "games/virus_buster.js", "version": "0.1.0", "description": "カプセルで4つ揃え！ウイルス退治でEXP獲得", "category": "パズル" }
```
