# 太鼓の達人風リズムミニゲーム（仮称: Taiko Beat Mod）設計

## 目的
- ミニゲームMOD環境に和太鼓リズムアクションの体験を追加し、シンプルな2レーン入力でリズム感と達成感を提供する。
- 判定ランク（不・普・可・良）によって獲得EXPが変化し、コンボ継続によってEXPが逓増する報酬サイクルを設ける。
- ミニEXPフレームワークの`create(root, awardXp, opts)`仕様に従い、譜面データを読み込み再生する。

## ゲームフロー
1. タイトル画面（譜面選択リストと難易度表示）。
2. 譜面読み込み後にカウントイン（2拍）。
3. プレイ中は上から右方向へノーツが流れる横スクロール方式。
4. 曲終了後にリザルト（スコア、判定数、最大コンボ、総獲得EXP）を表示し、`R`で再挑戦/`Esc`で終了。

## ノーツ・レーン仕様
- レーン構造
  - 中央に大太鼓（赤ノーツ: ドン）と外周に縁打ち（青ノーツ: カッ）の2系統。
  - 譜面は1トラックに統一し、ノーツ種別のみを切り替える。
- ノーツ種別
  - `don`（赤）、`ka`（青）、`drumroll`（連打ノーツ）、`balloon`（風船ノーツ）。
- スクロール
  - BPM基準で1拍あたりの画面移動ピクセルを`scrollSpeed`として指定。
  - 判定ラインは固定。ノーツは右→左へ移動し、判定ライン到達時に入力を受け付ける。
- 入力
  - ドン: `F`/`J`キー（中央打ち）。
  - カッ: `D`/`K`キー（縁打ち）。
  - 連打ノーツ: 指定された範囲内で連打入力数に応じて判定。
  - 風船ノーツ: 所定数の連打に到達すると破裂しボーナス判定。

## 判定とEXP
- 判定ウィンドウ（ms差）
  - 良: ±30ms
  - 可: ±60ms
  - 普: ±100ms
  - 不: それ以外/不正入力
- 各判定の基本EXP
  - 良: 8EXP
  - 可: 5EXP
  - 普: 2EXP
  - 不: 0EXP
- コンボ補正
  - コンボ数`combo`（現在判定が成立した直後の連続数）に応じてボーナス係数`1 + min(0.5, combo * 0.01)`を乗算。
  - 例: 10コンボで+10%、50コンボで+50%、それ以上は+50%で頭打ち。
- 連打系ノーツ
  - `drumroll`: 判定区間内の1打ごとに可判定相当EXP（5EXP）を付与し、コンボは1回のみ加算。
  - `balloon`: 目標回数達成で良判定×3回分のEXPと追加ボーナス20EXP。未達成時は普判定扱い。
- ミス時
  - コンボリセット。`コンボリセットペナルティ = min(20, floor(maxComboDuringChain / 10))`EXPをマイナスして緊張感を演出。
- EXP計算処理
  - 判定確定時に`baseExp * comboMultiplier`を算出し`awardXp(expGained)`を呼び出す。
  - 連打ノーツ中の継続増分は1打ごとに計算。

## UI/演出
- キャンバス横長（1280×720想定）。上部に曲名・BPM・難易度・コンボ数を表示。
- 判定ラインは中央、ノーツはスプライト差し替え可能な画像アセットで描画。
- 判定結果はライン付近にポップアップ表示（不/普/可/良の文字エフェクト）。
- コンボ数が10/30/50に到達すると背景が段階的に明るくなり、太鼓の表情アイコンを変える。
- リザルト画面
  - 判定内訳、最大コンボ、総EXP、精度（良率）を表示。
  - 各判定に応じた称号（例: 良率80%以上で「達人候補」）を付与。

## サウンド同期
- WebAudio APIでBGMを再生し、譜面タイミングはAudioContextの`currentTime`に同期。
- ノーツ生成時間は譜面JSONの拍情報から秒換算してタイムラインに登録。
- 判定結果に応じて効果音（良: 強打音、可: 軽打音、普: くぐもった音、不: ミス音）を再生。

## 内部構造
- エクスポート
  - `create(root, awardXp, opts)`でDOMルート要素、EXP付与関数、`opts`（譜面ID、難易度、音量など）を受け取り、`return { destroy }`。
- 状態管理
  - `timeline`: 譜面ノーツ配列 `{ time, type, duration, balloonHits }`。
  - `activeNotes`: 画面上に存在するノーツを保持。
  - `combo`, `maxCombo`, `score`, `expTotal`, `judgementCounts`。
  - `audio`: BGMバッファ、効果音バッファ。
  - `inputState`: 各キーの押下フラグと押下履歴。
- メインループ
  1. `syncTime = audio.currentTime - startOffset`でゲーム内時間を求める。
  2. 判定ラインに近いノーツを`activeNotes`へ投入、スクロール位置を更新。
  3. 入力イベント発生時に最も近いノーツを検索し、許容ウィンドウ内で判定。
  4. 判定結果に応じてEXPとスコアを加算し、ノーツを消化。
  5. 連打系は持続時間内に複数回ヒット判定を発生させる。
  6. 曲終了判定（最後のノーツ終了＋リザーブタイム）でリザルトへ遷移。

## 譜面データ形式
- JSON形式例
```json
{
  "title": "Festival Groove",
  "artist": "Y. Composer",
  "bpm": 140,
  "offset": 0.3,
  "difficulties": {
    "easy": {
      "scrollSpeed": 280,
      "notes": [
        { "time": 0.0, "type": "don" },
        { "time": 0.5, "type": "ka" },
        { "time": 1.0, "type": "don" },
        { "time": 2.0, "type": "drumroll", "duration": 1.5 },
        { "time": 4.0, "type": "balloon", "balloonHits": 12 }
      ]
    },
    "normal": { "scrollSpeed": 320, "notes": [] },
    "hard": { "scrollSpeed": 360, "notes": [] }
  }
}
```
- `time`は曲開始からの秒数。`duration`は秒数、`balloonHits`は必要打数。

## テスト項目
- 判定ウィンドウごとの入力遅延/早打ちで正しく不・普・可・良が表示される。
- コンボが切れない限りEXPボーナス係数が累積し、50コンボ以上で固定になる。
- 連打ノーツで打数に応じてEXPが追加され、連打完了時はコンボが維持される。
- 風船ノーツ成功時に良判定3回分+20EXP、失敗時に普判定扱いになる。
- ミス時にコンボが0になり、ペナルティが一度だけ適用される。
- 曲終了後に結果画面が表示され、判定数・最大コンボ・EXPが整合する。
