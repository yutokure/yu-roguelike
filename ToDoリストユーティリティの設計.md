# ToDoリストユーティリティの設計

MiniExp MOD のユーティリティカテゴリに、シンプルなタスク管理ツールを追加する設計。プレイヤーが日々の目標を管理しながら EXP を獲得できるようにし、完了・失敗・編集などの操作を直感的な UI で提供する。

- ID: `todo_list`
- 表示名: ToDoリスト
- エントリ: `games/todo_list.js`
- バージョン: 0.1.0
- カテゴリ: ユーティリティ
- 目的: 小さなタスクを登録して進捗を管理し、完了時に経験値を受け取れるライフログ的ミニツール。

## 画面レイアウト
1. **背景**: 画面全体の背景色は純白 (`#ffffff`) 固定。余白を広めに取り、カードの影は最小限とする。
2. **ヘッダー**: 上部にタイトル「ToDoリスト」と当日の日付、現在の完了数/未完了数を表示。右側に「新規ToDo」ボタン。
3. **登録フォーム**: 画面右側またはヘッダー直下にスライドインするフォーム。以下のフィールドを持つ。
   - 名前 (必須, 32文字程度まで)
   - メモ (任意, 256文字程度)
   - 獲得EXP (必須, 0〜9999)
   - カラー (必須, カラーピッカー)
   - 追加/更新ボタン、キャンセルボタン
4. **未完了リスト**: 画面上部にグリッド/縦並び。各カードは白背景、赤系ボーダー (`#ef4444`) を2pxで描画。タイトル・メモ・作成日時・予定獲得EXP・設定カラーの小バッジを表示。操作ボタンを右側にまとめる。
5. **完了済みリスト**: 画面下部に縦並び。カードの枠線と文字色はグレー (`#d1d5db` / `#6b7280`) で統一。完了日時と「成功/失敗」ラベルを表示。失敗したタスクは赤いバッジを重ね、成功時は緑ラベル。
6. **操作ボタン群**: 各カードに以下のボタンを並べる。
   - 完了 (成功)
   - 失敗
   - 編集
   - 削除
   ボタンはテキストラベルで、色分け (完了=緑, 失敗=オレンジ, 編集=青, 削除=グレー) を行う。

## 状態管理
- `state = { tasks: Task[], editingTaskId: string|null, sessionXp: number }` を内部で保持。
- `Task` は `{ id, name, memo, xp, color, createdAt, completedAt, status }`。
  - `status` は `"pending" | "completed" | "failed"`。
  - `completedAt` は未完了の場合 `null`。
- 永続化は `localStorage['mini_todo_tasks_v1']` に保存し、起動時に復元。
- 追加/更新/削除/完了操作のたびに永続化を走らせる。失敗時はエラーを握りつぶす。

## 操作仕様
- **追加**: フォームで入力後、`pending` 状態のタスクをリストに追加。作成日時は現在時刻で記録。
- **編集**: 対象タスクの内容をフォームに読み込み、更新ボタンで確定。登録日時は保持。完了済みタスクも編集可だが、`xp` や `status` の変更には影響しない。
- **削除**: 確認ダイアログを表示してからタスクを削除。経験値は付与されない。
- **完了 (成功)**: `status` を `completed` にし、`completedAt` に現在時刻を設定。設定された EXP を `awardXp` で付与し、セッション XP に加算。
- **失敗**: `status` を `failed` にし、`completedAt` に現在時刻を設定。EXP の付与は行わない。
- 完了/失敗したタスクは下部リストに移動し、ボタンは「編集」「削除」のみ残す。

## EXP 仕様
- 完了ボタン押下で `awardXp(task.xp, { type: 'todo-complete', todoId: task.id })` を実行。
- 獲得 EXP は 0 以上で、最大 9999 とする。0 を設定した場合は演出のみで EXP 付与なし。
- 失敗ボタンは EXP を発生させず、`awardXp` 呼び出しも行わない。
- セッション内で獲得した EXP は `sessionXp` に蓄積し、`getScore()` で返却。

## API 実装方針
- `create(root, awardXp)` をエクスポートし、`registerMiniGame` に渡す。
- DOM はバニラ JS で構築し、CSS はインラインスタイル中心。クラスはプレフィックス `todo-` を付ける。
- リスト描画は `render()` でまとめて行い、各操作後に再描画。
- 日時の表示は `new Date(timestamp).toLocaleString()` を使用。ローカライズ失敗時は ISO 文字列。
- キーボード操作: `Ctrl+Enter` で追加/更新をトリガー。フォームは Enter で送信可能にする。
- `start()` / `stop()` はフォーカス保持やイベントリスナーを制御。`destroy()` で DOM を破棄し、最後に `writePersistentState(state.tasks)` を実行。

## 実装手順
1. `games/todo_list.js` を新規作成し、上記仕様に従う UI とロジックを実装。
2. `games/manifest.json.js` に ToDo リストのエントリを追加 (カテゴリ: ユーティリティ、説明文に EXP 条件を記載)。
3. 必要に応じて `style.css` 側には依存せず、モジュール内でスタイル完結させる。
4. 動作確認 (追加/編集/完了/失敗/削除/永続化/EXP 付与) を実施し、既存 MOD と共存できることを確認。
