# メモ帳ユーティリティの設計

MiniExp MOD のユーティリティカテゴリに、Windows 11 メモ帳風のテキストエディタを追加する設計。スクリーンショット準拠のレイアウトを持ち、基本的なファイル操作と XP 付与ロジックを実装する。

- ID: `notepad`
- 表示名: メモ帳
- エントリ: `games/notepad.js`
- バージョン: 0.1.0
- カテゴリ: ユーティリティ
- 目的: 素早いメモ書き・テキスト閲覧用ツール。編集や保存操作でプレイヤーに小量の EXP を付与する。

## 画面レイアウト
1. **ウィンドウシェル**: 角丸のカード。上部にアプリアイコンとタブ（今回は単一タブ固定）を並べ、背景色/影は既存ユーティリティと調和するダーク寄りのニュートラルグレーを使用。
2. **タイトルバー**: 左にメモ帳アイコン（SVG）、中央にファイル名、右に最小化/最大化/閉じる風のボタン（押下で視覚効果のみ）。タブ領域は将来複数文書対応を想定し、現状はダミーの `+` ボタンを配置。
3. **メニューバー**: `ファイル / 編集 / 表示` の 3 メニューを横並び。メニューを押すとポップアップパネルが開き、主要コマンドを操作できる。
4. **コマンドバー**: スクリーンショットの書式ツール群（H1, 箇条書き, B, I, 下線, ハイライト, 文字色/背景色 等）に対応するアイコンボタンを配置。ノートはプレーンテキストだが、テーマ切替／折り返し等の設定を集約する。見た目は反映するが、テキストは `textarea` で管理するため装飾は UI のみ。
5. **編集エリア**: `textarea` (等幅でなく、Notepad に近い Segoe UI / 14px) を全面に配置。行番号は表示しない。フォーカス時にハイライト。
6. **ステータスバー**: 下部に `行 X, 列 Y | Z 文字 | テキスト | 100% | Windows (CRLF) | UTF-8` 形式を表示。Zoom 値や行/列はリアルタイムで更新。ステータスバーは表示設定で ON/OFF 切替可。

## 状態管理
- `state = { fileName, text, savedText, isDirty, zoom, wordWrap, showStatusBar, lineEnding, encoding, lastChangeAwardAt }` をローカルで保持。
- `persisted = localStorage['mini_notepad_state_v1']` に保存し、`fileName`, `text`, `zoom`, `wordWrap`, `showStatusBar` を復元。保存時に更新。
- `isDirty` は `text !== savedText` で算出。タイトルバーに `*` を付与。
- `lineEnding` は初期入力から推定（`\r\n` / `\n` / `\r`）。保存前に選択できる UI を準備（デフォルト Windows (CRLF)）。

## ファイル操作
- **新規 (Ctrl+N)**: 未保存変更がある場合は確認ダイアログを表示。状態を初期化しタイトルは `タイトルなし.txt` に戻す。
- **開く (Ctrl+O)**: `input[type=file]` でローカルテキストを読み込む。選択した文字コードは `FileReader` の UTF-8 想定。読み込み後、`state.savedText = state.text = 読込結果` として dirty リセットし、ファイル名を選択ファイル名に更新。読み込み完了時に `updateStatusBar()` 呼び出し。
- **上書き保存 (Ctrl+S)**: 現在の `state.text` を Blob でダウンロード。既にファイル名がある場合そのまま、`タイトルなし.txt` の場合は命名ダイアログ（プロンプト）を表示。
- **名前を付けて保存 (Ctrl+Shift+S)**: 常にファイル名入力プロンプトを出して保存。
- Windows 標準の「ページ設定」「印刷」は UI のみ提供（クリックで Coming Soon トースト）とする。

## 編集・表示機能
- **編集メニュー**: Undo, Redo, Cut, Copy, Paste, Delete, Select All を `document.execCommand` で呼び出し。Find / Replace は簡易モーダルを実装し、現在のテキストで一致箇所にスクロール。
- **表示メニュー**: `ズームイン/アウト/リセット`（フォントサイズを 2px 刻みで調整）、`折り返しの切り替え`、`ステータスバー切り替え`。状態は `state.zoom`, `state.wordWrap`, `state.showStatusBar` を更新。
- **ツールバーアイコン**: Word wrap, Zoom, 行番号表示 (非対応) などをまとめ、押下で対応設定をトグル。視覚的にはスクリーンショットを再現し、押下時にはボタンが強調。
- **ショートカット**: `Ctrl+N/O/S/Shift+S`, `Ctrl+F/H`, `Ctrl+P`, `Ctrl+Z/Y`, `Ctrl+Shift+P` (Word wrap) をバインド。`keydown` リスナーは `start()` で追加し `stop()` で解除。

## EXP 仕様
- ミニゲーム起動時（`create` 完了直後）に `awardXp(5, { type: 'open' })`。
- テキストが変更されるたび `awardXp(1, { type: 'edit' })`。無限稼ぎを防ぐため、連続入力は 750ms に 1 回まで（デバウンス）。削除も含む。
- ダウンロード保存成功時 `awardXp(5, { type: 'save' })`。
- 1 回の操作で複数イベントが起きても UI 側で集約（例: 「名前を付けて保存」でテキスト未変更の場合は `save` 付与のみ）。

## API 実装方針
- `create(root, awardXp, opts)`:
  - DOM を構築し、`root` に追加。
  - `state` を初期化、ローカルストレージから復元。
  - 必要な内部関数: `updateTitleBar()`, `updateStatusBar()`, `setText(value, options)`, `markSaved()`, `promptFileName(defaultName)`。
  - XP 付与ヘルパ `award(action, amount)` でデバウンス制御。
  - `return { start, stop, destroy, getScore }`。`getScore` はセッション中に獲得した XP を返却（MiniExp 統計用）。
- `start()` でイベントリスナー（ショートカット、textarea input、selectionchange）を登録。`stop()` で解除。`destroy()` で DOM を除去しローカルストレージへ保存。

## データ永続化
- `localStorage` には `text`, `fileName`, `zoom`, `wordWrap`, `showStatusBar`, `lastOpenedAt` を保存。
- 保存時に 1KB を超える場合も想定し、例外は握りつぶす（既存ユーティリティ準拠）。

## 互換性・ガード
- ファイル読み込みは UTF-8/BOM を想定。失敗時はアラートを表示し `state` は変更しない。
- `textarea` のサイズ変更は CSS で抑制し、`pointer-events` なしの UI ボタンはフォーカスインジケータを保持。
- モバイルからの利用も想定し、600px 未満の場合にタイトルバーやコマンドバーが 2 段組になるよう Flex 設定。

## 実装手順（コード側）
1. `games/notepad.js` を新規作成し、設計に沿った UI/ロジックを実装、`window.registerMiniGame({ id:'notepad', ... })` を呼ぶ。
2. `games/manifest.json.js` にメモ帳エントリを追加（カテゴリ: ユーティリティ、説明文は XP 条件を明記）。
3. 既存 CSS へは依存しないようインライン style を使用。必要に応じ `window.showTransientPopupAt` など HUD API を活用。
4. 動作確認（編集・保存・開く・XP 付与デバグ）を行い、既存ユーティリティと競合しないことを確認。

