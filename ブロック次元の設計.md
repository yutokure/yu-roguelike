# ãƒ–ãƒ­ãƒƒã‚¯æ¬¡å…ƒã®è¨­è¨ˆ

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€é¸æŠç”»é¢ã«ã€Œãƒ–ãƒ­ãƒƒã‚¯æ¬¡å…ƒã€ãƒ¢ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã€æ¬¡å…ƒ(a..z)ã¨3ã¤ã®ãƒ–ãƒ­ãƒƒã‚¯(1st/2nd/3rd)ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ä»•æ§˜ã‚’åˆæˆã™ã‚‹æ©Ÿèƒ½ã®è©³ç´°è¨­è¨ˆã§ã™ã€‚UI/ãƒ‡ãƒ¼ã‚¿/ç”Ÿæˆ/æ°¸ç¶šåŒ–ã®å¤‰æ›´ç‚¹ã€æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã€å°å…¥æ‰‹é †ã€æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å·®åˆ†ã‚’å…·ä½“åŒ–ã—ã¾ã™ã€‚

## ç›®çš„ / è¦ä»¶
- ç›®çš„: é€šå¸¸ãƒ¯ãƒ¼ãƒ«ãƒ‰ã¨ã¯åˆ¥ç³»çµ±ã®å¤šæ§˜ãªç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒçµ„ã¿åˆã‚ã›å¯èƒ½ã«ã™ã‚‹
- äº’æ›: æ—¢å­˜ã®é€šå¸¸ãƒ¯ãƒ¼ãƒ«ãƒ‰é¸æŠã¨ä½µå­˜ï¼ˆå‰Šé™¤ãªã—ï¼‰ã€‚æ—¢å­˜ã®é›£æ˜“åº¦ãƒ»UIãƒ»æ°¸ç¶šåŒ–ã¯ç¶­æŒ
- ä¾µè¥²åº¦: `main.js` ã®ç”Ÿæˆãƒ»UIãƒ»æ°¸ç¶šåŒ–ã«æœ€å°é™ã®åˆ†å²ã‚’è¿½åŠ ã™ã‚‹æ–¹é‡
- å†ç¾æ€§: æ¬¡å…ƒ/ãƒ–ãƒ­ãƒƒã‚¯é¸æŠã‹ã‚‰åŒä¸€ã‚·ãƒ¼ãƒ‰ã‚’å°å‡ºå¯èƒ½ã«ï¼ˆåŒé¸æŠâ†’åŒç”Ÿæˆï¼‰

## ç”¨èª
- æ¬¡å…ƒ(Dimension): a..zï¼ˆå„100åˆ»ã¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã‚’æŒã¤ï¼‰
- ãƒ–ãƒ­ãƒƒã‚¯(Block): 1st/2nd/3rd å„100ç¨®ï¼ˆãƒ¬ãƒ™ãƒ«è£œæ­£/ã‚µã‚¤ã‚ºä¿‚æ•°/æ·±ã•/å®ç®±ãƒã‚¤ã‚¢ã‚¹/ã‚¿ã‚¤ãƒ—å„ªå…ˆ/ãƒœã‚¹éšå±¤ï¼‰
- åˆæˆ(Compose): æ¬¡å…ƒã¨3ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ãƒ©ãƒ³ç”Ÿæˆç”¨Specã‚’å°å‡ºã™ã‚‹å‡¦ç†

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### å‹ï¼ˆæ“¬ä¼¼TSï¼‰
```ts
type ChestBias = 'less' | 'normal' | 'more';
type GenType = 'field'|'cave'|'narrow-maze'|'wide-maze'|'rooms'|'single-room'|'circle'|'snake'|'grid'|'open-space'|'mixed'|'circle-rooms'; // grid/open-space ã¯æ··åˆå‹ã®ã¿å‡ºç¾

type Dimension = { key: string; name: string; baseLevel: number }; // a..z
type Block = {
  key: string;
  level?: number;   // æ¨å¥¨Lvè£œæ­£ï¼ˆÂ±ï¼‰
  size?: number;    // ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºä¿‚æ•°ï¼ˆ-2..+2 ç›®å®‰ï¼‰
  depth?: number;   // æ·±ã•è£œæ­£ï¼ˆÂ±ï¼‰
  chest?: ChestBias;// å®ç®±é‡ãƒã‚¤ã‚¢ã‚¹
  type?: GenType | null; // ã‚¿ã‚¤ãƒ—å„ªå…ˆï¼ˆå¾Œå‹ã¡ï¼‰
  bossFloors?: number[]; // ç‰¹å®šãƒ•ãƒ­ã‚¢ã§ãƒœã‚¹
};

type ComposedSpec = {
  level: number;        // æ¨å¥¨Lv
  sizeFactor: number;   // -2..+2 ç¨‹åº¦
  depth: number;        // 1..15ï¼ˆä¸Šé™ï¼‰
  chestBias: ChestBias; // less/normal/more
  type: GenType;        // ç”Ÿæˆã‚¿ã‚¤ãƒ—ï¼ˆBlockDimã§ã¯å¸¸ã« 'mixed'ï¼‰
  typePool?: GenType[]; // æ··åˆå¯¾è±¡ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ãŒæŒ‡ç¤ºã—ãŸã‚¿ã‚¤ãƒ—ã®ã¿ï¼‰
  bossFloors: number[]; // å‡ºç¾éš
};

type BlockDimState = {
  enabled: boolean;
  nested?: number; // NESTEDæ¬¡å…ƒï¼ˆ1..99,999,999ï¼‰
  dimKey?: string;
  b1Key?: string;
  b2Key?: string;
  b3Key?: string;
  spec?: ComposedSpec;
  seed?: number; // é¸æŠçµ„ã¿åˆã‚ã›ã«ç´ã¥ã32bitã‚·ãƒ¼ãƒ‰
};

type BlockDimHistoryEntry = {
  key: string;
  nested: number;
  dim: string;
  b1: string;
  b2: string;
  b3: string;
  level: number;
  depth: number;
  type: string;
  seed: number;
};
```

### ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–ä¾‹ï¼ˆã‚µãƒ³ãƒ—ãƒ«æœ€å°ï¼‰
```js
const dimensions = [
  { key:'a', name:'Aether', baseLevel:1 },
  { key:'b', name:'Basalt', baseLevel:101 },
  // ... z ã¾ã§ 100åˆ»ã¿
];

const blocks1 = [
  { key:'verdant',  level:+10, size: 0, depth:+2, chest:'normal', type:null,           bossFloors:[10] },
  { key:'compact',  level:  0, size:-1, depth:-1, chest:'less',   type:'rooms',        bossFloors:[]   },
];
const blocks2 = [
  { key:'cryptic',  level:+25, size:+1, depth: 0, chest:'more',   type:'cave',         bossFloors:[]   },
  { key:'serpents', level:+15, size: 0, depth:+1, chest:'normal', type:'snake',        bossFloors:[5]  },
];
const blocks3 = [
  { key:'labyrinth',level:  0, size: 0, depth:+3, chest:'more',   type:'narrow-maze',  bossFloors:[5,10,15] },
  { key:'ringed',   level:  0, size:+1, depth: 0, chest:'less',   type:'circle-rooms', bossFloors:[]       },
];
```

### ãƒ‡ãƒ¼ã‚¿èª­è¾¼

- æ—¢å®šã§ã¯ `blockdata.json` ã‚’ `fetch` ã§å–å¾—ã—ã€`dimensions/blocks1/blocks2/blocks3` ã‚’åˆæœŸåŒ–ã€‚
- `file://` ç’°å¢ƒã‚„å¤±æ•—æ™‚ã¯ `blockdata.js`ï¼ˆ`window.__BLOCKDATA` ã‚’å…¬é–‹ï¼‰ã‚’ `<script>` ã§èª­ã¿è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
- ã„ãšã‚Œã‚‚èª­ã¿è¾¼ã¿å¾Œã« `blockDimTables.__loaded = true` ã¨ã—ã€å¾…æ©Ÿä¸­ã®åˆæœŸåŒ–å‡¦ç† (`flushPendingDungeonBlocks`) ã‚’è§£æ”¾ã€‚

## åˆæˆãƒ­ã‚¸ãƒƒã‚¯

### è£œåŠ©é–¢æ•°ï¼ˆæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰
```js
function clamp(min, max, v) { return Math.max(min, Math.min(max, v)); }
function majority(arr /* ['less','more','normal'] */) {
  const cnt = { less:0, normal:0, more:0 };
  for (const v of arr) if (v) cnt[v]++;
  // åŒæ•°ã®ã¨ã normal å„ªå…ˆ â†’ more â†’ less ã®é †
  if (cnt.normal >= cnt.more && cnt.normal >= cnt.less) return 'normal';
  if (cnt.more   >= cnt.less) return 'more';
  return 'less';
}
function pickPriority(arr /* [t3,t2,t1] */) {
  for (const t of arr) if (t) return t; // å¾Œæ®µå„ªå…ˆï¼ˆ3rdâ†’2ndâ†’1stï¼‰
  return null;
}
function unionNormalize(listOfLists) {
  const s = new Set();
  for (const lst of listOfLists) for (const x of (lst||[])) s.add(x);
  return Array.from(s).sort((a,b)=>a-b);
}
```

### åˆæˆæœ¬ä½“ï¼ˆæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰
```js
function composeSpec(dim, b1, b2, b3, nested = 1) {
  const base = dim.baseLevel;
  const nestedOffset = 2600 * Math.max(0, (nested|0) - 1);
  const level = base + (b1.level||0) + (b2.level||0) + (b3.level||0) + nestedOffset;
  const sizeFactor = (b1.size||0) + (b2.size||0) + (b3.size||0);   // -2..+2 ç›®å®‰
  const depth = clamp(1, 15, 1 + (b1.depth||0) + (b2.depth||0) + (b3.depth||0));
  const chestBias = majority([b1.chest, b2.chest, b3.chest]);
  // æ–°ä»•æ§˜: ã‚¿ã‚¤ãƒ—ã¯3ãƒ–ãƒ­ãƒƒã‚¯ã® type ã®å’Œé›†åˆã®ã¿ã‹ã‚‰æ¯éšå±¤ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆ=æ··åˆï¼‰
  const pool = [b1.type, b2.type, b3.type].filter(Boolean);
  const typePool = Array.from(new Set(pool));
  const type = 'mixed';
  const bossFloors = unionNormalize([b1.bossFloors, b2.bossFloors, b3.bossFloors]);
  return { level, sizeFactor, depth, chestBias, type, typePool, bossFloors };
}
```

### ã‚·ãƒ¼ãƒ‰å°å‡ºï¼ˆå†ç¾æ€§ï¼‰
```js
function seedFromSelection(dimKey, b1Key, b2Key, b3Key) {
  const str = `${dimKey}|${b1Key}|${b2Key}|${b3Key}`;
  // 32bit ãƒãƒƒã‚·ãƒ¥ï¼ˆä¾‹: xfnv1aï¼‰â†’ Mulberry32 ãªã©ã«æŠ•å…¥
  return hash32(str);
}
```
â€» æ—¢å®šã§ã¯ NESTED ã¯ã‚·ãƒ¼ãƒ‰ã«å«ã‚ãªã„ï¼ˆåŒä¸€é¸æŠ+NESTEDå·®åˆ†ã§â€œåŒæ§‹é€ ãƒ»åˆ¥é›£æ˜“åº¦â€ã‚’å®Ÿç¾ï¼‰ã€‚

### å±¥æ­´/ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
- ã‚­ãƒ¼ `bdimKey` ã¯ `nested|dimKey|b1|b2|b3` ã¨ã—ã¦ NESTED ã‚’å«ã‚ã¦åŒºåˆ¥ã™ã‚‹ã€‚
- è¡¨ç¤ºã«ã¯ `NESTED n` ã‚’å«ã‚ã‚‹ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/ãƒ¢ãƒ¼ãƒ€ãƒ«/å±¥æ­´ï¼‰ã€‚

## UI ä»•æ§˜

### ç”»é¢æ§‹æˆï¼ˆé¸æŠç”»é¢ã‚¿ãƒ–è¿½åŠ ï¼‰
- ã‚¿ãƒ–: `Normal` / `BlockDim`ï¼ˆID: `tab-normal`, `tab-blockdim`ï¼‰
- `BlockDim`ã‚¿ãƒ–å†…ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¸»è¦IDï¼‰
  - `bdim-nested`: NESTEDæ¬¡å…ƒï¼ˆmin=1, max=99,999,999ï¼‰ã€‚
  - `bdim-list-dimension`, `bdim-list-1st`, `bdim-list-2nd`, `bdim-list-3rd`: ã‚«ã‚¹ã‚¿ãƒ listboxã€‚`bdim-option` ã‚¯ãƒ©ã‚¹ã§é¸æŠå¼·èª¿ã€‚
  - è©³ç´°ã‚«ãƒ¼ãƒ‰ï¼ˆæ´¾ç”Ÿç‰¹æ€§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰: `bdim-card-selection`, `bdim-card-level`, `bdim-card-type`, `bdim-card-depth`, `bdim-card-size`, `bdim-card-chest`, `bdim-card-boss`ã€‚
  - æ“ä½œãƒœã‚¿ãƒ³: `bdim-start-button`ï¼ˆGateå…¥å ´ï¼‰ã€`bdim-add-bookmark`ã€`bdim-clear-history`ã€`bdim-random-button`ã€`bdim-weighted-random-button`ã€‚
  - è¿½åŠ å…¥åŠ›: `bdim-random-target`ï¼ˆåˆè¨ˆLvç›®æ¨™ï¼‰ã€`bdim-random-type`ï¼ˆã‚¿ã‚¤ãƒ—å„ªå…ˆï¼‰ã€‚
  - è¡¨ç¤ºé ˜åŸŸ: `bdim-history`ï¼ˆæœ€æ–°200ä»¶ï¼‰ã€`bdim-bookmarks`ï¼ˆæœ€å¤§100ä»¶ï¼‰ã€‚

### ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰
```js
async function initBlockDimUI(){
  await loadBlockDataOnce();
  renderBdimLists();
  renderHistoryAndBookmarks();
  const initialNested = clamp(1, 99999999, (loadState()?.blockDim?.nested|0) || 1);
  bdimNestedInput.value = initialNested;
  updateFromSelection();
}

function updateFromSelection(){
  if (!blockDimTables.__loaded) return;
  const nested = clamp(1, 99999999, parseInt(bdimNestedInput.value)||1);
  const dim = findSelected(blockDimTables.dimensions, bdimDimList);
  const b1  = findSelected(blockDimTables.blocks1, bdim1List);
  const b2  = findSelected(blockDimTables.blocks2, bdim2List);
  const b3  = findSelected(blockDimTables.blocks3, bdim3List);
  const spec = composeSpec(dim, b1, b2, b3, nested);
  const seed = seedFromSelection(dim.key, b1.key, b2.key, b3.key);
  blockDimState = { enabled: true, nested, dimKey: dim.key, b1Key: b1.key, b2Key: b2.key, b3Key: b3.key, spec, seed };
  renderBdimPreview(spec);
  bdimStartBtn.disabled = !spec;
}

bdimStartBtn.addEventListener('click', () => {
  if (!blockDimState?.spec) return;
  currentMode = 'blockdim';
  startGameInBlockDimMode();
});
```

## ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¥ç¶š

### ã‚µã‚¤ã‚º/ã‚¿ã‚¤ãƒ—/æ·±ã•/å®ç®±/ãƒœã‚¹ã®åæ˜ 
```js
// main.js:73 ä»˜è¿‘ updateMapSize ã®æ‹¡å¼µ
function updateMapSize() {
  const base = 15 + dungeonLevel * 5;
  const sizeAdj = (blockDimState.enabled ? (blockDimState.spec.sizeFactor||0) : 0);
  // ä¿‚æ•°â†’ã‚¿ã‚¤ãƒ«æ•°ã¸ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆ1æ®µéš=Â±2 ã‚¿ã‚¤ãƒ«ç¨‹åº¦ï¼‰
  const delta = sizeAdj * 2;
  MAP_WIDTH  = Math.max(15, base + delta);
  MAP_HEIGHT = Math.max(15, base + delta);
}

// main.js:196 ä»˜è¿‘ generateMap ã®ã‚¿ã‚¤ãƒ—æ±ºå®š
// BlockDim ã§ã¯ type ã¯ 'mixed' å›ºå®šã€‚generateMixedType å†…ã§ spec.typePool ã‚’å„ªå…ˆåˆ©ç”¨
const dungeonData = blockDimState.enabled ? { type:blockDimState.spec.type } : dungeonInfo[selectedDungeonBase];

// main.js:generateEntities ã§å®ç®±ã‚¹ã‚±ãƒ¼ãƒ«
const chestBase = (MAP_WIDTH + MAP_HEIGHT) / 15;
const chestMul = !blockDimState.enabled ? 1.0 : (blockDimState.spec.chestBias==='less'?0.7: blockDimState.spec.chestBias==='more'?1.3:1.0);
const chestCount = Math.round(chestBase * chestMul);

// ãƒ•ãƒ­ã‚¢æ·±ã•ã¨ãƒœã‚¹åˆ¤å®šï¼ˆ10F/25Fè¦å®šã«å„ªå…ˆï¼‰
function isBossFloor(level) {
  if (blockDimState.enabled) {
    return blockDimState.spec.bossFloors.includes(level);
  }
  // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  return (selectedWorld==='X' ? level===25 : level===10);
}
```

### æ¨å¥¨ãƒ¬ãƒ™ãƒ«/è©³ç´°ã‚«ãƒ¼ãƒ‰
```js
function recommendedLevelForSelection() {
  if (blockDimState.enabled) return blockDimState.spec.level; // NESTEDã‚ªãƒ•ã‚»ãƒƒãƒˆè¾¼ã¿
  // æ—¢å­˜ã® world/dungeon ãƒ™ãƒ¼ã‚¹ã®è¨ˆç®—
}
```

### RNGã‚·ãƒ¼ãƒ‰å›ºå®š
```js
function reseedBlockDimForFloor() {
  if (currentMode !== 'blockdim' || !blockDimState?.spec) return;
  const baseSeed = blockDimState.seed ?? seedFromSelection(blockDimState.dimKey, blockDimState.b1Key, blockDimState.b2Key, blockDimState.b3Key);
  blockDimState.seed = baseSeed;
  const floorSeed = mixSeed(baseSeed, dungeonLevel);
  setSeededRandom(floorSeed);
}
```

## æ°¸ç¶šåŒ– / ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### ä¿å­˜é …ç›®ã®è¿½åŠ 
- è¿½åŠ : `blockDimState`ï¼ˆ`enabled`, `nested`, `dimKey`, `b1Key`, `b2Key`, `b3Key`, `spec`, `seed`ï¼‰
- è¿½åŠ : `blockDimHistory`, `blockDimBookmarks`ï¼ˆé…åˆ—ï¼‰
- äº’æ›: æ—¢å­˜ã‚­ãƒ¼ã¯ç¶­æŒã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯åŒä¸€ã§ã‚‚å¯ï¼ˆæœªè¨­å®šæ™‚ã¯ `enabled:false` ï¼‰

```js
localStorage.setItem('roguelike_save_v1', JSON.stringify({
  // æ—¢å­˜ ...
  blockDim: blockDimState?.enabled ? {
    enabled: true,
    nested: blockDimState.nested || 1,
    dimKey: blockDimState.dimKey,
    b1Key: blockDimState.b1Key,
    b2Key: blockDimState.b2Key,
    b3Key: blockDimState.b3Key,
    spec: blockDimState.spec,
    seed: blockDimState.seed
  } : { enabled:false },
  blockDimHistory,
  blockDimBookmarks
}));

// èª­è¾¼æ™‚: enabled:true ãªã‚‰ state ã¨ history/bookmarks ã‚’å¾©å…ƒã€‚æœªå®šç¾©ãªã‚‰æ—¢å®šå€¤ã€‚
```

## ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- JSONã« `blockDim` / `blockDimHistory` / `blockDimBookmarks` ã‚’å«ã‚ã‚‹ã€‚å­˜åœ¨ã—ãªã„ãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–/æ—¢å®š

## ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- æ·±ã•: `1 <= depth <= 15`
- ã‚µã‚¤ã‚º: `sizeFactor âˆˆ [-2..+2]`ï¼ˆè¶Šãˆã¯ä¸¸ã‚ï¼‰
- ãƒœã‚¹éš: `1..depth` ã®ã¿æ¡ç”¨
- æ¨å¥¨Lv: `>=1`

## ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªï¼ˆé–‹ç™ºæ™‚ãƒ­ã‚°ï¼‰
- åˆæˆSpecã¨æ´¾ç”Ÿ: `{level, sizeFactor, depth, chestBias, type, bossFloors}` ã‚’é¸æŠæ™‚ã«log
- ç”Ÿæˆå¾Œ: é€£çµæˆåˆ†æ•°/è¢‹å°è·¯æ•°/ãƒ«ãƒ¼ãƒ—æ¨å®šã‚’ç°¡æ˜“é›†è¨ˆï¼ˆæ—¢å­˜ã®ensureConnectivityå¾Œï¼‰

## UIè©³ç´°ï¼ˆHTML è¿½åŠ æ¡ˆï¼‰

```html
<!-- index.html: BlockDim ã‚¿ãƒ–ï¼ˆå®Ÿè£…æ¸ˆã¿æ§‹é€ ï¼‰ -->
<div id="tab-blockdim" class="tab-content" role="tabpanel">
  <div class="row">
    <div class="bdim-field">
      <label for="bdim-nested">NESTEDæ¬¡å…ƒ</label>
      <input id="bdim-nested" type="number" min="1" max="99999999" step="1" value="1" />
    </div>
  </div>
  <div class="row">
    <div class="bdim-grid">
      <div class="bdim-field"><label>æ¬¡å…ƒ</label><div id="bdim-list-dimension" class="bdim-list" role="listbox"></div></div>
      <div class="bdim-field"><label>1st</label><div id="bdim-list-1st" class="bdim-list" role="listbox"></div></div>
      <div class="bdim-field"><label>2nd</label><div id="bdim-list-2nd" class="bdim-list" role="listbox"></div></div>
      <div class="bdim-field"><label>3rd</label><div id="bdim-list-3rd" class="bdim-list" role="listbox"></div></div>
    </div>
  </div>
  <div class="row">
    <div id="bdim-card" class="bdim-card">
      <h3>åˆæˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <div class="bdim-card-row"><span class="label">é¸æŠ</span><span id="bdim-card-selection">-</span></div>
      <div class="bdim-card-row"><span class="label">æ¨å¥¨Lv</span><span id="bdim-card-level">-</span></div>
      <div class="bdim-card-row"><span class="label">ã‚¿ã‚¤ãƒ—</span><span id="bdim-card-type">-</span></div>
      <div class="bdim-card-row"><span class="label">æ·±ã•</span><span id="bdim-card-depth">-</span></div>
      <div class="bdim-card-row"><span class="label">ã‚µã‚¤ã‚º</span><span id="bdim-card-size">-</span></div>
      <div class="bdim-card-row"><span class="label">å®ç®±</span><span id="bdim-card-chest">-</span></div>
      <div class="bdim-card-row"><span class="label">ãƒœã‚¹éš</span><span id="bdim-card-boss">-</span></div>
      <small class="bdim-note">åŒä¸€é¸æŠã¯åŒä¸€ç”Ÿæˆï¼ˆå›ºå®šã‚·ãƒ¼ãƒ‰ï¼‰</small>
      <div class="bdim-actions">
        <button id="bdim-start-button" class="start-btn" disabled>Gate</button>
        <button id="bdim-add-bookmark">â˜… ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯è¿½åŠ </button>
        <button id="bdim-clear-history">å±¥æ­´ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="bdim-actions">
        <button id="bdim-random-button">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆ1st/2nd/3rdï¼‰</button>
      </div>
      <div class="bdim-actions">
        <label for="bdim-random-target">ç›®æ¨™Lv(ãƒ–ãƒ­ãƒƒã‚¯åˆè¨ˆ)</label>
        <input id="bdim-random-target" type="number" min="-10" max="102" step="1" value="0" />
        <label for="bdim-random-type">ã‚¿ã‚¤ãƒ—å„ªå…ˆ</label>
        <select id="bdim-random-type">
          <option value="">æŒ‡å®šãªã—</option>
          <!-- typeå€™è£œï¼ˆfield/cave/...ï¼‰ -->
        </select>
        <button id="bdim-weighted-random-button">ğŸ¯ é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ </button>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="bdim-card" id="bdim-history-card"><h3>Gateå±¥æ­´</h3><div id="bdim-history"></div></div>
  </div>
  <div class="row">
    <div class="bdim-card" id="bdim-bookmarks-card"><h3>ãƒ–ãƒ­ãƒƒã‚¯ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</h3><div id="bdim-bookmarks"></div></div>
  </div>
</div>
```

### ãƒ©ãƒ³ãƒ€ãƒ é¸æŠãƒ»å±¥æ­´/ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯

- `#bdim-random-button`: 1st/2nd/3rd ã‚’å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠï¼ˆç¾åœ¨ã®æ¬¡å…ƒã¯ç¶­æŒï¼‰ã€‚
- `#bdim-weighted-random-button`: å…¥åŠ›ã•ã‚ŒãŸç›®æ¨™Lv/ã‚¿ã‚¤ãƒ—å„ªå…ˆã«æ²¿ã£ã¦é‡ã¿ä»˜ãæŠ½é¸ã€‚
- `#bdim-history`: Gateçªå…¥æ™‚ã«æœ€æ–°200ä»¶ã¾ã§ã‚¹ã‚¿ãƒƒã‚¯ã€‚å„ã‚¨ãƒ³ãƒˆãƒªã¯ `BlockDimHistoryEntry` ã‚’ä¿æŒã—ã€å‰Šé™¤ãƒœã‚¿ãƒ³ã§å€‹åˆ¥å‰Šé™¤ã€‚
- `#bdim-bookmarks`: ä»»æ„ã®çµ„ã¿åˆã‚ã›ã‚’ä¿å­˜ï¼ˆæœ€å¤§100ä»¶ï¼‰ã€‚ä¸€è¦§ã‹ã‚‰ Gate ãƒœã‚¿ãƒ³ã§å³é¸æŠã«å¾©å…ƒã€‚
- å±¥æ­´/ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã¯ UI æ›´æ–°å¾Œã« `saveAll()` ã¸å³æ™‚åæ˜ ã€‚

## å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè©³ç´°ï¼‰
1) ãƒ‡ãƒ¼ã‚¿/çŠ¶æ…‹
  - `dimensions`, `blocks1/2/3`, è£œåŠ©é–¢æ•°ã€`composeSpec` ã‚’ `main.js` æœ«å°¾ä»˜è¿‘ã¸è¿½åŠ 
  - `blockDimState` ã‚°ãƒ­ãƒ¼ãƒãƒ«è¿½åŠ ï¼ˆæ—¢å®š `enabled:false`ï¼‰
2) UI
  - ã‚¿ãƒ–/listbox/ã‚«ãƒ¼ãƒ‰/ãƒ©ãƒ³ãƒ€ãƒ ãƒ»å±¥æ­´ãƒœã‚¿ãƒ³ã®HTMLã‚’è¿½åŠ 
  - åˆæœŸåŒ–`initBlockDimUI`ã¨ã‚¤ãƒ™ãƒ³ãƒˆ`renderBdimLists/updateFromSelection/renderHistoryAndBookmarks`ã‚’è¿½åŠ 
3) ç”Ÿæˆ
  - `updateMapSize()` ã« sizeFactor åæ˜ ï¼ˆ`main.js:73`ï¼‰
  - `generateMap()` ã®ã‚¿ã‚¤ãƒ—æ±ºå®šã« `spec.type` ã‚’ä½¿ç”¨ï¼ˆ`main.js:196`ï¼‰
  - `generateEntities()` ã§å®ç®±æ•°ã®ãƒã‚¤ã‚¢ã‚¹åæ˜ ã€ãƒœã‚¹éšå±¤ã®åˆ¤å®šçµ±ä¸€
  - RNGã‚’ `reseedBlockDimForFloor()` ã§ãƒ•ãƒ­ã‚¢ã”ã¨ã«å†ã‚·ãƒ¼ãƒ‰
4) æ°¸ç¶šåŒ–
  - `saveAll()`/å¾©å…ƒã« `blockDimState` ã‚’è¿½åŠ ï¼ˆ`main.js:155`ï¼‰
5) è¡¨ç¤º
  - æ¨å¥¨Lvã‚«ãƒ¼ãƒ‰ã®è¨ˆç®—ã§ `recommendedLevelForSelection()` ã‚’ãƒ–ãƒ­ãƒƒã‚¯æ¬¡å…ƒå¯¾å¿œ
6) QA
  - æ·±ã•å¢ƒç•Œ/ã‚µã‚¤ã‚ºæœ€å°å€¤/ãƒœã‚¹éšå±¤ã®æ¡ä»¶ã‚’å˜ä½“ã§æ¤œè¨¼ã€æ—¢å­˜ã®é€£çµ/é…ç½®ä¸å¤‰æ¡ä»¶ã‚‚å›ã™

## æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒƒã‚¯ã¾ã¨ã‚ï¼‰
```js
// ãƒ©ãƒ³é–‹å§‹ãƒ•ãƒ­ãƒ¼ï¼ˆBlockDimï¼‰
function startGameInBlockDimMode() {
  currentMode = 'blockdim';
  blockDimState.enabled = true;
  reseedBlockDimForFloor();
  dungeonLevel = 1;
  updateMapSize();
  generateMap();
  generateEntities();
  // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†ã¸
}

function renderPreviewCard(spec) {
  if (!spec) return;
  setText('bdim-card-level', spec.level);
  setText('bdim-card-type', spec.type==='mixed' && spec.typePool?.length
    ? `æ··åˆå‹ï¼ˆ${spec.typePool.join('ï¼‹')}ï¼‰`
    : spec.type);
  setText('bdim-card-depth', spec.depth);
  setText('bdim-card-size', spec.sizeFactor);
  setText('bdim-card-chest', spec.chestBias);
  setText('bdim-card-boss', spec.bossFloors.join(','));
}
```

## æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å·®åˆ†ï¼ˆå®Ÿè£…æ™‚ã®ç·¨é›†ãƒã‚¤ãƒ³ãƒˆï¼‰

- è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰
  - `main.js` æœ«å°¾: `dimensions/blocks1/blocks2/blocks3` ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»è£œåŠ©é–¢æ•°ãƒ»`composeSpec`ãƒ»`blockDimState`ãƒ»RNGãƒªã‚·ãƒ¼ãƒ‰
  - `main.js` UIåˆæœŸåŒ–: `initBlockDimUI/renderBdimLists/renderBdimPreview/renderHistoryAndBookmarks` ã¨ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  - `index.html` é¸æŠç”»é¢ã« BlockDim ã‚¿ãƒ–ç¾¤ï¼ˆå‰ç¯€HTMLï¼‰

- å¤‰æ›´ã™ã‚‹ã‚³ãƒ¼ãƒ‰
  - `main.js:73` `updateMapSize()` ã« `sizeFactor` åæ˜ 
  - `main.js:196` `generateMap()` ã®ã‚¿ã‚¤ãƒ—æ±ºå®šã§ `blockDimState.spec.type` ã‚’å„ªå…ˆ
  - `main.js:... generateEntities()` å†…ã§å®ç®±æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã¨ãƒœã‚¹éšå±¤åˆ¤å®š
  - `main.js:155` `saveAll()` ã¨èª­è¾¼å´ã« `blockDimState` / `blockDimHistory` / `blockDimBookmarks` ã‚’è¿½åŠ 
  - æ¨å¥¨Lvè¨ˆç®—/ã‚«ãƒ¼ãƒ‰æ›´æ–°ï¼ˆé¸æŠç”»é¢ï¼‰ã‚’ `blockDimState` å¯¾å¿œ

- å‰Šé™¤ã™ã‚‹ã‚³ãƒ¼ãƒ‰
  - ãªã—ï¼ˆé€šå¸¸ãƒ¯ãƒ¼ãƒ«ãƒ‰é¸æŠã¯ç¶­æŒï¼‰ã€‚å°†æ¥ã€BlockDimå°å…¥å¾Œã«é‡è¤‡ä»•æ§˜ã‚’æ•´ç†ã™ã‚‹å ´åˆã¯ `dungeonInfo` ã®ä¸€éƒ¨ã‚’çµ±åˆå€™è£œã¨ã™ã‚‹

## éæ©Ÿèƒ½
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: åˆæˆè‡ªä½“ã¯è»½é‡ã€‚é¸æŠå¤‰æ›´æ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯åŒãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Œäº†
- å®‰å…¨åŸŸ: æ¥µç«¯ãª `sizeFactor/depth` ã¯ã‚¯ãƒ©ãƒ³ãƒ—ã—ã¦è¦–èªæ€§ã¨é€£çµæ€§ã‚’ç¶­æŒ

## ãƒªã‚¹ã‚¯/å¯¾å¿œ
- ãƒ–ãƒ­ãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«100Ã—3ã®æ‹¡å¼µ: åˆæœŸã¯10ã€œ20ä»¶ã§æ¤œè¨¼ã—ã€é †æ¬¡æ‹¡å¤§
- ç”Ÿæˆã‚¿ã‚¤ãƒ—ã®åã‚Š: `type`æœªè¨­å®šæ™‚ã¯'mixed'ã§å…¨ä½“ãƒãƒ©ãƒ³ã‚¹ç¶­æŒ

## ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
1. ã‚³ã‚¢åˆæˆ/UI/ãƒ•ãƒƒã‚¯ã®ã¿ï¼ˆé€šå¸¸ãƒ¯ãƒ¼ãƒ«ãƒ‰ä½µå­˜ï¼‰
2. ãƒ–ãƒ­ãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ®µéšæ‹¡å¼µã€ãƒœã‚¹éšå±¤/ãƒ†ãƒ¼ãƒæ€§ã‚’å……å®Ÿ
3. ä»¥å¾Œã€`ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ”¹å–„æ¡ˆ.md` ã®æ‰‹æ³•ï¼ˆA*æ˜å‰Š/Poisson/MST ç­‰ï¼‰ã¨é€£æº
