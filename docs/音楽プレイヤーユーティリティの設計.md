# 音楽プレイヤーユーティリティの設計

MiniExp MOD のユーティリティカテゴリに、ローカル音源を再生・管理できるモダンな音楽プレイヤーを追加する設計。プレイリスト管理、視覚化、イコライザー、永続化を備え、日常使いを想定した操作感を提供する。

- ID: `music_player`
- 表示名: ミュージックプレイヤー
- エントリ: `games/music_player.js`
- バージョン: 0.1.0
- カテゴリ: ユーティリティ
- 目的: BGM やローカル音源を手軽に再生しつつ、視覚的なフィードバックと EXP 獲得要素を提供する。

## 画面レイアウト
1. **ウィンドウシェル**: 角丸カードで幅 960px 程度、左右 2 カラム構成。左はプレイリストとコントロール、右は視覚化とイコライザー。背景はダーク寄りグラデーション。
2. **ヘッダー**: アプリアイコン、現在のトラック名、再生状態アイコン。右側にインポートボタンと設定ドロップダウン。
3. **プレイリストパネル**: ファイル追加ボタン、検索フィールド、並べ替え/一括操作ボタン、トラックリスト (各項目に名前・長さ・状態・操作ボタン)。最大 32 曲まで。
4. **コントロールバー**: 再生/一時停止、前後トラック、停止、ループ/シャッフル切り替え、音量・再生速度スライダー、現在時刻/残り時間表示、シークバー。
5. **視覚化エリア**: 上段にオシロスコープ (time-domain)、下段に周波数スペクトラムバー (frequency-domain)。両方ともキャンバス描画で FPS 60 を目標。
6. **イコライザーパネル**: 6 バンド (60Hz/170Hz/350Hz/1kHz/3.5kHz/10kHz) のスライダー、プリセット選択 (フラット/ロック/ボーカル/低音強調)。
7. **ステータスバー**: 現在のプレイリスト長、総再生時間、セッション EXP を表示。

## プレイリスト管理
- `input[type=file][multiple]` からローカル音源 (mp3, wav, ogg 等) を取り込み。1 ファイル最大 12MB、総曲数 32。
- 取り込み後は IndexedDB (`mini_music_player_db`) に ArrayBuffer とメタ情報を保存。メタ情報: `id`, `name`, `type`, `size`, `addedAt`, `duration`。
- プレイリストは `state.tracks` に `[{ id, name, duration, type, size, addedAt }]` 形式で保持。ドラッグ対応までは行わず、選択トラックの上/下移動ボタンと削除ボタンを提供。
- トラック名はダブルクリックでリネーム可能 (ローカルにのみ反映)。
- プレイリストの並びと選択状態は `localStorage` に保存。IndexedDB と同期し、欠損トラックは自動的に除外。

## 再生・永続化
- `<audio>` 要素を 1 つ使用し、必要に応じて `URL.createObjectURL()` で Blob を読み込む。
- `state.currentTrackId`, `state.currentTime`, `state.isPlaying`, `state.volume`, `state.playbackRate`, `state.loopMode ('none'|'one'|'all')`, `state.shuffle` を `localStorage['mini_music_player_state_v1']` に保存。1 秒ごとにデバウンスして書き込み。
- MiniExp 起動時に状態を復元。`state.isPlaying` が真の場合は自動再生を試みる (失敗時は通知して一時停止状態にする)。
- `timeupdate` で再生位置を更新し、終了時 (`ended`) は次トラックに自動遷移。シャッフル ON 時はランダム選択。
- 再生中のトラック名・アートワーク (未実装時は波形アイコン) をヘッダーで表示し、`document.title` は変更しない。

## 視覚化
- `AudioContext` を lazily 初期化 (`ensureAudioContext()` をプレイボタン押下時に呼ぶ)。
- `MediaElementAudioSourceNode` → 6 つの `BiquadFilterNode` (EQ) → `GainNode` → `AnalyserNode` (FFT サイズ 2048) → `AudioContext.destination`。
- オシロスコープ: `analyser.getByteTimeDomainData()` を用いて波形を描画。背景はグラデーション、波形は蛍光色ライン。
- 周波数スペクトラム: `analyser.getByteFrequencyData()` をバー表示し、ピークホールドを 0.5 秒で減衰させる。
- `requestAnimationFrame` で 60fps 更新。MiniExp `stop()` 時には描画ループも停止。

## イコライザー
- 6 バンドはそれぞれ `BiquadFilterNode` (lowshelf, peaking, highshelf) を組み合わせて実装。ゲイン範囲は -12dB〜+12dB。
- プリセットは `flat`, `rock`, `vocal`, `bass_boost` の 4 種。各プリセットは 6 バンドのゲイン配列を持ち、選択するとスライダーとフィルタ値を更新。
- EQ 設定は `state.eqGains` (配列) と `state.eqPreset` として永続化。スライダー操作でプリセットは `custom` に切り替え。

## EXP 仕様
- アプリ起動 (`create` 完了) で `awardXp(5, { type: 'open' })`。
- トラック取り込み 1 曲あたり `awardXp(3, { type: 'import' })`。
- 再生ボタンで初回再生開始時に `awardXp(2, { type: 'play' })` (セッション中 1 回)。
- トラック完走 (`ended`) で `awardXp(10, { type: 'complete', trackId })`。
- イコライザープリセット変更で `awardXp(1, { type: 'preset' })` (30 秒クールダウン)。
- `state.sessionXp` に合算し、MiniExp の `getScore()` で返す。

## API 実装方針
- `create(root, awardXp)`:
  - DOM 構築、イベントリスナー設定、IndexedDB の初期化、状態復元、視覚化ループ準備。
  - `runtime = { start, stop, destroy, getScore }` を返却。`start()` でイベントリスナー (resize, keyboard) を有効化、`stop()` で pause & loop 停止。
  - 主要内部関数: `loadState()`, `persistState()`, `loadPlaylistFromDb()`, `setCurrentTrack(id, options)`, `play()`, `pause()`, `nextTrack(direction)`, `updateVisualizer()`, `applyEqPreset(name)`, `ensureAudioContext()`。

## データ永続化
- `localStorage['mini_music_player_state_v1']`: プレイリスト順・UI 状態。
- IndexedDB `mini_music_player_db` store `tracks`: 音声データ (ArrayBuffer) + メタ情報。削除時は `URL.revokeObjectURL()`。
- 永続化は書き込み失敗を try/catch で握りつぶし、失敗時は HUD トーストで通知。

## 将来拡張
- ID3 タグ解析によるメタデータ・アートワーク表示。
- Web Share Target からの直接追加。
- PWA 対応とバックグラウンド再生。
- クロスフェードやギャップレス再生への対応。

