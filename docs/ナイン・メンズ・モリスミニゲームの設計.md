# ナイン・メンズ・モリスミニゲームの設計

本設計は MiniExp MOD API v0.1 に基づき、伝統的なボードゲーム「ナイン・メンズ・モリス」を追加する。3×3の正方形が同心円状に連なった盤上で、自軍ストーンを配置・移動してミル（縦横3列）を作り、相手の駒を除去する対戦を再現する。プレイヤーは常に先手で、AIが後手を担当する。

- ID: `nine_mens_morris`
- 表示名: ナイン・メンズ・モリス
- エントリ: `games/nine_mens_morris.js`
- バージョン: 0.1.0
- カテゴリ: ボード

## ルール概要
- 盤面は24交点で構成。外周・中周・内周の正方形と、各辺中央を結ぶ通路が存在する。
- 各プレイヤーは9個のストーンを所持。配置フェーズでは交互に空点へ配置する。
- 9個配置完了後は移動フェーズへ移行。ストーンは線で繋がった隣接交点へ1マスずつスライドする。
- 自軍ストーンが3列並ぶと「ミル」を形成し、相手のストーンを1個除去できる。除去対象はミルに含まれていない駒が優先（全てミル内なら任意）。
- 自軍の盤上ストーンが3個以下になると「フライトモード」となり、任意の空点へジャンプ移動が可能。
- 相手の盤上ストーンが2個以下になる、または移動可能な手がなくなると勝利。逆の場合は敗北。

## 操作仕様
- マウスクリックで操作。配置フェーズは空点を直接クリック。
- 移動フェーズは自軍ストーンをクリックして選択→移動先をクリック。
- ミル成立時は除去可能な相手駒がハイライトされ、クリックで除去。
- 盤面上にターン情報、残駒数、フェーズ、捕獲数などを表示。
- `getScore()` は「プレイヤー盤上ストーン数 − AI盤上ストーン数」を返却する。

## EXP 配布設計
- ストーン配置: +1 EXP。
- スライド／フライト移動確定: +1 EXP。
- ミル成立: +15 EXP。
- 相手駒除去: +6 EXP。
- 勝利ボーナス: 難易度別に EASY:+80 / NORMAL:+150 / HARD:+260。
- 引き分けは想定せず（行き詰まりは勝敗処理）。

## UI・演出
- 520×520px キャンバスで盤面描画。木製ボード風の背景にラインを描く。
- 選択中ストーンは金色リング、移動候補は青いホバーで示す。
- ミル形成時は成立線上を柔らかくグローさせ、除去候補は赤リング表示。
- 右側に情報パネルを配置し、現在フェーズ、捕獲数、操作ヒントを日本語で表示。
- `window.showTransientPopupAt` が利用可能な場合、配置・除去時に EXP ポップアップを表示。

## AI 方針
- 盤面評価関数により最善手を探索するミニマックス（αβ枝刈り）を実装。
- 難易度ごとの探索深さ/分岐制限:
  - EASY: 深さ1（貪欲）、候補上位8手からランダム選択。
  - NORMAL: 深さ2、候補8手。
  - HARD: 深さ3、候補6手。
- 評価指標: 駒数差、ミル数差、潜在ミル（2連+空点）、相手駒の可動性、ミル成立の即時性などを重み付け。
- ミル成立時の除去は評価値が最大となる駒を優先して選択。

## 実装ポイント
- 24交点は 0〜23 のインデックスで管理し、座標・隣接リスト・ミル構成を定数化。
- ゲーム状態: `board[24]`, `placedCount[color]`, `captured[color]`, `turn`、`phase`、`selected`、`removalTargets` 等。
- `generateMoves(board, placedCount, color)` で配置/移動/フライト全対応の合法手を列挙し、必要に応じて除去候補を展開。
- `formsMill(board, index, color)` で指定交点がミル内か判定し、`getRemovalCandidates(board, opponent)` で除去対象を取得。
- `evaluateState(board, placedCount)` で AI 評価値を算出。αβ探索の葉ノードに使用。
- `window.registerMiniGame` にて `nine_mens_morris` を登録し、manifest にエントリを追加する。
- 盤面・パネル DOM は `start()` でイベント登録し、`stop()` で解除。`destroy()` はルートから要素を削除。

## manifest 追加例
```json
{ "id": "nine_mens_morris", "name": "ナイン・メンズ・モリス", "entry": "games/nine_mens_morris.js", "version": "0.1.0", "description": "配置+1 / ミル+15 / 勝利ボーナス", "category": "ボード" }
```
