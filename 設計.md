# dungeon-game-html 設計

本ドキュメントは、提供された仕様（HTML+CSS+JSでローグライク開発の仕様書.txt）と現行コード（index.html / style.css / main.js）を統合し、ゲーム全体の設計、今後の拡張（ブロック次元）を具体化したものです。

## 概要
- ターン制ローグライク風RPG（4方向移動、斜め移動なし）
- プレイヤー行動1回につき敵も1回行動
- 接触（隣接）でのみ近接攻撃が可能。先に隣接した側が先制
- ダンジョンはプロシージャル生成（マス目）。全床は4方向のみで到達可能（連結保証）
- ダンジョンから戻るとHP全回復。経験値・レベル・アイテムは保持
- ゲーム状態はローカル永続化（JSON）。インポート/エクスポート対応

## 技術スタック / 構成
- HTML/CSS/JavaScript（バニラ）
- DOM描画＋Canvas（マップ描画）。UIはカード/モーダル/ログ等
- 永続化：localStorage（キー: `roguelike_save_v1`）＋JSON入出力
- 主要ファイル
  - index.html: 画面構成（選択画面、ゲーム画面、モーダル、ツールバー）
  - style.css: モダンUI（グラデーション、グラスモーフィズム、カード/バー/モーダル）
  - main.js: ゲームロジック（生成、戦闘、入出力、永続化、UI更新）

## データモデル（概略）
- Player
  - position: x, y
  - level, exp (必要経験値1000固定), maxHp, hp, attack, defense, facing
  - inventory: { potion30, hpBoost, atkBoost, defBoost }
- Enemy
  - position: x, y, level, maxHp, hp, attack, defense
- Map
  - `map[y][x]`: 0=床, 1=壁（外周は壁固定）
  - `tileMeta[y][x]`: { floorColor?, wallColor?, floorType? } を保持（無設定時は null）
    - `floorType`: `'normal' | 'ice' | 'poison'`
    - 壁へ戻した場合は床系メタを削除する
  - サイズ：`base = 15 + (階層 × 5)` の正方形
- Dungeon meta
  - world: 'A'..'J' or 'X'
  - base (1,11,...,91) → ダンジョン名/type/説明
  - difficulty: Very Easy/Easy/Normal/Second/Hard/Very Hard
  - level(floor): 1..10（X世界のみ1..25）
- Entities
  - enemies: (幅+高さ)/8 体
  - chests: (幅+高さ)/15 個（プレイヤーLv≥推奨+5の時は0）
  - stairs: 次フロアへの階段1つ（ランダム or タイプ別配置）

## 推奨レベル（現行）
- world A..J: それぞれ 0/100/200/.../900 のオフセットを base に加算
- world X: 1000 + 階層

### 追加: NESTED次元（BlockDim専用）
- 概念: ブロック次元モードで入力できる追加の“階層”番号（1..99,999,999）。
- 目的: 同じブロック組み合わせのまま推奨レベルを大きくシフト可能にする長尺スケーリング。
- 入力UI: BlockDimの「次元」リストの上に数値入力欄「NESTED次元」を追加（既定値1）。
- 推奨Lv補正: `offset = 2600 × (nested - 1)` を合成推奨Lvに加算。
  - 例: nested=1 → +0、nested=2 → +2600、nested=3 → +5200（以降 +2600 刻み）
- シード: 既定では NESTED はシード計算に含めない（マップ構造は不変、敵/宝箱のレベル帯のみ上方シフト）。
  - ただし Gate履歴/ブックマークのキーには含めて区別する。


## 難易度倍率（与/被）
- Very Easy: 与4.0 / 被0.25
- Easy: 与2.0 / 被0.35
- Normal: 与1.6 / 被0.5
- Second: 与1.4 / 被0.7
- Hard: 与1.2 / 被0.85
- Very Hard: 与1.0 / 被1.0

## ダメージ/命中（要点）
- クリティカル率10%、倍率1.5x、乱数係数70%-120%、小数切り上げ（0.5未満は0）
- レベル差補正：差5で2x/0.5x、差10で10x/0.1x、差20で100x/0.01x（以降10差ごとに10倍/0.1倍）
- 命中：差2以内=80%、差3以上=高い側必中、差5以上=高い側必中+確クリ/低い側50%ミス、差7以上=低い側必ミス

## 画面/操作
- 選択画面
  - 世界/ダンジョン選択、難易度、詳細カード（タイプ、推奨レベル、説明、与/被ダメ倍率）
- ゲーム画面
  - 左: ステータスカード（レベル/攻撃/防御、HP/EXPバー）
  - 下: メッセージログ（最大100行、最新優先）
  - 右上ツールバー: 戻る/アイテム/ステータス/インポート/エクスポート、階数表示
  - モーダル: アイテム、ステータス、敵情報
- 入力
  - 4方向移動（斜め無効）。移動/攻撃/使用/階段で1ターン進行
  - 氷床上に進入すると同方向へ自動滑走し、壁/通常床/敵/階段で停止。滑走中に敵へ衝突した場合はその場で戦闘処理を行いターンを終了
  - 毒床上を通過するたびに最大HPの10%（最低1）ダメージを受け、HP<=0 で毒死（ゲームオーバー処理）
  - 戻るで選択画面へ戻り、HP全回復

## ダンジョン生成（タイプ）
- 共通
  - 生成後に連結保証（4方向）。外周は壁
  - 連結保証は成分間A*接続（重心近傍の境界タイル同士をA*で掘削）に更新
  - 座標確定後、プレイヤー/敵/宝箱/階段を床上に配置
  - 生成コンテキストは `setFloorColor` / `setWallColor` / `setFloorType` 等でタイルメタを指定可能
- field: 一様ランダム障害物（密度はサイズ依存で減衰）
- cave: 制約付きドランカードウォーク（複数ウォーカ、分岐/転回率）→ 軽セルオートマトン平滑化(5閾値×2) → 任意チャンバー生成 → A*接続 → 端部クリーンアップ
- narrow-maze: 再帰バックトラック迷路（1セル幅）＋追加接続
- wide-maze: 上記の3×スケール版（3セル幅の通路）
- rooms: Poisson Diskで部屋中心をサンプリング→非重複長方形配置→部屋中心のPrim-MST＋余剰辺25%→各辺をA*で掘削
- circle: 中央円形部屋
- single-room: 中央単一長方形部屋
- snake: 1本の曲がり通路をターゲット指向で延伸（枝分かれ最小化）
- grid: 通路が一定間隔で格子状に走る（交差点多数、外周以外は格子の床）。間隔=1、太さ=1で固定［混合型のみ出現］
- open-space: 外周の壁以外はすべて床（広い空間）［混合型のみ出現］
- mixed: 上記（grid/open-space 含む）の中からフロア毎にランダム。BlockDimでは選択ブロック由来タイプのみに限定。エンティティ配置（プレイヤー/階段）は実際に選ばれたサブタイプのルールに従う（例: snakeは左上開始・右下階段）。

### エンティティ配置
- プレイヤー: タイプに応じて中央/左上/ランダム安全床
- 敵: (W+H)/8 体、推奨Lv±4 でレベル決定。Poisson分散（最小距離）で密集を回避
- 宝箱: (W+H)/15 個（プレイヤーLv < 推奨+5 の場合のみ）。Poisson分散。中身は90%でHP30%回復、10%で能力上昇
- 階段: 原則ランダムだが、プレイヤー/敵からの最小距離（マンハッタン≥3）を確保。snake は右下寄りを優先

### ボスフロア
- 通常世界: 10F 到達で 10×10 部屋を生成し中央にボス
- X世界: 25F で同様（現行コード仕様）
- ボスの周囲（上下左右）に宝箱4つ（プレイヤーLv ≥ ボス+5 の場合は非生成）

## 戦闘と成長
- プレイヤー初期: HP100(+5/レベル), 攻10(+1), 防10(+1)
- 敵初期: HP50(+5), 攻8(+1), 防8(+1)
- ボス: HP1000(+50)、攻防は通常成長相当、ボスLv=推奨+5
- 経験値（通常敵）: 指定表（±7以上=1200、±5以上=600、同Lv=150、… 6以上低い=1）
- ボス経験値: 通常敵合計の2倍
- レベルアップ必要経験値: 1000固定

## 永続化/インポート・エクスポート
- localStorage: `roguelike_save_v1` に { dungeonLevel, player, selectedWorld, selectedDungeonBase, difficulty }
- エクスポート: 現在の保存状態をJSONとして出力
- インポート: JSONから復元（不正値は防御的に無視/初期化）

## 既存コードと仕様の差異/補足
- 仕様は最大10Fだが、現行はX世界のみ25Fボス対応
- ダンジョンタイプは仕様の「四角い構造物」以上に多彩（cave/maze/rooms/snake等）。mixedで多様性
- 接続性保証は flood-fill → 最近傍床へ通路生成（4近傍）で実現
- 敵/宝箱数は仕様の式どおり（(W+H)/8, (W+H)/15）

## 今後の追加予定: ブロック次元（設計）
ドットハック風のエリアワードを「ブロック」と呼び、a..z の「次元」と 1st/2nd/3rd ブロックを組合せてダンジョン特性を決定する新モード。

### 仕様要約
- 次元: a..z（a推奨Lvは1開始、bは101開始 → 100刻み）
- ブロック: 1st/2nd/3rd 各100種（計100万組合せ）
- 合成結果: 推奨Lv補正、種類（生成タイプ）、広さ（マップサイズ係数）、階層深さ（1F〜15F）、宝箱量（少/普/多）、ボス出現階層（複数可）
- UI: ダンジョン選択にタブ「ブロック次元」。次元/各ブロックをセレクト → 現時点の累計特性を詳細カードに表示 → Gateで生成/入場

### データ設計（例）
```js
// 次元（a..z）
const dimensions = [
  { key: 'a', name: 'Aether', baseLevel: 1 },
  { key: 'b', name: 'Basalt', baseLevel: 101 },
  // ... 'z' まで 100刻み
];

// ブロックテーブル（各100種、ここでは示意）
const blocks1 = [{ key:'verdant', level:+10, size:+0, depth:+2, chest:'normal', type:null, bossFloors:[10] }, /* ... */];
const blocks2 = [{ key:'cryptic', level:+25, size:+1, depth:+0, chest:'more',   type:'cave', bossFloors:[] }, /* ... */];
const blocks3 = [{ key:'labyrinth', level:+0, size:+0, depth:+3, chest:'more', type:'narrow-maze', bossFloors:[5,10,15] }, /* ... */];

// 合成ロジック
function composeSpec(dim, b1, b2, b3) {
  const base = dim.baseLevel; // a=1, b=101, ...
  const level = base + (b1.level||0) + (b2.level||0) + (b3.level||0);
  const sizeFactor = (b1.size||0) + (b2.size||0) + (b3.size||0); // -2..+2 程度
  const depth = clamp(1, 15, 1 + (b1.depth||0) + (b2.depth||0) + (b3.depth||0));
  const chestBias = majority([b1.chest, b2.chest, b3.chest]); // 少/普/多
  // 新仕様: ブロックの type を合成 → 'mixed' + typePool
  const pool = [b1.type, b2.type, b3.type].filter(Boolean);
  const typePool = Array.from(new Set(pool));
  const type = 'mixed';
  const bossFloors = unionNormalize([b1.bossFloors, b2.bossFloors, b3.bossFloors]);
  return { level, sizeFactor, depth, chestBias, type, typePool, bossFloors };
}
```

### 生成パイプライン拡張
- 選択画面にタブ/フォーム（次元/1st/2nd/3rd セレクト, 詳細カード, Gateボタン）
- 合成結果 → `recommendedLevelForSelection` 相当の推奨Lvを返却
- `updateMapSize()` を sizeFactor で拡張（例: base = 15 + floor*5、sizeFactor ±で拡大/縮小）
- `generateMap()` の genType を合成typeに差替（mixedも可）
- `generateEntities()`
  - chestBias に応じて (W+H)/15 の係数を 0.7/1.0/1.3 などでスケール
  - bossFloors に一致した階層で `generateBossRoom()`（複数階層対応）

### 実装ステップ
1) UI: タブ、セレクト、詳細カード、Gateボタンの追加
2) データ: 次元と3ブロックのサンプル辞書実装（後で100種に拡張）
3) 合成: composeSpec 実装 → 既存の推奨Lv/サイズ/タイプ/深さ/宝箱/ボス階層へ反映
4) 永続化: 直近のブロック選択を保存/復元
5) バリデーション: 生成パラメータの安全域（サイズ、深さ）を検証
6) QA: 連結保証/配置/ボス階層/宝箱数の不変条件を自動チェック

## 品質/不変条件（自動チェック指標）
- 連結: 4方向で全床が到達可能（ensureConnectivity後）
- 配置: プレイヤー/階段/敵/宝箱は床上で重複なし
- 上限: 敌/宝箱数は式に準拠（bias/難易度のみスケール差）
- ボス: 指定階層で10×10部屋/ボス/宝箱4の条件成立（Lv条件含む）

## 参考：責務マップ（現行）
- 生成
  - `generateMap()` + 各タイプ（field/cave/maze/rooms/single-room/circle/narrow-maze/wide-maze/snake/grid/open-space/mixed）
  - `createCorridor()` は A*掘削（曲率/壁沿いペナルティ）。`ensureConnectivity()` は成分間A*接続
- 配置
  - `generateEntities()`（敵/宝箱/階段）
- UI/入出力
  - 選択画面UI更新、ステータス/ログ/モーダル描画、インポート/エクスポート
- 永続化
  - `saveAll()` ほか localStorage 管理

---
本設計は現行コードの挙動に忠実でありつつ、ブロック次元の導入点を局所変更で差し替え可能な形で整理しています。次は生成アルゴリズムの分析と最新動向の調査に基づく改善案作成に進みます。
