# フロア降りサバイバルミニゲームの設計

本設計は「ミニゲームAPI書（MiniExp MOD API v0.1）」準拠。刻一刻と迫る針天井から逃れるため、足場を伝って下へ下へと降り続ける縦スクロール型アクションゲームを追加する。

- ID: `floor_descent`
- 表示名: フロア降りサバイバル
- エントリ: `games/floor_descent.js`
- バージョン: 0.1.0
- カテゴリ: アクション

## ルール / 操作
- 左右移動: `←` / `→` または `A` / `D`。
- ジャンプ: `↑` / `W` / `Space`。タッチ/クリックでもジャンプ。
- ポーズ: `Esc`。
- ライフ 5 制。針天井に触れるたびに 1 ライフ減少。
- プレイヤーが画面外（足場より下）に落下するとゲームオーバー。

## 足場の種類
- **通常床**: 静止した足場。降下の基本ルート。
- **ベルトコンベア床**: 接地すると矢印方向に自動で移動。勢いを活かして次の足場へ飛び移る。
- **スプリング床**: 着地直後に大きくバウンド。上方へ弾かれるため、針天井との距離に注意。
- 足場は 1 フロア 1〜2 枚の確率で出現し、毎回ランダム位置・種類。

## スクロール / 難易度
- 画面上端から針天井が常に迫る。プレイヤーの到達深度に応じて徐々に下降速度が上がる。
- カメラはプレイヤーより少し上を注視し、下方向への視界を広く確保。
- 難易度ごとに針速度・足場間隔・ベルト強度を調整。
  - EASY: 天井速度低め、足場の間隔が狭い、スプリング出現率低。
  - NORMAL: 標準設定。
  - HARD: 天井速度高め、足場間隔広め、ベルト/スプリング出現率アップ。

## EXP 仕様
- 深度 120px ごとに「フロア」カウントを進め、フロア到達時に EXP 付与。
  - 基本 EXP: `6 + floor * 0.8`。難易度補正（EASY×0.8 / NORMAL×1.0 / HARD×1.25）。
- 連続してスプリング足場から安全に着地するとボーナス（+8）。
- ライフが残った状態でゲームオーバーした場合、残ライフ ×5 の救済 EXP。
- `awardXp(value, { type, floor, chain, difficulty })` 形式で通知。

## UI / 演出
- キャンバス左上: ハート型ライフインジケータ（残数 5）。
- 右上: 現在フロアとベストフロアを表示。
- 上部中央: 針天井との距離をゲージ表示。警告距離で点滅演出。
- 足場タイプごとに色分け（通常: グレー、ベルト: オレンジ矢印、スプリング: シアン）。
- 針接触時は画面を赤くフラッシュし、ヒット無敵 0.6 秒を付与。

## 実装方針
- `create(root, awardXp, { difficulty })`:
  - `canvas` を生成し、`requestAnimationFrame` でゲームループ。
  - プレイヤー・足場・針天井を構造体で管理。足場はプレイヤー深度に合わせて procedual 生成。
  - 当たり判定は矩形/線分で行い、スプリングの跳ね返りは速度反転。
- `start()` / `stop()` / `destroy()` を実装し、ポーズ・終了処理も含む。
- `getScore()` は踏破フロア数を返却し、ランキング用途で利用。
- 入力はキーボード・ポインタ両対応。スマホでは左右ボタン付き仮想パッドを画面下部に表示。

## 例外処理
- DOM 削除時の二重呼び出しに備え、`destroy()` でイベントリスナーの有無を確認。
- `awardXp` が未設定の場合でもゲームが成立するようガード。
- フレームスキップ時（`dt > 0.1`）は物理更新を分割し、落下でのすり抜けを防ぐ。

## manifest 追記例
```json
{ "id": "floor_descent", "name": "フロア降りサバイバル", "entry": "games/floor_descent.js", "version": "0.1.0", "author": "mod", "description": "迫る針天井から逃げながら下に降り続けるアクション", "category": "アクション" }
```
