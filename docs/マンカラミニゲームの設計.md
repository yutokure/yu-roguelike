# マンカラミニゲームの設計

本設計書は MiniExp MOD API v0.2 に基づき、カラハ式マンカラを 1 ゲームとして実装するための仕様をまとめる。プレイヤーは 6 ピット制の定番ルールで AI と対戦し、種まきや捕獲、勝敗に応じて EXP を獲得する。

## 基本情報
- ID: `mancala`
- 表示名: マンカラ
- エントリ: `games/mancala.js`
- カテゴリ: ボード / 抽象戦略
- 難易度: `EASY | NORMAL | HARD`（初期種数・AI の強さ・思考時間を変化）
- 対戦形式: 1P（下側） vs コンピュータ（上側）
- 盤構成: 各陣営 6 ピット + ストア 1（計 14 口）
- 初期種数: EASY=3, NORMAL=4, HARD=5（各ピットに均等配置）

## EXP 方針
- アクション EXP
  - 手番実行: ベース +1
  - ストアへ運んだ種: 1 粒あたり +0.6
  - 捕獲: 捕獲粒数×1.5 追加
  - 追加ターン: +2.5
- 結果 EXP
  - プレイヤー勝利: `22 + min(40, 差分×2.5)` を難易度倍率（EASY×0.8 / NORMAL×1.0 / HARD×1.2）で乗算
  - 引き分け/敗北: 追加 EXP なし（敗北でもアクション分は保持）
- EXP 呼び出し: `awardXp()` は手番毎と勝利時にまとめて実行。

## UI 構成
```
mini-mancala-root
├─ mancala-info（ステータス／スコアバッジ／操作ボタン）
│   ├─ status: 手番や結果のメッセージ
│   ├─ score badges: あなた / AI のストア粒数
│   └─ actions: リスタート / ヒント
├─ mancala-board（ボード本体）
│   ├─ store.ai
│   ├─ pits-area
│   │   ├─ pit-row.ai（AI 側 6 ピット：表示は右→左）
│   │   └─ pit-row.player（プレイヤー側 6 ピット：左→右）
│   └─ store.player
└─ history（直近 12 手のログ）
```
- ピットはクリック可能ボタン。`data-seeds` 属性を `::after` 疑似要素で描画。
- `player-turn` クラスで自分の選択可能ピットを強調。
- 捕獲／ヒント時は `flash` アニメーションを付与。
- スマホ対応: 幅 820px 以下で縦積みに切り替え。

## ゲーム進行
1. `start()` で状態初期化しプレイヤー手番から開始。
2. ピットを選択すると以下の処理を順番に行う。
   1. 選択ピットの種を取得し 1 粒ずつ反時計回りに配布。
   2. 相手ストアはスキップ。
   3. 自ストアに終着した場合は追加ターン。
   4. 自陣の空ピットで終着し、向かいの相手ピットが空でなければ捕獲。
3. プレイヤー手番終了後は AI に遷移（連続手番時を除く）。
4. いずれかの陣営ピットが全て空なら残りを相手ストアにまとめ、勝敗判定して終了。
5. `getScore()` はプレイヤーストア粒数を返す。

## AI ロジック
- EASY: ランダムな合法手番。
- NORMAL: 単手評価（ストア増分/捕獲/追加ターン/ストア差）で最大値を選択。
- HARD: 上記に加えて、同評価の手はプレイヤー側の次手ベストキャプチャ期待値が小さいものを選択。
- 思考時間: EASY=900ms, NORMAL=650ms, HARD=450ms の遅延後に着手。

## ヒント
- プレイヤー手番で `ヒント` ボタンを押すと、単手評価値が最大のピットをハイライトしメッセージ表示。

## 履歴
- 直近 12 手まで `YOU / AI` の行動ログを表示。
- 表示内容: 使用ピット番号（1〜6）とストア増分・捕獲・追加ターン情報。

## ランタイム/クリーンアップ
- `stop()` は AI の思考タイマーを解除。
- `destroy()` は `keydown` リスナーを解除し、DOM を初期状態へ戻す。
- CSS は初回起動時に `<style id="mini-mancala-style">` を 1 度だけ挿入。

## 追加検討
- 将来的に対人モードを追加する場合は `state.current` の切替と UI の説明を整理する。
- 捕獲演出や種のアニメーションは `requestAnimationFrame` を使って段階的に描画する余地がある。
