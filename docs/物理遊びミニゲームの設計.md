# 物理遊びミニゲームの設計

## 目的
MiniExp MOD の「トイ」カテゴリに、粉遊び系サンドボックスと簡易剛体シミュレーションを組み合わせたミニゲーム「物理遊び」を追加する。図形に素材・パラメータを設定して重力/慣性を伴う動きをシミュレーションし、火・水・ツタ・雷・電気回路などのエフェクトを使って自由に遊べるツールセットを提供する。操作やオブジェクトの生成/削除、衝突に応じて経験値を得られる。

## ユーザー体験
- 上部ツールバーに「選択」「図形追加（円/箱）」「エフェクトエミッタ追加（火/水/ツタ/雷/回路）」「削除」「保存/読み込み」「シミュレーション制御（開始/停止/リセット）」などのボタンを並べる。
- 左側にキャンバス（物理世界）を配置し、右側にプロパティパネルを表示。選択中の図形/エミッタのパラメータ（サイズ、質量、反発、摩擦、素材プリセット、エミッションレート、継続時間など）を編集できる。
- 下部 HUD で粒子数や総エネルギーなど簡易統計を表示し、保存スロットの確認や XP 取得フィードバックを行う。
- シミュレーションは初期状態で停止。ユーザーが「開始」ボタンでランダム重力下のシミュレーションを動かせる。いつでも停止/再開/リセットが可能。
- 保存/読み込みはローカルストレージを使用し、JSON 設定を複数スロット（名前付き）で管理する。

## データ構造
### ワールド
- `state` … `gravity`, `airDrag`, `bodies`, `emitters`, `particles`, `wires`, `running`, `selectedId`, `initialSnapshot`, `sessionExp` 等を保持。
- `bodies` … 剛体。`{ id, type: 'circle'|'box', x, y, vx, vy, width, height, radius, mass, invMass, restitution, friction, static, materialId, color, burnTimer, wetness, vineGrip, chargeTimer }`。
- `emitters` … 粒子エミッタ。`{ id, kind: 'fire'|'water'|'vine'|'lightning'|'circuit', x, y, rate, spread, power, enabled, lifetime, poweredTicks, connections: string[] }`。
- `particles` … 粉遊び粒子。`{ id, type, x, y, vx, vy, life, payload }`。フレーム毎に挙動を更新し、ボディと相互作用。
- `initialSnapshot` … `bodies` / `emitters` / グローバル設定のディープコピー。リセット時に復元。
- `savedLayouts` … ローカルストレージに `{ name, snapshot }` 形式で保存。

### 素材プリセット
`MATERIALS` テーブルで `wood`, `metal`, `rubber`, `stone`, `gel`, `plasma` などを定義。密度・反発係数・摩擦係数・伝導率・燃焼性を持たせ、適用時に `mass`, `restitution`, `friction`, `color` を自動設定。

### 電気回路
- `circuit` エミッタはノード扱い。`connections` 配列で他ノードとの接続を保持。
- シミュレーション中、`poweredTicks > 0` のノードは接続先にも電力を伝搬（BFS）。雷粒子がノードに触れると `poweredTicks` を初期化。常時点灯させる `source` フラグも設定可能。

## ロジック
### シミュレーションステップ
1. `dt` 固定のサブステップで剛体を更新。
    - 静的でないボディに重力・空気抵抗を適用。
    - 床・壁への当たり判定（ワールド境界でバウンス）。
    - ボディ同士の衝突判定: 円-円、円-箱、箱-箱（軸平行）。最小貫入ベクトルで位置補正し、反発係数・質量に基づく簡易インパルスを計算。
    - 衝突強度に応じて `awardXp` を呼び、同一ペア連続衝突を抑制するために `collisionCooldown` マップを使う。
2. 粒子の挙動を更新。
    - 火: 上昇・ライフ減衰。近傍ボディを加熱し `burnTimer` を増やす。燃え尽きると色替え＆質量減少。
    - 水: 重力に従い落下し、接触したボディに `wetness` を付与して摩擦/温度を減衰。
    - ツタ: ゆっくり落下し、ボディや地面に付着すると固定ノードを生成。周囲へ増殖してネットワークを構築、接触したボディの速度を抑える。
    - 雷: 高速直進。衝突したボディの `chargeTimer` を設定し、近傍の回路ノードを点灯させる。
    - Circuit spark: ノードが電力を持つと一定間隔で発生し、周辺ボディに小さな衝撃を与える。
3. ヒューズ/状態の更新。
    - `burnTimer` が一定超でボディにダメージ（サイズ減少・最終的に破裂）。
    - `wetness` は時間とともに減衰し、燃焼を抑制。
    - `chargeTimer` から電力の減衰を管理。
4. HUD 更新: ボディ数、粒子数、稼働中のノード数、セッション内獲得 EXP を表示。

### UI イベント
- キャンバスクリック/ドラッグ
    - `select` ツール: 最前面のボディ/エミッタを選択。Shift ドラッグで複数選択（設計では単一選択のみ扱う）。
    - `add-circle` / `add-box`: クリック地点に新規ボディを生成。ドラッグ距離でサイズ初期値を変化。追加時に `awardXp(12)`。
    - `add-fire` などのエミッタ: クリック地点にノードを生成し `awardXp(8)`。
- プロパティパネル
    - 入力フォームは `input[type=number|range]` と `select` を使用。`適用` ボタンで選択ボディへ反映。
    - 素材プリセットは `select` 変更時即適用。
    - 回路ノード用に「接続モード」ボタンを用意し、次にクリックした別ノードと相互接続。
- 保存/読み込み
    - 保存ボタン押下で `prompt` から名前を取得し、`localStorage['miniphys_layouts']` に JSON で書き込む。
    - 読み込みボタンで選択ダイアログ（`select`) を表示し、選んだレイアウトを復元。

### 経験値付与
- ボディ/エミッタ追加: `+10`（ボディ）、`+8`（エミッタ）。
- ボディ削除: `+5`。
- 衝突: インパルスに応じて `min(25, impulseMagnitude * 0.08)`。
- 粒子がエフェクトを起こしたとき（火が燃焼開始、雷が回路点灯、ツタが新ノード生成）などにも小量 (`+2〜+6`) を与える。
- `awardXp` の戻り値を `sessionExp` に蓄積し、`getScore()` で返す。

## 主要関数
- `create(root, awardXp, opts)` … DOM 初期化、イベント登録、初期ボディ生成（床）。
- `setTool(toolId)` … ツール切替、UI 状態の更新。
- `spawnBody(kind, params)` / `spawnEmitter(kind, params)` … オブジェクト生成と XP 付与。
- `removeSelected()` … 選択オブジェクトの削除。
- `stepSimulation(dt)` … 剛体および粒子の物理演算。
- `resolveCollision(a, b)` / `collisionImpulse` … 衝突処理。
- `igniteBody(body, intensity)` / `soakBody(body, amount)` / `entangleBody(body, strength)` / `chargeBody(body, energy)` … 状態変化ヘルパ。
- `saveSnapshot(name)` / `loadSnapshot(name)` / `resetFromSnapshot()` … レイアウト管理。
- `render()` … キャンバス描画。ボディ/エミッタ/粒子/選択ハイライトを描画し、状態に応じて色を変更。

## API 準拠
- `create` は `return { start, stop, destroy, getScore }` を返却。
- `start` でアニメーションループを開始、`stop` で停止。
- `destroy` でイベントリスナと DOM を解除。
- シミュレーション中でも `awardXp` を安全に呼び出すよう try/catch を挿入し、エラーでループが停止しないようにする。

## テスト観点
- 各ツールのクリック動作（追加・選択・削除）が期待通りか。
- パラメータ変更（質量・反発・素材）がシミュレーションに反映されるか。
- 粒子エミッタが種類別に挙動し、ボディと相互作用するか。
- 経験値が追加/削除/衝突/エフェクトで加算されるか。
- 保存・読み込み・リセットが JSON データを使って復元できるか。
- Stop/Start ボタンでループを制御できるか。
