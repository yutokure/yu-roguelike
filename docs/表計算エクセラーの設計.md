# 表計算エクセラーの設計

MiniExp MOD のユーティリティカテゴリに、軽量な Excel 互換スプレッドシート「表計算エクセラー」を追加する設計。セルでの基本計算や書式設定、簡易関数をサポートし、XLSX 形式の読み書きが可能なツールとする。

- ID: `exceler`
- 表示名: 表計算エクセラー
- エントリ: `games/exceler.js`
- バージョン: 0.1.0
- カテゴリ: ユーティリティ
- 目的: MiniExp 内での簡易な表計算・集計、既存ユーティリティとの連携。XLSX の読み書きで外部ファイルと連携しつつ、互換性の注意を行う。

## 画面レイアウト
1. **ウィンドウシェル**: ダークトーンのカード。ヘッダーにはアプリアイコン、ファイル名、互換性警告バッジ、主要操作ボタン（新規・読み込み・保存）を配置。ウィンドウ全体は Flex column で構築。
2. **ツールバー**: 下段に 2 行構成のツールバーを置く。
   - 1 行目: ファイル操作（新規、インポート、エクスポート）、元に戻す/やり直し、貼り付けモード切替、警告を表示する「互換性」ボタン。
   - 2 行目: 書式設定（フォントサイズ、太字/斜体/下線、文字色、塗りつぶし色、配置（左/中央/右/上下中央）、数値形式（標準・数値・通貨・パーセント））。
3. **名前ボックス + 数式バー**: 左に選択セル番地（例: A1）を表示するボックス、右に編集可能な数式バーを配置。Enter で適用、Esc でキャンセル。
4. **ワークシート領域**: 固定ヘッダーのスクロールグリッド。列ヘッダー（A〜Z...）と行ヘッダー（1〜）を表示し、クリックで選択。セルは 120 行 × 40 列を初期生成。選択セルは青枠、複数範囲選択はドラッグで対応。
5. **サイドフッター**: 右下にセル情報（データ型、関数評価結果、警告メッセージ）とセッション内の獲得 EXP を表示。

## 状態管理
- `state = {
    sheetName,
    cells: Map<string, Cell>,
    rows,
    cols,
    selection: { anchor: string, focus: string },
    clipboard,
    undoStack,
    redoStack,
    dirty,
    filename,
    sessionXp,
    warning, // 最新の互換性・評価警告
  }`
- `Cell = { value: string | number | boolean | null, formula: string | null, format: 'general' | 'number' | 'currency' | 'percent', style: { bold, italic, underline, textColor, fillColor, horizontalAlign, verticalAlign }, type: 'text' | 'number' | 'boolean' | 'error', note?: string }`
- 参照用に `dependencyGraph = Map<cellRef, Set<depRef>>` を構築。更新時に逆順再計算。
- 永続化は `localStorage['mini_exceler_autosave_v1']` に最近開いたファイル名、セルデータ、フォーマットを保存（最大 120×40 の有効セルのみ）。

## XLSX 読み込み
- FileReader で ArrayBuffer を取得し、`fflate` による ZIP 展開を行う。
- `xl/workbook.xml` からシート名を取得（先頭シートのみサポート）。
- `xl/sharedStrings.xml`、`xl/styles.xml`（日付/数値フォーマット判定用）、`xl/worksheets/sheet1.xml` を解析。
- セルの種類:
  - `t="s"` : sharedStrings 参照 → 文字列。
  - `t="b"` : boolean。
  - `t="str"` または `inlineStr` : 文字列。
  - `t` 未指定: 数値。日付シリアル値は styles のフォーマット ID から判定し ISO 文字列へ。
- `f` 要素が存在するセルは `formula` に格納し、`v` が存在すればキャッシュ値を `value` に。
- 読み込み完了後、サポート外の機能（複数シート、図形、コメント、名前付き範囲、マクロ）が検出された場合は `state.warning` に追記し、ヘッダーに警告バナーを表示。
- 読み込み時は必ず互換性警告モーダルを表示し、「サポート外機能は失われる場合があります」と案内。

## XLSX 書き込み
- 現在のシートを `fflate.zipSync` で ZIP 化し、OpenXML 構造（`[Content_Types].xml`, `_rels/.rels`, `xl/workbook.xml`, `xl/styles.xml`, `xl/sharedStrings.xml`, `xl/worksheets/sheet1.xml`）を生成。
- 書き込み対象は 1 シートのみ。style は基本フォント + 一部セルスタイル（太字、斜体、文字色、塗りつぶし、水平/垂直配置）を styles.xml にマッピング。
- 数式は `f` タグに書き戻し、値は再計算済みを `v` へ。サポート外書式（条件付き書式、テーブル等）は破棄。
- エクスポート前に警告ダイアログを表示し、互換性注意文言を添える。

## 数式・関数評価
- セルに `=` で始まる文字列を入力すると formula として解釈。
- サポートする演算: `+ - * / ^`, 括弧, 数値, 文字列（""）、セル参照、範囲参照。
- サポートする関数:
  - `SUM`, `AVERAGE`, `MIN`, `MAX`, `COUNT`, `COUNTA`, `IF`, `ROUND`, `ROUNDUP`, `ROUNDDOWN`, `ABS`, `INT`, `MOD`, `POWER`, `SQRT`, `CONCAT`, `TEXT`, `LEN`, `SUBTOTAL`（集計 1〜11 に対応）。
- `state.evaluator` を実装し、Shunting Yard アルゴリズムでトークンを評価。関数引数は範囲展開ユーティリティを使用。
- 依存セルは BFS で再計算し、循環参照は検出してセルに `#CYCLE!` を表示。

## 書式設定
- 太字/斜体/下線、文字色、背景色、水平配置（左/中央/右）、垂直配置（上/中央/下）、数値形式（標準、カンマ区切り、小数桁数調整、パーセント、日付）を実装。
- フォントサイズは 10〜18px を 1px 刻みで選択可能。
- セル幅は列ヘッダーのドラッグで調整（最小 60px）。
- 選択範囲に対して書式ボタンが適用される。

## インタラクション
- クリックで単一セル選択、Shift+矢印で範囲拡張、Ctrl+C/V でコピー・貼り付け（内部フォーマットのみ）。
- ダブルクリックでセル編集（インプレース）。Enter/Tab/矢印で移動。
- ツールバーに「互換性」ボタンを設置し、未対応要素一覧・既知の制限を表示するスライドパネルを開く。
- Undo/Redo を 50 ステップ保持。

## EXP 仕様
- アプリ起動時に `awardXp(8, { type: 'open' })`。
- セル編集確定（値または数式適用）ごとに `awardXp(1, { type: 'edit' })`。連続入力は 500ms デバウンス。
- インポート成功時に `awardXp(10, { type: 'import' })`、エクスポート成功時に `awardXp(12, { type: 'export' })`。
- 書式変更は 3 操作ごとに `awardXp(2, { type: 'format' })`。
- セッション獲得 XP をフッターで表示し、`getScore()` で返却。

## 互換性・ガード
- 読み込み／書き込み時に必ずモーダルで「マクロ・図形・複数シート等は無視されます」と表示。
- ファイルサイズ 5MB を超える場合は拒否し、警告を表示。
- 解析に失敗したら既存状態を維持し、エラーメッセージをトースト表示。
- 自動保存は 10 秒ごとに Dirty の場合のみ実行。保存失敗時は silent。
- モバイル幅ではツールバーを折り返すレスポンシブ設定。

## 実装手順
1. `games/exceler.js` を新規作成し、UI 構築・状態管理・数式評価ロジック・XLSX 読み書き実装を行う。`fflate` のミニファイバージョンを同梱し、ZIP 解凍/圧縮に利用する。
2. `games/manifest.json.js` にエクセラーを追加（カテゴリ: ユーティリティ）。
3. 互換性警告モーダル・スライドパネルはモジュール内に実装。汎用 HUD API（`window.showTransientPopupAt` など）があれば利用。
4. 操作デバッグ（インポート/エクスポート/数式評価/書式設定/Undo Redo）を行い、既存ユーティリティと干渉しないことを確認。
5. 必要に応じて軽微な共通スタイル（フォーカスリングなど）を `style.css` へ追加。ただし基本はモジュール内の inline style で完結させる。

