<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ミニゲーム: 音楽プレイヤー</title>
    <link rel="stylesheet" href="../manual.css">
</head>
<body>
    <main>
        <h1>ミニゲーム: 音楽プレイヤー</h1>
        <p>
            「ミュージックプレイヤー」は、ローカルの音声ファイルを取り込み、プレイリスト管理・再生・視覚化・イコライザー調整を一体化したユーティリティです。
            IndexedDB に音源データを保存し、UI の状態は localStorage に保持されるため、ブラウザを閉じてもライブラリと設定が維持されます。
        </p>

        <section>
            <h2>前提条件と制限</h2>
            <ul>
                <li>Web Audio API と IndexedDB が利用可能なブラウザが必要です。</li>
                <li>取り込みできるファイルは <code>audio/*</code> の MIME タイプに限られます。</li>
                <li>1 ファイルあたりの最大サイズは 12&nbsp;MB、ライブラリの登録上限は 32 曲です。</li>
                <li>初回再生時に AudioContext を生成するため、ユーザー操作が必要です。自動再生は行いません。</li>
            </ul>
        </section>

        <section>
            <h2>画面構成</h2>
            <dl class="feature-list">
                <dt>ヘッダー</dt>
                <dd>
                    現在の再生曲名と長さを表示します。曲が未選択の場合はアプリの説明に切り替わります。
                    右側には「音源を追加」ボタン（複数ファイル選択可）と設定メニュー (⚙) が並びます。
                </dd>
                <dt>プレイリストパネル</dt>
                <dd>
                    曲数の統計、検索ボックス、曲一覧を備えています。各曲カードには再生・移動・削除ボタンと、長さとファイルサイズが表示されます。
                </dd>
                <dt>再生コントロール</dt>
                <dd>
                    前 / 再生・一時停止 / 停止 / 次 のボタン、経過時間・残り時間付きのシークバー、音量 (0〜100%) と再生速度 (0.5〜2.0 倍) スライダーを備えています。
                </dd>
                <dt>ビジュアライザー</dt>
                <dd>
                    オシロスコープ (波形) と周波数スペクトラム (ピーク表示付き) をリアルタイム描画します。</dd>
                <dt>イコライザーパネル</dt>
                <dd>
                    6 バンド (60Hz, 170Hz, 350Hz, 1kHz, 3.5kHz, 10kHz) のゲイン調整とプリセット選択を行います。</dd>
                <dt>ステータスバー</dt>
                <dd>曲数・合計再生時間・セッション EXP を表示します。</dd>
            </dl>
        </section>

        <section>
            <h2>音源の取り込み</h2>
            <ol>
                <li>ヘッダーの「音源を追加」をクリックし、取り込みたいファイルを選択します。</li>
                <li>選択したファイルのうち、音声形式かつサイズ制限と曲数上限を満たすものだけが登録されます。</li>
                <li>登録後は自動的に IndexedDB (<code>mini_music_player_db</code>) に保存され、曲リストに追加されます。</li>
            </ol>
            <p class="note">新しく追加された曲は、メタデータが取得でき次第、長さ情報が自動で更新されます。</p>
        </section>

        <section>
            <h2>プレイリスト管理</h2>
            <ul>
                <li>曲カードをクリックすると選択・再生します。再生中カードはハイライトされます。</li>
                <li>検索ボックスで部分一致検索が可能です (元のファイル名 / 「名称未設定」のローカライズ名を対象)。</li>
                <li>カード右端の <span class="ui-button">▶</span> / <span class="ui-button">↑</span> / <span class="ui-button">↓</span> / <span class="ui-button">✕</span> ボタンで再生・順番移動・削除を行います。</li>
                <li>曲名をダブルクリックするとリネームダイアログが開き、160 文字まで変更できます。</li>
                <li>設定メニューの「ライブラリを全削除」で全曲を一括削除できます (確認ダイアログあり)。</li>
            </ul>
        </section>

        <section>
            <h2>再生操作</h2>
            <ul>
                <li>再生中はシークバーがリアルタイム更新され、経過時間と残り時間が表示されます。バーをドラッグしてシークできます。</li>
                <li>音量スライダーは 0〜1 を 0.01 刻みで調整し、ブラウザのマスターボリュームとは独立します。</li>
                <li>再生速度は 0.5〜2.0 倍を 0.05 刻みで変更できます。速度変更は永続化され、次回起動時にも引き継がれます。</li>
                <li>終了時の挙動はループモードとシャッフル設定に従います。<br>
                    ループなし: 最後の曲で停止／<br>
                    1曲リピート: 現在の曲を最初から再生／<br>
                    全曲リピート: 次の曲に移動し、末尾では先頭へ戻ります。</li>
                <li>シャッフル再生を有効にすると、現在の曲以外からランダムに次曲が選ばれます。</li>
            </ul>
        </section>

        <section>
            <h2>イコライザーとプリセット</h2>
            <ul>
                <li>各バンドは -12〜+12 dB を 0.5 dB 刻みで調整できます。変更するとプリセットは自動的に「カスタム」に切り替わります。</li>
                <li>利用可能なプリセットは「フラット」「ロック」「ボーカル」「低音強調」です。選択すると各バンドが即座に設定されます。</li>
                <li>プリセット選択は 30 秒ごとに EXP を獲得できます (詳細は後述)。</li>
            </ul>
        </section>

        <section>
            <h2>ビジュアライザー</h2>
            <p>
                再生中のみ波形と周波数スペクトラムが更新されます。再生停止または AudioContext が停止すると描画も停止します。
                スペクトラムには直近のピーク値がラインとして表示されます。
            </p>
        </section>

        <section>
            <h2>EXP 獲得ルール</h2>
            <table>
                <thead>
                    <tr><th>アクション</th><th>獲得量</th><th>備考</th></tr>
                </thead>
                <tbody>
                    <tr><td>アプリを開く</td><td>+5</td><td>初期化完了時に加算</td></tr>
                    <tr><td>初めて再生を開始</td><td>+2</td><td>セッション中 1 度のみ</td></tr>
                    <tr><td>音源を取り込む</td><td>+3</td><td>曲ごとに付与</td></tr>
                    <tr><td>曲を最後まで再生</td><td>+10</td><td>ループ再生にも適用</td></tr>
                    <tr><td>EQ プリセットを適用</td><td>+1</td><td>30 秒クールダウンあり</td></tr>
                </tbody>
            </table>
            <p>獲得した EXP はセッションごとに集計され、画面下部の「Session EXP」に表示されます。</p>
        </section>

        <section>
            <h2>データ保存と同期</h2>
            <ul>
                <li>音源ファイルとメタ情報は IndexedDB (<code>mini_music_player_db</code> / <code>tracks</code> ストア) に保存されます。</li>
                <li>プレイリスト順序、現在位置、音量・速度・EQ 設定、ループ／シャッフルの状態は <code>localStorage['mini_music_player_state_v1']</code> に保存されます。</li>
                <li>保存は 0.5 秒単位でデバウンスされ、再生位置や設定が更新されたタイミングで書き込まれます。</li>
                <li>ライブラリを手動で全削除すると IndexedDB のデータもクリアされます。</li>
            </ul>
        </section>

        <section>
            <h2>トラブルシューティング</h2>
            <ul>
                <li>AudioContext の初期化に失敗した場合は、ブラウザの設定やタブのアクティブ状態を確認し、再度再生操作を行ってください。</li>
                <li>ファイルサイズ超過や曲数上限に達した場合はトースト通知で知らせます。不要な曲を削除してから再試行してください。</li>
                <li>IndexedDB の読み込みに失敗した場合は、ページの再読み込みやブラウザのストレージ設定の見直しを検討してください。</li>
                <li>トラックの読み込み失敗が続く場合は、当該ファイルを一度削除して再度取り込み直してください。</li>
            </ul>
        </section>
    </main>
</body>
</html>
