# ギャンブルミニゲームの設計

## 目的
- ミニゲー経験タブに「ギャンブル」カテゴリを新設し、プレイヤーがEXPを賭けて遊べる要素を追加する。
- ルーレットとパチンコスロットの2種の遊びを1つのMOD内に収録し、ベット結果に応じてEXPが増減する仕組みを実現する。
- EXPの増減は既存プレイヤーステータスと即時連動し、ミニゲームHUD・記録へも反映される。

## 概要
- MOD ID: `gamble_hall`
- 名称: ギャンブルホール
- カテゴリ: `ギャンブル`
- 収録ミニゲーム:
  - 「ルーレットラウンジ」: ヨーロピアン（0〜11）をベースにした簡易ルーレット。赤/黒/緑・偶奇・単数ベットに対応。
  - 「パチンコスロット」: 3リールスロット。シンボル揃いで倍率配当、ハズレでベット没収。
- ベットはプレイヤーEXP（現在レベルの進行度分）から消費し、勝利時は倍率に応じたEXPを付与する。
- EXP消費時は0未満にしない。利用可能量を超えるベットは自動的に抑制し、実際に消費できた分だけを差し引く。

## EXP処理仕様
- 既存の `awardXp` パイプを拡張し、負数を渡した場合はEXPを消費する挙動を追加。
- 新規ヘルパ `spendExp(amount, opts)` を導入し、プレイヤーEXPから指定量を減算（レベルダウンは行わず、0で打ち止め）。
- ミニゲームHUDや記録(`totalExpEarned`)は純増減（マイナス値含む）で集計。
- ポップ表示は獲得時=緑、消費時=赤で表現する。

## UI設計
### 共通
- 上部ヘッダ: 利用可能EXP、現在のベット額入力、クイックボタン（+10/+50/MAX）、セッション収支表示。
- ゲーム切り替えタブ: 「ルーレット」「パチンコスロット」をボタンで切り替え。
- 下部に直近履歴リストとメッセージ表示。

### ルーレットラウンジ
- ベットタイプ選択: ラジオボタン（赤/黒/緑、偶数/奇数、特定番号）。番号指定時はセレクトボックス入力。
- 「スピン」ボタン押下でベット消費→結果抽選→配当計算→メッセージ表示。
- 結果パネル: 当選番号と色を表示。簡易的な円盤アニメ（CSSトランジション）で演出。
- 配当倍率:
  - 単数番号一致: 12x
  - 色一致（赤/黒）: 2x
  - 緑指定で0: 14x
  - 偶数・奇数: 2x
  - ハズレ: 0x（ベット没収）

### パチンコスロット
- 3リール表示: CSSでリール枠とシンボル表示。
- 「スタート」ボタン押下でベット消費→1.2秒程度のリール停止演出→結果判定。
- 配当テーブル（倍率）:
  - 7 7 7: 18x
  - BAR BAR BAR: 12x
  - 任意同一3個: 9x
  - 任意同一2個 + スター: 4x
  - 任意同一2個: 2x
  - その他: 0x
- リザルト: 獲得EXP／損失EXPをメッセージと履歴に反映。

## セッション情報
- `state.netExp`: セッション純増減。
- `state.biggestWin`: 単一配当の最大値。
- `state.history`: 直近結果5件（ベット額・ゲーム種別・結果・純増減）。
- `getScore()`: セッション最大配当（`biggestWin`）を返却し記録カードに反映。

## 実装タスクリスト
1. EXP負数処理の導入
   - `main.js` に `spendExp` と負数対応の `awardXpFromMini`、`showMiniExpBadge` の拡張を実装。
   - HUD/記録更新処理を負数でも動作するよう調整。
   - MiniExp HUD の損失バッジ色は JS 側でインラインスタイル適用（`style.css` には追加しない）。
2. ギャンブルホールMODの実装
   - `games/gamble_hall.js` を新規作成し、上記UIとロジックを実装。
   - `window.registerMiniGame` で登録。
3. マニフェスト更新
   - `games/manifest.json.js` に `gamble_hall` をカテゴリ「ギャンブル」として追加。
4. ドキュメント更新
   - 本設計書をリポジトリに追加。

## 今後の拡張余地
- レベルダウンを伴う本格的なEXP残高管理（総経験値を扱う財布化）。
- 追加ギャンブルゲーム（ビンゴ、ハイロー、競馬風など）。
- ミニゲーム内での演出強化（音声、リールスプライト、ルーレットSVGなど）。
- 純利益ランキングや連勝数などの記録指標追加。
