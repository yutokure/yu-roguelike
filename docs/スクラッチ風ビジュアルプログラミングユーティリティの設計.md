# スクラッチ風ビジュアルプログラミングユーティリティの設計

MiniExp MOD のユーティリティカテゴリに、Scratch ライクなブロック組み立て型プログラミング環境「ブロックコードラボ」を追加する設計。視覚的なコード編集と安全なサンドボックス実行を提供し、ミニゲーム制作の学習や簡易自動化に活用できるようにする。

- ID: `blockcode`
- 表示名: ブロックコードラボ
- エントリ: `games/blockcode.js`
- バージョン: 0.1.0
- カテゴリ: ユーティリティ
- 目的: ブロック組み合わせでロジックを構築し、MiniExp 内のミニゲーム API を安全に操作するためのビジュアルプログラミングツールを提供する。

## 画面レイアウト
1. **メインウィンドウ**: 左ヘッダーにアプリ名と現在のプロジェクト名、右側に「新規」「保存」「読み込み」「共有コード」「実行」「停止」のボタン。ヘッダー下に XP バッジとサンドボックス状態表示を配置。
2. **ライブラリパネル** (左 240px 固定): カテゴリタブ（制御、アクション、変数、イベント、関数、ユーティリティ）を縦並びボタンとして配置。選択カテゴリに応じてブロックリストがスクロール表示され、ドラッグでキャンバスへ追加。
3. **キャンバス** (中央): 無限スクロールのグリッド背景。ドラッグ&ドロップでブロックを接続でき、ズームスライダー（50%〜200%）を右下に表示。右クリックでコンテキストメニュー（複製・削除・コメント・折りたたみ）。
4. **ステージプレビュー** (右 320px): 実行時に生成されるサンドボックスの状態を Canvas で表示。停止中はヒントカード（「ブロックを組み立てて実行」）を見せる。下部にロギングタブ（標準出力と警告）と変数ウォッチタブをタブ切り替えで表示。
5. **下部ツールバー**: Undo/Redo、ズームリセット、スナップ（ON/OFF）、グリッド表示切替、実行速度スライダー（0.25x〜3x）を並べる。

## ブロック仕様
- ブロック構造は `Block = { id, type, category, inputs, next, child, comment?, collapsed?, position }`。
- ブロックは以下のタイプに分類:
  - **ハットブロック**: イベント発火 (`whenGameStarts`, `whenKeyPressed`, `whenTimer`, `whenCollide`)
  - **ステートメントブロック**: `move`, `spawn`, `playSound`, `setVariable`, `broadcast`, `wait`, `if`, `repeat`, `repeatUntil`, `forever`, `stop`, `callFunction` など。
  - **値ブロック**: 数値、文字列、乱数、ゲーム状態、変数取得、関数入力など。
  - **演算ブロック**: 加減乗除、比較、論理、モジュロ、文字列結合。
- 入力ソケットは `inputs: { [name]: { type: 'number' | 'string' | 'boolean' | 'color' | 'sound' | 'block', accepts: [...] } }` で型制約を定義。
- 変数・関数はプロジェクトスコープで動的に生成され、メニューに反映。
- ブロックデータは JSON 形式で `project.blocks` に保存し、並列接続とネストを `next` と `child` ポインタで表現。

## プロジェクトデータ構造
```
Project = {
  id: string,
  name: string,
  createdAt: number,
  updatedAt: number,
  blocks: Block[],
  variables: { id, name, type: 'number' | 'string' | 'boolean', initialValue }[],
  lists: { id, name, values: any[] }[],
  functions: { id, name, args: { id, name, type }[], warp: boolean, description? }[],
  assets: { sounds: SoundAsset[], sprites: SpriteAsset[] },
  settings: { stageBg: string, gridSnap: boolean, executionSpeed: number },
  metadata: { description: string, tags: string[], sharedCode?: string }
}
```
- サンドボックス保存は `localStorage['blockcode_projects_v1']` に最近 10 件まで。
- 共有コードは LZ-string 圧縮 + Base64 化した JSON を URL フラグメントで配布。

## サンドボックス実行
- 実行時にプロジェクトから抽象構文木 (AST) を生成し、`sandboxWorker.js` (Web Worker) に送信。
- Worker 内でイベントループとタイマーを管理し、MiniExp API のサンドボックス版を提供。
  - 許可 API: `spawnEntity`, `setTile`, `playSound`, `showDialog`, `awardXp`, `log`, `getPlayerState` の安全ラッパー。
  - 不許可 API は Proxy で拒否し、警告ログに「未対応 API」が表示される。
- Worker からメインスレッドへは `postMessage({ type: 'state', stage })` で Canvas レンダリングデータ、`postMessage({ type: 'log', level, message })` でログ、`postMessage({ type: 'error', stack })` で例外通知。
- 実行速度は Worker 側で `stepDelay = 1000 / (speedFactor * 60)` として調整。
- 無限ループ検知: 1 秒あたりのステップ数上限を設け、超過時に自動停止 + 警告。
- サンドボックスは 5 秒ごとのハートビートでメインスレッドから監視し、応答がない場合はリセット。

## エクスポート/インポート
- プロジェクトファイルを JSON (`.mexpbc`) 形式で出力。`version` フィールドで互換管理。
- 他ユーザの共有コードを URL フラグメントまたはテキスト入力で取り込み、検証してからロード。
- MiniExp 既存の「プロジェクト共有」API があれば連携し、著作権表示等のメタデータを付与。

## UI インタラクション
- ブロックドラッグ中はスナップラインと接続候補ハイライトを表示。
- キーボードショートカット: Ctrl+S (保存), Ctrl+O (読み込み), Ctrl+Z/Ctrl+Y, Delete, Space (パン), Ctrl+マウスホイール (ズーム)。
- ブロックコメントは吹き出し表示。折りたたみ時はアイコンのみ表示。
- 変数・リスト作成ダイアログはサイドバー上部に配置し、データ型選択と初期値入力を必須にする。
- 実行中はブロックがハイライトされ、現在ステップを視覚的に追える。

## XP 仕様
- アプリ起動で `awardXp(5, { type: 'open' })`。
- 実行成功時に `awardXp(8, { type: 'run' })`。
- 新規ブロック作成 5 個ごとに `awardXp(2, { type: 'build' })`。
- 共有コード生成時に `awardXp(10, { type: 'share' })`。
- XP 累計はヘッダー横のバッジに表示し、`getScore()` で返却。

## セキュリティ・ガード
- Worker へ渡すデータは構造体を検証し、未知フィールドは除去。
- 実行開始時にタイムアウト 15 秒を設定し、停止または完了で解除。
- `eval` や `Function` コンストラクタは使用禁止。生成コードはインタプリタで逐次実行。
- ローカルストレージ容量が 8MB を超える場合は保存を制限し、警告モーダルを表示。
- 共有コード読み込み時は署名なしのコードとして扱い、MiniExp ネットワーク機能と連携しない。

## 実装手順
1. `games/blockcode.js` を新規実装し、UI レイアウト（ライブラリ/キャンバス/プレビュー）と状態管理を構築。ドラッグアンドドロップはカスタムフックで実装。
2. ブロック定義データは `blockdata.js` に登録し、カテゴリ/ブロック名/入力仕様を追加。必要であれば `blockdata.json` も更新。
3. サンドボックス実行用に `games/blockcode-worker.js` を新規追加し、AST インタプリタと MiniExp API ラッパーを実装。
4. `games/manifest.json.js` にブロックコードラボを登録（カテゴリ: ユーティリティ、アイコン: `tools/blockcode.svg` などを追加）。
5. UI スタイルを `style.css` で最小限補完（カスタムスクロール、カード影など）。既存スタイルとの競合を避けるため BEM 風クラス名を使用。
6. 保存/読み込み/共有コードの検証フローを実装し、エラー時はトースト通知。Worker 終了時のリソースクリーンアップを忘れずに行う。
7. 組み合わせテストを実施し、既存ミニゲームとの干渉がないことを確認。サンドボックス API の権限漏れがないかレビューする。
