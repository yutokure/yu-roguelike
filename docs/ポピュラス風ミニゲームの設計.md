# ポピュラス風ミニゲームの設計

本設計は「ミニゲームAPI書（MiniExp MOD API v0.3）」準拠。神となり地形を整え信者を繁栄させ、制限時間内に人口目標を満たすリアルタイムシミュレーション。地形整備や信者増加に応じてEXPを付与する。

- ID: `populite`
- 表示名: ポピュラス風
- エントリ: `games/populite.js`
- バージョン: 0.1.0
- カテゴリ: シミュレーション / ストラテジー

## ゲーム概要
- マップは 18×18 の高さ付きグリッド。各タイルは高さ0〜5、海面は高さ0。
- プレイヤーは「整地パワー」を使ってタイルの高さを上下させ、信者が家を建てられる平地（同じ高さが3×3）を確保する。
- 一定間隔で信者が出現し、隣接タイルに伝播。家レベルが上がると信仰力が蓄積し、魔法（火山・津波）を発動して敵部族を排除できる。
- 今回のミニゲーム版では敵は自動的に出現する災害波（津波/火山）として抽象化し、時間経過で信者を散らす。プレイヤーは地形調整で被害を抑え、人口を維持する。
- 目標人口を制限時間内に到達すると勝利、人口が0になるか時間切れで敗北。

## ルール/操作
- マウス左ドラッグ: ドラッグ範囲内タイルを整地。ドラッグ方向に応じて高さを+1/-1（Shift押下で反転）。整地にはマナ（信仰力）を1消費。
- マウス右クリック: 選択タイルに「クールダウン付きの祈り」(信者生成)。マナ10消費。生成待機列が満のときは使用不可。
- スペースキー: 一時停止/再開。
- 数字キー 1〜3: マナが条件を満たすと魔法発動。
  - 1: 「守護バリア」（一定範囲の家を10秒無敵）— マナ30。
  - 2: 「隆起」(3×3範囲を+2し海面から護る) — マナ40。
  - 3: 「浄化雨」（災害カウントリセット） — マナ50。

## パラメータ
- 制限時間: 180秒（NORMAL）。EASYは210秒、HARDは150秒。
- 初期マナ: 40。
- マナ回復: 信者1人ごとに +0.5/秒。家レベル2で +1/秒、レベル3で +2/秒。
- 災害波: 30秒ごとに発生（EASYは40秒、HARDは25秒）。津波=辺境低地を高さ0に、火山=ランダム1マス高さ+3＆周囲に炎ダメージ。
- 人口目標: EASY 80人、NORMAL 120人、HARD 160人。

## 信者と建築
- 信者は整地済みの3×3平地に自動生成され、最大5人で家を建てる。
- 家は3段階（草葺き → 木造 → 石造）。各段階で必要平地レベルが+1される（高さ1/2/3）。
- 家が災害で壊れると信者が散り人口減少。整地し直すと再建が進む。

## 難易度差分
- EASY: 初期平地が多く、災害速度低。マナ回復+20%。
- NORMAL: 基本設定。
- HARD: 整地コスト+1、災害頻度高、災害範囲が+1マス拡大。マナ回復-15%。

## EXP仕様
- 整地成功（高さ差1以内で平地化）: +0.3 EXP。
- 信者が家を建築完了: レベル1 +1 EXP、レベル2 +2 EXP、レベル3 +3 EXP。
- 人口が10人増えるごとに +5 EXP（新記録時のみ）。
- 目標人口達成で +150 EXP ボーナス。時間残が30秒以上なら追加で +30 EXP。
- 付与タイミング: イベント発生フレームで `awardXp(value,{type:'event',event:'buildLvX'})` 等を呼び出す。

## スコア/記録
- `getScore()` は最終人口を返す。ホストが `bestScore` として保存。
- 追加で内部ハイスコア（最速達成時間）をlocalStorageに保持（キー: `mini_populite_bestTime`）。

## UI/演出
- 画面左: マナゲージ、人口、目標人口、残り時間。
- 画面右: 魔法ボタン（ホバーで説明）、災害タイマー。
- 中央: キャンバスに地形/信者/家を描画。高さは等角投影風のシェーディング。
- イベント時に `window.showTransientPopupAt` で `+EXP` バッジと人口変化を表示。
- 災害発生時は画面フラッシュと `window.playSfx?.('damage')` を使用。

## 実装方針（API連携）
- `create(root, awardXp, opts)`:
  - Canvas(512×512) と UI HUD (`div.stats`) を生成して `root` に追加。`ResizeObserver` でスケール調整。
  - ゲーム状態を `state` オブジェクトに保持（マップ配列、信者リスト、家オブジェクト、マナ、タイマー）。
  - 入力: `pointerdown/move/up` で整地操作、`contextmenu` 無効化。キーボードで魔法/ポーズ。
  - `opts.shortcuts` で `['Space']` を disable し、独自に処理。`stop()` 時に `reset()`。
- ループ: `requestAnimationFrame` で `update(dt)` → `render()`。
  - `update` 内でマナ回復、災害タイマー減算、信者生成、家レベルアップ処理、災害演出を実行。
- EXP付与: 各処理で `awardXp()` を呼ぶ。ボーナス達成時は重複防止フラグを保持。
- `start()`: ループ開始、ポインタイベント有効化。
- `stop()`: ループ停止、イベント無効化、魔法クールダウンの時間計測も停止。
- `destroy()`: `stop()` 呼び出し後に DOM/リスナー/タイマーを完全削除。`ResizeObserver` 解除。

## データ構造
- `tiles`: `Uint8Array(18*18)` で高さを保持。
- `settlements`: 各平地ブロックの状態 `{x,y,level,population,progress}`。
- `followers`: モブ単位の移動を簡略化し、目標平地へ吸い込まれる粒子エフェクトで表現。人口カウントは数値のみ。
- `disasters`: 発生中エフェクトのタイムライン。

## 敵/障害
- 津波: 低地タイル(高さ<=1)を高さ0へ、家を破壊。整地で再建可能。
- 火山: ランダムタイル高さ+3し、周囲に炎ダメージ。炎に触れた家は1段階ダウン。
- バリア魔法は一時的に家の損害を無効化する。

## エラー/ガード
- 整地対象が海（高さ0以下）の場合は下げ処理無効。高さ上限5を超えないよう clamp。
- マナ不足時は操作無効＆HUDに「マナ不足」ポップを表示。
- `opts.player` が存在すれば、目標達成時に `opts.player.awardItems({ holyShard:1 })` を試みる（戻り値が0のときはログのみ）。
- `localStorage` 例外は try/catch で握り、失敗しても進行継続。

## マニフェスト例
```json
{ "id": "populite", "name": "ポピュラス風", "entry": "games/populite.js", "version": "0.1.0", "category": ["シミュレーション", "ストラテジー"], "description": "整地と信仰で人口目標を達成せよ" }
```
