# ミニゲー経験の設計

本ドキュメントは、選択画面に新規タブ「ミニゲー経験」を追加し、いくつかのミニゲームを通じてプレイヤーの経験値（EXP）とレベルのみを成長させる仕組みの詳細設計です。ダンジョン（通常/ブロック次元）とは独立したコンテンツで、取得EXPはプレイヤーと一体化し、そのまま探索に持ち込み可能です。

## 目的 / 要件

- 目的: 戦闘外でも短時間で「遊んで育成」できる導線を提供し、継続モチベーションを高める。
- 範囲: ダンジョン進行・アイテム・敵生成に影響を与えない。影響するのはプレイヤーの `exp` と `level`、および付随する基礎ステータスのみ。
- 互換性: 既存のセーブデータ（`roguelike_save_v1`）と完全互換。新規フィールドは追加読み書きで共存。
- 侵襲度: `index.html` にタブを1つ追加、`main.js` にXP付与の共通APIとタブ切替・モジュラブルなミニゲームホストのみを追加する方針。
- アクセシビリティ: 既存タブ同様、`role="tablist"/role="tabpanel"` と `aria-selected` を付与。

## 用語

- ミニゲー経験タブ: 選択画面の3つ目のタブ。小型ゲームの一覧とプレイ領域を持つ。
- ミニゲームモジュール: 共通インターフェースに従ってホストにマウントされる独立部品（Othello/Snake/Breakout/Pong/Same/Match3 等）。
- EXP付与イベント: ミニゲーム内からホストへ「XPをN付与して」と伝えるコールバック。

## UI 仕様

### タブ追加（index.html）

- 既存: `通常` / `ブロック次元`
- 追加: `ミニゲー経験`

```html
<!-- タブボタン（既存の直後） -->
<button id="tab-button-miniexp" class="tab-button" role="tab" aria-selected="false" aria-controls="tab-miniexp">ミニゲー経験</button>

<!-- タブパネル（選択カード内、他タブと同階層） -->
<div id="tab-miniexp" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="tab-button-miniexp">
  <div class="row">
    <div class="miniexp-layout">
      <div class="miniexp-list" role="listbox" aria-label="ミニゲーム一覧" tabindex="0" id="miniexp-list"></div>
      <div class="miniexp-panel">
        <div class="miniexp-toolbar">
          <label>難易度</label>
          <select id="miniexp-difficulty">
            <option value="EASY">EASY</option>
            <option value="NORMAL" selected>NORMAL</option>
            <option value="HARD">HARD</option>
          </select>
          <button id="miniexp-start">開始</button>
          <button id="miniexp-quit" disabled>終了</button>
        </div>
        <!-- ミニゲームの描画領域 -->
        <div id="miniexp-container" class="miniexp-container" aria-live="polite"></div>
        <!-- XPポップ/HUD用オーバーレイ（ゲーム上に重ねる） -->
        <div id="miniexp-hud" class="miniexp-hud" aria-live="polite"></div>
        <!-- 常時表示のプレイヤーHUD（レベル/EXPをリアルタイム表示） -->
        <div id="miniexp-player-hud" class="miniexp-player-hud" aria-live="polite">
          <div class="mini-stat-line"><span>Lv</span><span id="miniexp-hud-level">1</span></div>
          <div class="mini-bar exp">
            <div class="mini-bar-label">EXP <span id="miniexp-hud-exp-text">0/1000</span></div>
            <div class="mini-bar-track"><div id="miniexp-exp-bar" class="mini-bar-fill"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="miniexp-records" id="miniexp-records" aria-live="polite"></div>
  </div>
  <div class="row">
    <div class="miniexp-tips">
      <p>獲得EXPは即時プレイヤーに加算されます。ミニゲームの途中でも付与される場合があります。</p>
    </div>
  </div>
  <!-- 初回ロードやミニゲーム未選択時のプレースホルダはJSで描画 -->
  </div>
```

#### スタイル（style.css 追加方針）

- `.miniexp-layout`: 2カラム（左=一覧 260px 固定、右=プレイ領域 flex）
- `.miniexp-container`: 600x400 目安のキャンバス/DOM領域（レスポンシブ）
- `.miniexp-hud`: 獲得EXPの一時的バッジ表示（コンテナに重ね、右上固定）
- `.miniexp-player-hud`: 常時表示の小型ステータス（右上固定、ゲーム中も一覧でも常に見える）
  - `position:absolute` で `miniexp-panel` の右上にピン留め、半透明カード、影、小さめのEXPバー。
  - 既存EXPバーに準拠した `.mini-bar`/`.mini-bar-fill`/`.mini-bar-label` を使用。

### タブ切り替え（main.js）

- 既存 `setupTabs()` に以下を追加:
  - `tab-button-miniexp` / `tab-miniexp` の表示切替
  - 初回クリックで `initMiniExpUI()` を Lazy 初期化
  - 終了時は進行中のミニゲームがあれば `stop()` して後始末

### リアルタイム表示要件（本要件の反映）
- ミニゲー経験タブ配下の全画面（一覧・プレイ中・記録表示）で、プレイヤーの「レベル」「EXP（数値/バー）」を常時表示する。
  - UI要素: `#miniexp-player-hud`（Lv表示、EXPバー、EXPテキスト）。
  - 値更新: `updateUI()` または `renderMiniExpPlayerHud()` により `player.level` と `player.exp/1000` を即時反映。
  - バー演出: 既存EXPバー同様の幅アニメーション（~250ms）。
- EXP獲得時（例: オセロで石反転）には `#miniexp-hud` 上へ「+N EXP」バッジを即時表示・自動フェード。
  - 表示粒度: 既定は「1アクションで合計値を1回表示」。オプションでイベント単位の細粒度表示も可（ゲーム側が `awardXp` を複数回呼ぶ）。
  - スパム抑制: 200ms 窓で同種XPを合算（UI上は1つのバッジにまとめる）。
  - アクセシビリティ: `aria-live="polite"` でXP変動を読み上げ可能にし、視覚に頼らない伝達を担保。

## データモデル

### 既存 Player との関係

- 取得EXPは `player.exp` に直接加算（1000到達でレベルアップ）。
- 小数のEXP（例: ×0.5）は「内部保持OK、表示は整数丸め（floor）」とするのが自然。
  - 実装案: 表示時のみ `Math.floor(player.exp)`、レベルアップ判定はそのまま `>= 1000`。

### 追加型（擬似TS）

```ts
type MiniGameId = 'othello'|'snake'|'breakout'|'pong'|'same'|'match3'|string; // 将来拡張

type MiniGameRecord = {
  id: MiniGameId;
  bestScore?: number;      // 例: 最大連鎖、最高スコア
  totalPlays?: number;     // 通算プレイ回数
  totalExpEarned?: number; // 通算獲得EXP
  lastPlayedAt?: number;   // epoch ms
};

type MiniExpState = {
  selected?: MiniGameId;
  difficulty?: 'EASY'|'NORMAL'|'HARD';
  records: Record<MiniGameId, MiniGameRecord>;
};
```

### 永続化

- 既存 `saveAll()` に `miniExp` を追加保存。

```js
localStorage.setItem('roguelike_save_v1', JSON.stringify({
  // 既存...
  miniExp: {
    selected: miniExpState.selected || null,
    difficulty: miniExpState.difficulty || 'NORMAL',
    records: miniExpState.records || {}
  }
}));
```

- ロード時は `miniExpState` を復元（存在しなければデフォルト生成）。

## EXP 付与の共通API

### 新設: `grantExp(amount, opts)`

```js
function grantExp(amount, opts={ source:'misc', reason:'', popup:true }) {
  const v = Math.max(0, Number(amount)||0);
  if (v <= 0) return 0;
  player.exp += v;
  let leveled = 0;
  while (player.exp >= 1000) {
    player.exp -= 1000;
    player.level += 1;
    player.maxHp += 5; player.attack += 1; player.defense += 1; player.hp = player.maxHp;
    leveled++;
    showLevelUpPopup && showLevelUpPopup();
  }
  if (opts.popup) {
    addMessage && addMessage(`経験値を ${Math.floor(v)} 獲得！（${opts.source}${opts.reason?': '+opts.reason:''}）`);
    // ミニゲーHUDにもポップを流す（存在時）
    showMiniExpBadge && showMiniExpBadge(`+${Math.floor(v)} EXP`);
  }
  updateUI && updateUI();
  // ミニゲーの常時HUD（Lv/EXPバー）も更新
  renderMiniExpPlayerHud && renderMiniExpPlayerHud();
  saveAll && saveAll();
  return v;
}
```

- 既存 `grantExpFromEnemy()` は内部で `grantExp(gained,{source:'battle',reason:isBoss?'boss':''})` を呼ぶよう置換（互換維持）。
- ミニゲームは全てこのAPI経由で付与する。

## ミニゲームのインターフェース

```ts
interface MiniGame {
  id: MiniGameId;
  name: string;
  description?: string;
  create(root: HTMLElement, awardXp: (n:number, meta?:any)=>void, opts:{difficulty:'EASY'|'NORMAL'|'HARD'}): MiniGameRuntime;
}

interface MiniGameRuntime {
  start(): void;
  stop(): void;       // 破棄直前にも呼ばれる
  destroy(): void;    // DOM/イベント完全解放
  getScore?(): number;// 記録用途
}
```

### ホスト（main.js 側）

- `const miniGames: MiniGame[] = [othello, snake, breakout, pong, same, match3];`
- 一覧は `#miniexp-list` にボタンとして生成。選択で `miniExpState.selected` を更新。
- `開始` で `create()`→`start()`。`終了` で `stop()`→記録更新→`destroy()`→ホスト初期表示に戻る。
- XP付与は `awardXp = (n,meta)=>grantExp(n,{source:'mini',reason:currentGameId})`。
- 記録更新: `bestScore`/`totalPlays`/`totalExpEarned`/`lastPlayedAt` を更新し `saveAll()`。

## EXP獲得ルール（確定仕様）

各ゲームのルールは「ダンジョンに非依存」。難易度はゲームAIやスピードの操作で実現し、EXPテーブルは下記で固定。

1) オセロ（Othello）

- 行為: 自分の手で石をひっくり返したとき、`(ひっくり返した枚数) × 0.5` EXP を即時付与。
- 勝利ボーナス（対AI）:
  - EASY 勝利: +10 EXP
  - NORMAL 勝利: +150 EXP
  - HARD 勝利: +600 EXP
- 引き分け/敗北: 勝利ボーナスなし。途中の裏返しによるEXPはそのまま。
- AI:
  - EASY: 合法手からランダム。序盤角・辺優先しない。
  - NORMAL: 強欲（最大反転）+ 角/辺重み、1手先読む簡易評価。
  - HARD: 2〜3手先のミニマックス + 安定石/可動性/角/辺の重み評価。

2) スネーク（Snake）

- 行為: 餌を食べるごとに +1 EXP。
- 難易度: 移動速度（EASY=低速、NORMAL=中速、HARD=高速）。EXPは一定。

3) ブロック崩し（Breakout）

- 行為: ブロック破壊ごとに +1 EXP。
- 難易度: パドル幅/ボール速度/ライフ数（EASY=広/遅/多、HARD=狭/速/少）。

4) ピンポン（Pong）

- 行為: 対AIマッチに勝利するたびに EXP 付与。
  - EASY: +1 EXP
  - NORMAL: +5 EXP
  - HARD: +25 EXP
- マッチ形式: 「先取5点」推奨（UI表示）。失点やラリーはEXPに影響しない。

5) セイムゲーム（Same）

- 行為: 同色の連結ブロックを一気に消したとき、`(消した数) × 0.5` EXP。
- 難易度: 盤面サイズ/色数/新規落下の有無で制御。

6) マッチ3（Match-3）

- 行為: マッチ種類に応じて即時付与。
  - 3マッチ: +1 EXP
  - 4マッチ: +3 EXP
  - 5マッチ: +10 EXP
- 連鎖: 1連鎖ごとに 1.5 倍の乗数（例: 2連鎖→×1.5、3連鎖→×2.25）。小数は内部保持、表示は整数丸め。

## 提案: 追加ミニゲーム（拡張候補）

- 2048: 合成したタイル `2^k` の `k-1` を加点XP（例: 32→+4）。到達 1024/2048 でボーナス +50/+150。
- テトリス風（ライン消し）: 1/2/3/4ラインで +1/+3/+6/+12、連続消しで ×1.3 連鎖。
- モグラ叩き: ヒット +1、5連続ノーミス毎に +3 ボーナス。
- 神経衰弱: ペア成立 +2、連続成立で ×1.2。

## 実装方針（段階）

1) ホスト基盤

- `index.html` にタブ/パネル/コンテナ/ツールバー/一覧/記録領域を追加。
- `style.css` に `.miniexp-*` の基本スタイルを追加。
- `main.js`
  - `setupTabs()` に `ミニゲー経験` の切替を追加。
  - `initMiniExpUI()` を新設（一覧の生成、選択・開始・終了の制御）。
  - `grantExp()` を新設し、`grantExpFromEnemy()` を内部委譲に置換（後方互換）。
  - `miniExpState` のロード/セーブを `saveAll()` に統合。

2) ゲーム別モジュール（最小版）

- `games/` ディレクトリを作成し、各ミニゲームを1ファイル実装。
  - `games/othello.js`（8x8、合法手ハイライト、パス/終局判定）
  - `games/snake.js`（キャンバス/タイマー駆動）
  - `games/breakout.js`（キャンバス、パドル/ボール/ブロック）
  - `games/pong.js`（AIは反応遅延+速度差）
  - `games/same.js`（グリッド/フラッドフィル）
  - `games/match3.js`（スワップ/マッチ検出/落下/連鎖）
  - いずれも `create(root, awardXp, {difficulty})` をエクスポート。

3) 記録/HUD/演出

- `#miniexp-hud` に「+N EXP」バッジを短時間表示（既存 `playSfx('pickup')` 再利用）。
- `#miniexp-records` に各ゲームのベスト/通算を小カードで表示。

4) QA/テレメトリ（ローカル）

- 暗黙の同時実行禁止: 1つのミニゲームのみ起動可能にする。
- `visibilitychange` でタブが非表示になったときはポーズ（snake/pong/breakout）。
- パフォーマンス: requestAnimationFrame + 1/60sec 目安で `update/render` サイクル。

## 主要ロジック擬似コード

### initMiniExpUI()

```js
let miniExpState = { selected:null, difficulty:'NORMAL', records:{} };
let currentMini = null;

function initMiniExpUI() {
  const list = document.getElementById('miniexp-list');
  const container = document.getElementById('miniexp-container');
  const startBtn = document.getElementById('miniexp-start');
  const quitBtn = document.getElementById('miniexp-quit');
  const diffSel = document.getElementById('miniexp-difficulty');

  // 一覧生成
  const defs = [
    { id:'othello', name:'オセロ' },
    { id:'snake', name:'スネーク' },
    { id:'breakout', name:'ブロック崩し' },
    { id:'pong', name:'ピンポン' },
    { id:'same', name:'セイムゲーム' },
    { id:'match3', name:'マッチ3' },
  ];
  list.innerHTML = '';
  defs.forEach(d => {
    const b = document.createElement('button');
    b.textContent = d.name;
    b.setAttribute('role','option');
    b.addEventListener('click',()=>{ miniExpState.selected = d.id; renderMiniExpPlaceholder(); saveAll(); });
    list.appendChild(b);
  });

  function awardXp(n, meta) {
    playSfx && playSfx('pickup');
    const gained = grantExp(n, { source:'mini', reason: miniExpState.selected || '' });
    showMiniExpBadge(`+${Math.floor(gained)} EXP`);
    renderMiniExpPlayerHud();
  }

  startBtn.onclick = () => {
    if (!miniExpState.selected || currentMini) return;
    const mod = miniGameRegistry[miniExpState.selected];
    if (!mod) return;
    currentMini = mod.create(container, awardXp, { difficulty: diffSel.value });
    startBtn.disabled = true; quitBtn.disabled = false;
    currentMini.start();
  };
  quitBtn.onclick = () => {
    if (!currentMini) return;
    try { currentMini.stop(); } finally { currentMini.destroy && currentMini.destroy(); }
    currentMini = null; startBtn.disabled = false; quitBtn.disabled = true;
    renderMiniExpPlaceholder();
  };
}
```

### showMiniExpBadge()

```js
function showMiniExpBadge(text) {
  const hud = document.getElementById('miniexp-hud');
  if (!hud) return;
  const el = document.createElement('div');
  el.className = 'exp-badge';
  el.textContent = text;
  hud.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 1200);
}

// Lv/EXPの常時HUD描画
function renderMiniExpPlayerHud() {
  const lv = document.getElementById('miniexp-hud-level');
  const expText = document.getElementById('miniexp-hud-exp-text');
  const bar = document.getElementById('miniexp-exp-bar');
  if (!lv || !expText || !bar) return;
  const expMax = 1000;
  const exp = Math.max(0, player?.exp||0);
  lv.textContent = String(player?.level||1);
  expText.textContent = `${Math.floor(exp)}/${expMax}`;
  const pct = Math.max(0, Math.min(1, exp/expMax));
  bar.style.width = `${Math.round(pct*100)}%`;
}
```

## 既存コードへの統合ポイント

- `index.html`
  - タブボタン/パネル追加（IDは上記固定）。
- `style.css`
  - `.miniexp-*` の追加。`tabs`/`tab-content` は既存スタイルを流用。
- `main.js`
  - `setupTabs()` にミニゲー経験タブの分岐を追加。
  - `grantExp()` の追加と `grantExpFromEnemy()` の内部委譲化。
  - `miniExpState` のロード/セーブ（`saveAll()`/初期ロード部）。
  - `ensureAudio()` をミニゲーム開始時にも呼び、効果音を有効化。

## リスク / ガード

- 小数EXP表示ゆれ: 表示は整数丸めに統一（UIのみ）。
- タブ離脱時のリソースリーク: `stop()`/`destroy()` を必ず呼ぶ（イベント/タイマー解除）。
- キーバインド衝突: ゲーム画面の矢印抑止は `game-screen` 表示時のみ。ミニゲームは選択画面内なので干渉しないが、各ミニゲームは `preventDefault()` を適切に使用。
- セーブ肥大化: 記録は最小限（ベスト/通算）。プレイログは持たない。

## テスト計画（要点）

- 付与精度: オセロ1手での反転数を固定盤面で検証（例: 2/3/4反転 → +1/+1.5/+2）。
- レベルアップ: 1000到達と端数保持の両方を自動/手動で確認。
- パフォーマンス: Snake/Breakout/Pong で 60FPS 近傍を維持（中サイズCanvas）。
- 終了フロー: タブ切替/終了ボタン/SPA遷移でタイマー/イベントが残らないこと。

## 導入手順（サマリ）

1. `index.html` にタブ/パネル/コンテナを追加。
2. `style.css` に `.miniexp-*` を追加。
3. `main.js` に `grantExp()` とミニゲー経験タブの初期化/切替処理を追加。
4. `games/` 以下に各ミニゲームの最小実装を順次追加（Othello→Snake→Breakout→Pong→Same→Match-3 の順を推奨）。
5. 表示丸め/セーブ/ロード/効果音の動作を確認し、数値チューニング。

---

以上で、ミニゲームで獲得した経験値がそのままプレイヤー育成につながる「ミニゲー経験」機能を、既存UI/データモデルへ低侵襲に統合可能です。

## 付録: MOD形式での導入手順（簡易）

### 目的
ミニゲームをMODのように追加・配布・導入できる仕組みを提供します。基本は「games/ 配下にJSファイルを置き、manifestに追記」だけで一覧に出ます。

### ディレクトリ構成（例）
```
games/
  manifest.json
  othello.js
  snake.js
  breakout.js
  pong.js
  same.js
  match3.js
  assets/
    icons/
      othello.png
```

### manifest.json（例）
```json
[
  { "id": "othello",  "name": "オセロ",       "entry": "./othello.js",  "version": "0.1.0", "author": "you", "icon": "./assets/icons/othello.png", "description": "石をひっくり返してEXP" },
  { "id": "snake",    "name": "スネーク",     "entry": "./snake.js",    "version": "0.1.0", "author": "you", "description": "餌でEXP" }
]
```

### ホストの発見ロジック
1. `games/manifest.json` を `fetch` で読み込み、一覧に表示。
2. フォールバック: 失敗時は内蔵のサンプル定義（ドキュメント通りの6種）を表示。

### ランタイム登録（将来の拡張）
`games/index.js` を読み込ませ、`window.registerMiniGame(def)` を呼ぶ形でも登録可能にします（`file:`稼働対策）。現段階の一覧は `manifest.json` のみで十分です。

### MiniGameインターフェース（再掲）
```ts
interface MiniGame {
  id: string;
  name: string;
  description?: string;
  create(root: HTMLElement, awardXp: (n:number, meta?:any)=>void, opts:{difficulty:'EASY'|'NORMAL'|'HARD'}): MiniGameRuntime;
}
interface MiniGameRuntime { start(): void; stop(): void; destroy(): void; getScore?(): number; }
```

### 導入ステップ（MOD作者）
- JSファイルで `export function create(root, awardXp, opts){ ... }` を実装。
- `manifest.json` に `{ id, name, entry }` を1行追加。
- 難易度は `opts.difficulty` で受け取り、XPは `awardXp(n)` を呼ぶだけ。

### 一覧UI（今回の実装範囲）
- タブ: `ミニゲー経験` を追加。
- 左リスト: `manifest.json` を読み込み、ミニゲームの `name/description/version/author` をカードで表示。`選択` ボタンで `miniExpState.selected` を保存。
- 右パネル: 選択状態やガイド文を表示（起動・終了は後続実装）。
