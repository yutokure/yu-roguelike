# 3Dピンボール風ミニゲームの設計

本設計は「ミニゲームAPI書（MiniExp MOD API v0.1）」準拠。Windows XP 付属の 3D Pinball: Space Cadet をモチーフにしたトップダウン型ピンボール。各ギミックへのヒットやミッション進行で EXP を獲得します。

- ID: `pinball_3d`
- 表示名: 3Dピンボール風
- エントリ: `games/pinball-3d.js`
- バージョン: 0.1.0
- カテゴリ: テーブル/物理演算

## ルール/操作
- 左フリッパー: `A` / 左矢印。
- 右フリッパー: `D` / 右矢印。
- ショット（プランジャー）: `Space` 長押しでパワーをチャージ、離して発射。
- ポーズ: `Esc`。
- ボール 3 球制。落下で次ボール。全ボール喪失でゲーム終了。

## テーブル構成
- **プランジャーレーン**: 初期ショット専用。スキルショットターゲットに当たるとボーナス。
- **バンパー群**: 上部に 3 基配置（赤/青/黄）。
- **ランプ**: 左右に 2 本（オービット状）。
- **スリングショット**: フリッパー上の左右壁。
- **ミッションエリア**: 中央にターゲット 3 基とミッション表示。
- **フリッパー**: 左右 1 組。救済として右外周に「セイバーレーン」設置。

## 難易度設定
- EASY: ボール保存機能（初回アウトは戻す）、傾き（ティルト）判定無し、バンパー EXP 低下無し。
- NORMAL: 標準設定。傾き上限 3 回でティルト（フリッパー無効 3 秒）。
- HARD: ボールスピード 1.2 倍、ミッションタイマー短縮（20→15秒）、バンパー EXP 減衰あり、セイバーレーン無効。

## EXP 仕様
| ギミック | EXP | 備考 |
| --- | --- | --- |
| スキルショットターゲット | +120 | ラウンド開始後 5 秒以内のみ。失敗すると +20。 |
| バンパー（赤/青/黄） | +8 / +10 / +12 | 一定時間内に同色連続で当てると +50 ボーナス。HARD は連続 3 ヒットで +30。 |
| スリングショット | +4 | 左右共通。 |
| オービットランプ | +25 | 左右で別カウント。連続コンプリートで +100。 |
| ミッションターゲット | +30 | 3 基全点灯でミッション開始。 |
| ミッション完了 | +200～+400 | ミッション種類に応じて（以下参照）。 |
| セイバーレーン救済 | +60 | ボールアウト後即時戻す。HARD 無効。 |
| マルチボール開始 | +180 | EASY/NORMAL のみ。 |
| マルチボール中ジャックポット | +300 | マルチボール時のみ中央ホール。 |
| ボールアウト | +0 | 評価なし。 |

- EXP 付与は `awardXp(value, { source: 'pinball', event: 'bumper', detail: 'red' })` のようにタイプ情報を付与。
- 同一イベント内で複数ヒットが発生する場合（例: バンパー連鎖）は合算後 1 回で通知。
- ミッションタイマー切れ時は失敗扱い（EXP 付与なし）。

## ミッション（モード）
1. **ランプランデブー**: 左右ランプを指定回数（3）通す。達成で +200 EXP。
2. **バンパーブースト**: 指定色（ランダム）を 5 回ヒット。達成で +220 EXP。違う色はカウントせず。
3. **オービットパトロール**: 左右オービットを交互に通過（5 シーケンス）。達成で +260 EXP。
4. **マルチボール招集**: 中央ホール 2 回でマルチボール。開始時 +180、ジャックポット +300。
- ミッション完了で次ミッションへ。全ミッション完了で「コマンドチェイン」発生（時間限定で全 EXP 1.5 倍）。

## スコア/記録
- `getScore()` は累積 EXP をそのまま使用。
- 最高 EXP を `bestScore` に保存。
- 各ミッションの最短クリア時間も別途記録（`bestTimes`）。

## UI/演出
- 画面上部 HUD: 現在の EXP、ボール数、ミッション進行、コンボタイマー。
- コンボ/ボーナス発生時は `#miniexp-hud` にテキスト演出（例: 「バンパーコンボ +50 EXP」）。
- ミッション開始/成功/失敗で専用カラーフラッシュ。
- マルチボール時はボールを 2 球追加し、それぞれ半透明トレイル。
- ティルト発生時は画面全体を赤く点滅しフリッパー無効表示。

## 実装方針（API連携）
- `create(root, awardXp, { difficulty })`:
  - キャンバス（WebGL または Canvas2D）で簡易 3D 表現（擬似 3D 斜視）。
  - 物理エンジンは簡易な独自ループ（ボール位置/速度、壁反射、フリッパーモデル）。
  - ギミックごとに当たり判定を持ち、ヒット時に `awardXp()` 呼び出し。
  - ミッション進行やマルチボール状態はステートマシンで管理。
- `start() / stop()`:
  - ゲームループの開始/停止。ポーズメニューは `stop()` 中に UI 表示。
- `destroy()`:
  - イベントリスナーとタイマー解除、DOM クリーンアップ。
- `getHighScoreData()`:
  - `bestScore` と `bestTimes` を返却。

## 傾き（ティルト）システム
- `nudge(direction)` を `←/→/↓` キーで実装（オプション）。
- 短時間に 3 回以上でティルトフラグ ON → フリッパー操作無効（3 秒）。
- ティルト中の EXP 付与は禁止（`awardXp` 呼び出し抑止）。

## エラー/ガード
- フリッパー操作の多重入力防止（キーアップ/ダウン管理）。
- ボールが停止した場合の強制リセット（一定時間無速度でキックバック）。
- `destroy()` 複数回呼び出し安全性確保。

## manifest.json 例
```json
{ "id": "pinball_3d", "name": "3Dピンボール風", "entry": "games/pinball-3d.js", "version": "0.1.0", "description": "XP風ピンボール。ギミックでEXP獲得", "category": "テーブル" }
```
