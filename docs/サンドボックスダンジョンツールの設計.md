# サンドボックスダンジョンツールの設計

## 目的
ツールズタブに「サンドボックスダンジョン」ツールを追加し、プレイヤーがゲーム本編とは切り離された環境でカスタムダンジョンを作成・試走できるようにする。マップレイアウト、敵配置、開始位置や階段の有無、プレイヤーレベルを自由に設定し、戦闘テストやレベルデザインの検証に活用できるようにする。サンドボックス内では経験値獲得を無効化し、本編の進行に影響を与えない安全な検証環境を提供する。

## 要件
- ツールズタブのサイドバーに新しいツール項目「サンドボックスダンジョン」を追加する。
- サンドボックスツールの主な構成要素
  - **マップエディタ**
    - 幅・高さ（5〜60）を指定。
    - セルをクリックして「床 / 壁」を切り替え。
    - クリックブラシを切り替えてプレイヤー開始位置・階段位置を指定。
    - 選択した敵の配置座標をマップ上で更新できるようにする。
    - セルの状態と配置済み要素（開始位置、階段、敵）を視覚的に表示。
  - **敵リスト**
    - 複数の敵エントリを追加・削除。
    - 名前、レベル、HP、攻撃、防御、ボス扱いフラグを編集。
    - X/Y 座標を直接入力、またはマップブラシで設定。
    - 選択中の敵がわかるようにハイライト。
  - **プレイヤー設定**
    - サンドボックス内でのプレイヤーレベルを数値入力（1〜999）。
    - レベルから自動で最大HP/攻撃/防御を算出し、開始時に適用。
- **起動セクション**
    - 設定内容の検証メッセージ（開始位置未設定など）。
    - 「サンドボックスを開始」ボタンでゲーム画面へ遷移。
    - サンドボックス中は経験値が得られない旨の注意表示。
- **インタラクティブモード**
    - 起動前に有効/無効を切り替えるチェックボックスを用意し、オンのときは探索中に専用パネルを開ける。
    - パネルでは HP 全回復ボタン、HP/攻撃/防御/SP/満腹度の直接入力、ゴッドモード・ノークリップ切り替えを提供する。
    - ゴッドモード中は全パラメータを Infinity に設定し、あらゆるダメージ・状態異常・地形効果を無効化、スキルも無制限で発動できる。
    - ノークリップ中は壁やギミックをすり抜け、敵からの追尾や攻撃判定を受けない。
    - メニューボタンから床タイプなどを設定したツールを選び、使用ボタンでプレイヤー前方のマスを即時編集できる。
- マップや敵配置は保存用とは別にツール内状態として保持し、再描画で反映する。
- サンドボックス開始時の処理
  - 現在のプレイヤー状態をスナップショットして退避。
  - プレイヤーレベルを固定値に変更し、HP/攻撃/防御を再計算。
  - 現在モードを `sandbox` に設定し、`generateMap` / `generateEntities` がカスタム設定を使うようにする。
  - 経験値獲得関数（`grantExpFromEnemy` / `grantExp`）でサンドボックス中は 0 を返す。
  - `saveAll` はサンドボックス中にローカル保存を行わない。
- サンドボックス終了時（戻るボタン等）
  - 退避しておいたプレイヤー状態を復元。
  - サンドボックスモードフラグを解除し、通常モードのセーブに戻す。

## UI レイアウト案
- `.sandbox-layout` : 左に設定フォーム、右にマッププレビュー。
- `.sandbox-grid` : CSS Grid でセルを並べる。セルは正方形ボタンとし、壁・床・開始・階段・敵を色とアイコンで区別。
- `.sandbox-brush-select` : ラジオボタン風のボタン群でブラシ切り替え。
- `.sandbox-enemy-list` : 各敵をカード風に表示し、選択状態を示す。
- 注意テキストはハイライト背景で「経験値無効」を明示。

## 実装計画
1. `index.html`
   - ツールズサイドバーに新ボタンと説明を追加。
   - `tool-sandbox-editor` セクションを新設し、マップエディタ・敵リスト・起動セクションのマークアップを実装。
   - インタラクティブモード用のチェックボックスとゲーム画面に表示するメニューボタン/パネルのマークアップを追加。
2. `style.css`
   - サンドボックスツール用のスタイルを追加（レイアウト、グリッド、ボタン、敵カード等）。
   - インタラクティブパネルのレイアウト・レスポンシブ調整・ゴッドモード/ノークリップの視覚的状態をデザイン。
   - 既存テーマカラーに合わせて背景や境界線を定義し、アクセシビリティを意識したコントラストを確保。
3. `main.js`
   - `sandboxState` / `sandboxRefs` などの状態管理オブジェクトを定義。
   - `initToolsTab` 内でサンドボックスツールの初期化処理を追加し、イベントバインドとレンダリング関数を実装。
   - `updateMapSize`, `generateMap`, `generateEntities`, `getMaxFloor`, `recommendedLevelForSelection`, `grantExpFromEnemy`, `grantExp`, `saveAll`, `showSelectionScreen` などにサンドボックスモードの分岐を追加。
   - `startSandboxGame`, `restoreSandboxSession` などモード遷移用ヘルパーを作成。
   - インタラクティブモードのランタイム（メニュー表示、パラメータ反映、ゴッドモード/ノークリップ/ツール適用）を管理する。
4. テキストメッセージ・バリデーションを追加し、開始条件（開始位置・プレイヤーレベルの設定、マップに床が存在するかなど）をチェック。
5. 動作確認：
   - ツール内でマップ編集→サンドボックス開始→プレイ→戻る、のフローが期待通りか確認。
   - サンドボックス中に敵を倒しても経験値が増えないことを確認。
   - インタラクティブモード中にパラメータ変更・ツール適用・ゴッドモード/ノークリップが即時反映されることを確認。
   - 通常モードへ戻った後に経験値が正しく動作し、セーブデータが破壊されないことを確認。

## 拡張余地
- マップ状態のインポート/エクスポート（JSON）。
- 地形タイプ（氷床・毒床など）の追加ブラシ。
- 敵AIやスポーン波設定の拡張。
- プレイヤー装備・所持アイテムのカスタマイズ UI。
