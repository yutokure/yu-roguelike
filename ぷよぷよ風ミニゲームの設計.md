# ぷよぷよ風ミニゲーム（仮称: Falling Puyos）設計

## 目的
- 2色以上のぷよ（スライム状ブロック）が2個1組で落下し、同色4個以上が接触すると消えるクラシックな落ち物パズルを再現する。
- 連鎖でEXPボーナスが入る爽快感を重視する。
- 既存の`tetris.js`や`match3.js`と同様にcanvasで描画する。

## 仕様概要
- フィールドサイズ: 横6列×縦12行。
- 落下ユニット: 2個1組（縦並びで出現）。回転で縦横切替。
- 色数: EASYは3色、NORMALは4色、HARDは5色。
- 操作: 左右移動・下入力で落下加速・上/スペースでハードドロップ・Z/X回転。Rでリスタート。
- 消去条件: 同色が上下左右で4つ以上連結すると同時消去。
- 連鎖判定: 1回の落下で複数回消去が発生した場合、連鎖数に応じてEXP倍率。
- ゴミ/おじゃまは実装しない。
- 落下速度: 難易度で調整（EASY:0.8s/セル, NORMAL:0.6s, HARD:0.4s）。
- ロックディレイ: 底または接地時に0.5s固定。
- 終了条件: 新しいぷよが初期位置に置けなければゲームオーバー。

## EXP設計
- 基礎EXP: 消去ぷよ1個につき0.5EXP。
- 連鎖ボーナス: `倍率 = 1 + (連鎖数-1)*0.5`。例: 2連鎖→1.5倍, 3連鎖→2.0倍。
- ハードドロップ: 距離×0.1EXP。
- ソフトドロップ: 距離×0.05EXP。
- ゲームオーバー時にリザルトを表示し、再スタートでフィールドリセット。

## UI
- メインフィールドを中央寄せ。
- 右側に次の3組を表示。
- 左上にスコア（合計消去数、最大連鎖）と難易度。
- ゲームオーバー時は暗転と「Game Over」「Rで再開」。

## 内部構造
- `create(root, awardXp, opts)`をエクスポートするIIFEスタイルで他のゲームに合わせる。
- 内部状態
  - `grid`: ROWS×COLSの配列。各セルは`null`または色インデックス（0..n-1）。
  - `current`: `{cells:[{x,y,color},{...}], pivotIndex, x, y}`等で保持。
  - `nextQueue`: 次の組3つ。
  - `fallTimer`, `lockTimer`, `running`, `ended`, `chainCounter`, `maxChain`。
- 処理フロー
  1. 初期化時に`nextQueue`を補充し`spawn()`。
  2. `requestAnimationFrame`ループでdelta計測し`update`。
  3. 接地時は`lockTimer`で猶予、移動でリセット。
  4. `settle()`でグリッドに配置、`resolveMatches()`で消去→落下→連鎖ループ。
  5. 連鎖ごとにEXPを計算し`awardXp`。
- 衝突判定は2個のセルをそれぞれチェック。

## テスト項目
- EASY/NORMAL/HARDで色数・落下速度が変わること。
- 4個以上連結で消えること、T字/L字など複雑な連結も対応。
- 連鎖で倍率が上がること。
- ハードドロップ/ソフトドロップでEXP加算。
- ゲームオーバー後にRで再開できる。

