# 麻雀ミニゲームの設計

本設計は MiniExp MOD API v0.1 に準拠し、4 人打ち日本麻雀をベースとしたミニゲーム MOD (`id: riichi_mahjong`) を追加する。段階的なフェーズ開発を前提に、Phase 1 では 1 局（東風戦 1 ハンチャン相当）の簡略化ルールを実装し、徐々に公式ルールに近づける。UI は 2D 俯瞰卓表示、ターゲットデバイスは PC・タブレット。

## 基本仕様
- ID: `riichi_mahjong`
- 表示名: リーチ麻雀
- エントリ: `games/riichi_mahjong.js`
- バージョン: 0.1.0（Phase 1 初期リリース）
- カテゴリ: ボード / テーブルゲーム
- 難易度: `EASY | NORMAL | HARD` （AI の思考深度と配牌バランスに影響）
- プレイ人数: 人間 1 + AI 3（座席は東・南・西・北）
- ゲーム構成: ホーム画面 → 卓選択 → 対局 UI → 結果画面
- EXP: 和了・副露・ドラ使用などに応じて XP 加算。`awardXp` を通じて配分。

## 開発フェーズ
- **Phase 1（本タスク）**: 東風戦（親 1 周）、リーチ・ドラ・一発・裏ドラなし。役は基本 9 種（立直なし・喰い下がりなし）。点数計算は翻数による簡易表。槓・流局・供託無。
- **Phase 2**: 本格的なリーチ・ドラ・裏ドラ・カンドラ・嶺上開花・海底/河底・包を実装。点数計算を公式表へ拡張。和了演出と局進行、ノーテン罰符等。
- **Phase 3**: 半荘戦・赤ドラ・オーラス処理・流し満貫・チョンボ。AI 思考強化（手作り評価・押し引き判断）。オンライン対戦への布石。

## ルール設定（Phase 1）
- **牌構成**: 萬子・筒子・索子 各 1〜9 を 4 枚ずつ、字牌（東南西北白發中）を 4 枚ずつの合計 136 枚。赤ドラなし。
- **配牌**: 東家から 14 枚、他家 13 枚。王牌は 14 枚確保（ただし Phase 1 では使用しない）。
- **巡行**: 東家から右回り。摸打処理は「自摸 → 打牌 → 副露チェック → 次家」。
- **副露**: 鳴きはポン・チーのみ。明槓は Phase 2 以降。鳴き後は即座に手牌並び替え。
- **和了条件**: メンツ手（4 面子 + 雀頭）または七対子。国士無双は Phase 2 以降。
- **役（Phase 1）**:
  - 門前清自摸和
  - 断么九
  - 平和
  - 一盃口
  - 役牌（三元牌・場風・自風）
  - 混全帯么九
  - 純全帯么九
  - 混一色
  - 清一色
- **点数計算**: 翻数 × 基本点 500 を基準に、子: 翻 × 500 × 2、親: 翻 × 500 × 3。4 翻以上は満貫扱い（子 8000 / 親 12000）。符計算は行わない。
- **勝敗判定**: 親を含む 4 人で東場 4 局をプレイし、最高得点者が勝利。XP は順位ごとに 80 / 40 / 10 / 0。
- **流局**: 山が尽きた場合は流局。テンパイ者に 30 XP、ノーテン者は XP なし。点棒移動は Phase 1 では行わない。

## アーキテクチャ
```
riichi_mahjong.js
  ├─ MahjongGame (エントリーポイント)
  │    ├─ init(root, api)
  │    ├─ start()/stop()/destroy()
  │    └─ handleResize()
  ├─ GameState
  │    ├─ createInitialState(opts)
  │    ├─ applyAction(state, action)
  │    └─ deriveView(state, seat)
  ├─ TileSet
  │    ├─ generateWall(seed)
  │    ├─ drawTile(state)
  │    └─ shuffle(array, rng)
  ├─ AI
  │    ├─ evaluateHand(hand, context)
  │    ├─ chooseDiscard(options, context)
  │    └─ decideCall(action, context)
  ├─ UI Layer
  │    ├─ TableRenderer
  │    ├─ HandRenderer
  │    ├─ CallOverlay
  │    └─ ResultDialog
  └─ Services
       ├─ ScoreCalculator
       ├─ HandEvaluator
       ├─ AnimationQueue
       └─ SoundBus
```

### GameState
- `state` は以下の構造を持つ：
```ts
{
  seats: [0,1,2,3],
  dealer: 0,
  round: 0, // 東1=0, 東2=1...
  hands: Tile[][],
  draws: number,
  discards: Tile[][],
  calls: Call[][],
  wall: Tile[],
  deadWall: Tile[],
  turn: 0,
  phase: 'draw' | 'discard' | 'call' | 'end',
  winners: SeatResult[],
  scores: number[],
  history: ActionLog[],
  settings: { difficulty: 'EASY'|'NORMAL'|'HARD' }
}
```
- `applyAction` は `draw`, `discard`, `call`, `win`, `skip`, `endRound` を処理。副作用を避け、`immer` 風の浅いコピーで更新。
- `deriveView` は UI 用データ（自分の手牌並び、他家の牌枚数、リーチ棒表示など）を返す。

### TileSet
- 牌は `{ suit: 'm'|'p'|'s'|'z', value: number, id: string }` で表現。`id` は乱数でユニーク化。
- `generateWall(seed)` は `difficulty` と時間からシード生成し、Fisher–Yates シャッフル。
- `drawTile(state)` は `wall.pop()` を返しつつ `draws++`。残り 0 の場合 `phase` を `end` に。

### AI
- **EASY**: ランダム捨て + 役牌優先。
- **NORMAL**: シンプル評価（向聴数算出、危険牌マップ）。副露は役牌のみ。
- **HARD**: 向聴数 + ブロック評価。喰い断狙い、断么/平和優先。押し引きは点差を考慮。
- 思考は `requestIdleCallback` 風タイマーで遅延し、UX を損なわない。

### UI
- **レイアウト**: 16:9 基準。中央に卓、四方にプレイヤー UI。自分の手牌は下部横並び、他家は裏面。
- **コンポーネント**:
  - **TableRenderer**: Canvas または SVG で卓面・点棒・場風表示。
  - **HandRenderer**: DOM フレックスで牌画像を並べ、ホバーで選択。
  - **CallOverlay**: 鳴き候補がある時にポップアップボタンを表示（ポン/チー/パス）。
  - **DiscardRiver**: 各プレイヤーの捨牌を 6×3 グリッドで表示。
  - **ActionBar**: `和了`, `ツモ切り`, `パス`, `設定` ボタン。ショートカット `Space`: ツモ切り、`Enter`: 和了、`Esc`: パス。
- **アニメーション**: CSS トランジション + `AnimationQueue` で順序制御。摸打は 200ms、鳴きは 400ms。
- **サウンド**: `SoundBus` で `tile_pick`, `tile_drop`, `call`, `win` の 4 種を Phase 1 で提供。
- **アクセシビリティ**: 色覚対応の牌デザイン（数字 + 色）。スクリーンリーダー向けに操作ボタンへ `aria-label`。

### データ保持
- `localStorage` キー: `mini_riichi_v1`
  - `settings`: { sound: 0..1, animationSpeed: number, autoSort: boolean }
  - `stats`: { plays: number, wins: number, highScore: number, averageRank: number }
- 保存タイミング: 局終了毎に `stats` 更新。設定変更時に debounce 500ms。

### EXP 設計
- 和了: 100 XP + 翻数 × 20 XP
- 副露成功: 10 XP
- テンパイ流局: 30 XP
- 対局完了: 順位ボーナス（80/40/10/0）
- 難易度倍率: EASY ×0.9, NORMAL ×1.0, HARD ×1.2

## シーン遷移
1. **ホーム画面**: ルール説明、ランキング表示、`開始` ボタン。
2. **設定ダイアログ**: 難易度・表示言語・自動ソート ON/OFF。
3. **対局シーン**: 卓 UI。`PauseMenu` で終了/再開。
4. **結果画面**: 順位表、獲得 XP、手牌リプレイ（Phase 2 で詳細再生）。

## テスト指針
- **ユニットテスト**: `HandEvaluator` で役判定ケース 50 件以上。`ScoreCalculator` の翻数→点数マップ検証。
- **統合テスト**: 1 局を自動プレイし、全員の手牌枚数が常に 13/14 を維持するか確認。
- **UI テスト**: 難易度別に 3 回プレイして FPS を測定（60fps ±10）。副露ポップアップが 1.5 秒以内に表示されるか。
- **AI テスト**: HARD で 30 戦シミュレーションし、喰い断率が 20% ±5% に収束するかをログ分析。

## 今後の拡張
- Phase 2 でのリーチ演出、点棒移動アニメーション、供託棒 UI。
- 牌リプレイ履歴のシェア機能（JSON エクスポート）。
- オンライン対戦を見据えた同期プロトコルの策定。WebRTC or WebSocket を想定。
- マルチテーマ（近未来卓・和風卓）と BGM 切替。

