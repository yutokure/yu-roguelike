# 暗記アプリミニゲームの設計

## 目的
MiniExp MOD の「トイ」カテゴリに、フラッシュカード型の暗記支援ミニゲーム「暗記スタジオ」を追加する。ユーザーが単語や知識をカードとして登録し、簡易的な間隔反復アルゴリズムで復習スケジュールを管理できる。カードの登録や復習結果に応じて EXP を獲得し、学習ログを可視化することでモチベーションを高める。

## ユーザー体験
- 画面左側にデッキ一覧とフィルターを配置。デッキごとのカード枚数、当日復習予定件数、直近の達成率を表示する。
- 右側にレビュー領域を配置し、今日復習すべきカードや手動でキューに追加したカードが順に表示される。
- カードの表面にはタイトルとヒント、裏面には解答欄がある。「表示」「覚えた」「再学習」「ノート」ボタンを用意し、復習結果を即時記録する。
- 下部に統計 HUD を設置。今日の学習時間、解答数、正答率、セッション EXP をリアルタイム表示する。
- 上部のフォームで新しいカードを登録でき、タグやカスタム復習間隔を入力できる。テキスト入力中は Markdown のプレビューをサイドに表示する。
- デッキのインポート / エクスポート（JSON）と、日毎の復習履歴チャート（ミニスパークライン）を含める。

## データ構造
- ローカルストレージキー: `mini_memostudio_state_v1`。
- 永続化データ `{ decks: Deck[], stats: DailyStat[], lastSession: { reviewed: number, correct: number, xp: number, timeSpentMs: number } }`。
- `Deck { id, name, color, createdAt, cards: Card[], reviewOrder: 'due'|'random', active }`
- `Card { id, front, back, hint, tags: string[], createdAt, updatedAt, ease, interval, due, lapses, totalReviews, correctStreak }`
- `DailyStat { date, reviewed, correct, xp, timeSpentMs }` を最大 60 日分保持。
- セッション状態 `state` で、選択デッキ、レビュキュー（`queue`）、進行中カード（`current`）、タイマー、フィルター条件、Markdown プレビュー表示状態、セッション開始時間などを管理。

## ロジック
### 間隔反復
- 初回登録時: `ease = 2.5`, `interval = 1`, `due = today`。
- レビュー結果
  - 覚えた（Good）: `interval = interval * ease`（最小 1 日）、`ease += 0.05`（最大 3.0）。
  - 難しかった（Hard）: `interval = max(1, interval * 0.5)`, `ease = max(1.3, ease - 0.15)`。
  - 再学習（Again）: `interval = 1`, `ease = max(1.3, ease - 0.3)`, `lapses++`, `correctStreak = 0`。
- 次回 `due` は現在時刻 + `interval` 日後。レビュー時刻は ISO 文字列で保持。
- `queue` の構築は選択デッキ内で `due <= today` を優先し、残りは追加学習枠（最大 10 件）としてキュー化。

### UI イベント
- カード追加フォーム送信: 入力バリデーション → `cards` に push → 即時保存 → XP 付与 (`awardXp(6)`)。
- デッキ選択切替: `queue` を再構築し HUD 更新。
- レビュー操作:
  - 「表示」: 解答欄を開き、ステップを `showingAnswer` に変更。
  - 「覚えた」: Good 処理 → 統計更新 → XP (`+4`)。
  - 「難しい」: Hard 処理 → XP (`+3`)。
  - 「再学習」: Again 処理 → XP (`+2`)。
  - 「ノート」: モーダルを開き、自由記述メモを保存。メモ更新時に XP (`+1`)。
- タグフィルター変更: キュー再構築。
- インポート: JSON を検証して既存データにマージ。完了後 XP (`+10`)。
- エクスポート: Blob を生成してダウンロード。
- 統計スパークラインは Canvas で日次正答率を描画し、日付ホバーで詳細表示。

### 経験値付与
- カード追加: +6
- レビュー Good: +4 / Hard: +3 / Again: +2
- ノート保存: +1
- 1 セッションのレビュー 10 件達成ごとにボーナス +8
- インポート成功: +10
- 統計閲覧（折れ線にホバー）時、初回のみチュートリアル XP +2
- `getScore()` ではセッション累計 XP を返す。

## 主なコンポーネント / 関数
- `create(root, awardXp, opts)` … DOM レイアウト初期化、状態読み込み、イベント登録。
- `buildDeckList()` … 左パネルのデッキカード生成と進捗表示。
- `rebuildQueue()` … 選択デッキ・タグ・ソート設定に基づきレビューキューを再構成。
- `beginReview(card)` … カードを表示し、タイムスタンプを記録。
- `handleReview(result)` … Good/Hard/Again の処理、統計更新、XP 付与、次カードへ遷移。
- `openNoteEditor(card)` … ノート入力モーダルを生成。
- `renderStats()` … HUD のメトリクスとスパークライン描画。
- `persist()` … 状態をローカルストレージに保存。
- `destroy()` … イベントリスナー解除、タイマー停止、DOM 破棄。

## テスト観点
- カード追加・削除・編集が保存され、再読み込みしても保持される。
- デッキ切替とタグフィルターで正しいカード数が表示され、レビューキューに反映される。
- 各レビュー操作で次のカードへ進み、統計と XP が期待通り更新される。
- 10 件レビュー後のボーナス XP が重複なく発生する。
- インポートで不正 JSON を弾き、正常 JSON でマージされる。
- スパークラインにカーソルを当てたとき詳細ポップアップと XP ボーナスが表示される。
- `start/stop/destroy/getScore` API の契約を満たし、ミニゲーム終了時にリスナが残らない。
