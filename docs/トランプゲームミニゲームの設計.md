# トランプゲームミニゲームの設計

本設計は MiniExp MOD API v0.1 に準拠し、1つの MOD (`id: trump_games`) の中で複数のトランプゲームを選択・プレイできるハブを実装する。共通のカードユーティリティとゲームライフサイクルを用意し、個々のゲームはモジュールとして登録される。

## 基本仕様
- ID: `trump_games`
- 表示名: トランプセレクション
- エントリ: `games/trump_games.js`
- バージョン: 0.1.0（Phase 1 初期リリース）
- カテゴリ: ボード / テーブルゲーム
- 難易度: MiniExp 標準 (`EASY | NORMAL | HARD`) を各ゲームが解釈
- 画面構成: 左にゲームリスト、右にゲームボード。トップバーで現在のゲーム名/難易度/スコアを表示。
- 基本動線: 起動 → ゲーム選択 → 個別ゲーム UI → 戻る/リスタート/終了
- EXP 管理: `awardXp` を通じてルール毎に加算。共通 HUD バッジ利用。

## アーキテクチャ
```
trump_games.js
  ├─ CardUtils: デッキ生成・シャッフル・レンダリング
  ├─ HubUI: ゲーム切替・トップバー・メッセージ
  ├─ GameRegistry: { id, title, icon, description, difficultyHints, create }
  ├─ BaseRuntime: start/stop/destroy、visibilitychange 対応
  └─ Game Modules
       ├─ solitaireKlondike
       ├─ solitaireSpider
       ├─ freecell
       ├─ hearts
       ├─ sevens
       ├─ memory
       ├─ poker
       ├─ blackjack
       ├─ babaNuki
       ├─ jijiNuki
       ├─ daifugo
       └─ pageOne
```

- **CardUtils**
  - `createDeck({ decks=1, jokers=0 })`: 標準 52 枚 + ジョーカー。
  - `shuffle(deck, seed?)`: Fisher–Yates。seed は `opts.difficulty` を用いた deterministic シード。
  - `deal(deck, count)`: 先頭から分配。
  - `cardValue(card)`: ランクに応じた数値。
  - `format(card, { short|long })`: 表示文字列生成。
  - `renderCard(card, opts)`: DOM エレメント化。共通スタイルを `<style data-trump>` として一度だけ注入。
  - `cardBack(theme)`: 裏面描画。
  - `arrangeFan(container, cards, { direction, spacing })`: 整列用ヘルパ。

- **GameRuntime プロトコル**
  - `init(subRoot, hubContext) → runtime`。`hubContext` は `award`, `difficulty`, `cardUtils`, `setStatus(text)`, `setActions(btnConfig[])`, `showHint(text)`。
  - runtime は `{ start, stop, destroy, onResize?, getScore? }` を実装。
  - Hub はゲーム切替時に `destroy` を必ず呼び、visibilitychange で `stop/start` を委譲。

- **XP 共通方針**
  - 基本テーブル: 小アクション 1〜3 XP、中間 5〜15、ゲーム勝利 50〜150。
  - 難易度ごとの倍率: EASY ×0.8、NORMAL ×1.0、HARD ×1.2（CardUtils が `awardDifficultyXp(base)` を提供）。

## UI
- ルート背景: 線形グラデーション + テーブル模様。
- 左パネル: `ul` 風カードリスト。進捗バッジ（BEST / WIP）を表示。
- 右エリア: タイトルバー + ボード領域 + 下部コントロールバー。
- レイアウトはレスポンシブ（最小幅 760px、縦長時は縦積み）。`ResizeObserver` で再配置。
- キーボード操作: ショートカット（R: リスタート、B: ハブに戻る、H: ヒント）。

## ゲーム一覧と実装段階
| ID | 日本語 | デッキ | プレイ人数 | Phase | 主な操作 | XP 概要 |
|----|---------|--------|------------|-------|-----------|---------|
| `klondike` | ソリティア（クロンダイク） | 52 | 1 | Phase 2 | ドラッグ/ダブルクリック | 札移動 1 / 山札消費 1 / ファンデーション完成 25 / 全クリア 150 |
| `spider` | スパイダーソリティア | 104 | 1 | Phase 3 | ドラッグ | 列完成 15 / 難易度でスート数切替 |
| `freecell` | フリーセル | 52 | 1 | Phase 2 | ドラッグ | 移動 1 / 空列活用 3 / 完全クリア 180 |
| `hearts` | ハーツ | 52 | 4 (AI3) | Phase 3 | カード選択 | トリック勝敗で±XP。失点でマイナス評価し 0 以下を防ぐ |
| `sevens` | 七並べ | 52 | 4 (AI3) | Phase 2 | カード選択 | 出す 2 / パス -3 / 勝利 100 |
| `memory` | 神経衰弱 | 52→26ペア | 1 | **Phase 1** | カードタップ | 正解 3 / ミス 1 / 全クリア: 60 |
| `poker` | ポーカー（ドローポーカー） | 52 | 1 | Phase 2 | 保持/ドロー | 役に応じ 5～120 XP |
| `blackjack` | ブラックジャック | 52 | 1 (AI Dealer) | **Phase 1** | HIT/STAND/DOUBLE | 勝利 25 / Blackjack 60 / 負け 0 |
| `baba` | ババ抜き | 53 | 4 (AI3) | **Phase 1** | 右隣からカード引く | ペア成立 4 / 上がり 80 / 最後ババ -10 |
| `jiji` | ジジ抜き | 54 | 4 (AI3) | Phase 2 | ババ抜き + 台札差替 | 同上、最後ジジ所持 -20 |
| `daifugo` | 大富豪 | 52 | 4 (AI3) | Phase 3 | カード選択 | 上がり順位で XP ラダー |
| `pageone` | ページワン | 52 | 1 vs 3 | Phase 2 | カード選択 / 宣言 | 上がり 90 / ペナルティ -10 |

### フェーズ定義
- **Phase 1**: 初期リリース（本タスク）。ハブ、共通 API、`memory`、`blackjack`、`baba` 実装。未実装ゲームは「準備中」表示。
- **Phase 2**: 2nd wave。`klondike`, `freecell`, `sevens`, `poker`, `jiji`, `pageone`。
- **Phase 3**: 高難度。`spider`, `hearts`, `daifugo`。

## ゲーム別サマリ（Phase 1 詳細）

### 神経衰弱 (`memory`)
- 構成: 4×6〜5×6 グリッド（難易度に応じてペア数 12/15/18）。
- 操作: カードをクリックしてめくる。2 枚開いたら 1 秒判定。
- EXP: 正解時 3 × 難易度倍率、連続正解で Combo バッジ。
- 記録: `getScore()` = 経過時間（秒） 。最小値がベスト。

### ブラックジャック (`blackjack`)
- デッキ: 6 シュー (312 枚) をシャッフルし順次消費。再シャッフルを自動判定。
- ベット: 常に $10 固定（UIは疑似）。勝利で 10×倍率 XP、ブラックジャック時追加。
- 操作: `HIT`, `STAND`, `DOUBLE (EASY/NORMAL)`, `SPLIT` は Phase 1 では未実装 (UI に灰色表示)。
- ディーラー AI: 17 以上でスタンド。ソフト 17 は HARD のみヒット。
- 記録: `getScore()` = 通算勝ち数。

### ババ抜き (`baba`)
- デッキ: 53 枚（ジョーカー 1 枚）。
- プレイヤー: 人間 + 3 AI。時計回りにターン。手札は扇状表示。
- 操作: 右隣の裏向きカードをクリック。
- AI: 乱数で選択、ペア成立で即座に捨て場へ。
- 勝敗: 上がり順に応じて XP。最後にジョーカーを握っていたら -10。
- 記録: `getScore()` = 最新ゲームの順位（1=最良）。

## 共通コンポーネント
- **HUD**: 現在のゲームタイトル、ターン表示、残りデッキ数などを 3 カラムで表示。
- **ActionBar**: プライマリ/セカンダリボタン最大 3。ショートカット割当（Enter=Primary, Esc=Back）。
- **Notice Toast**: `hubContext.showHint(message, { type: 'info'|'warn' })`。
- **TimerService**: 各ゲームが簡単にタイマーを持てるよう `createTicker(callback, interval)` を提供。`stop/destroy` で自動解除。

## データ保持
- `localStorage` キー: `mini_trump_games_v1`。
  - `settings`: 直近選択ゲーム、カード背面テーマ、音量設定。
  - `stats`: ゲーム別 { plays, wins, bestScore }。
- 保存タイミング: ゲーム終了時と設定変更時にスロットル保存（500ms）。

## イベント/ステート管理
- Hub 内部状態:
```ts
{
  currentGameId: string|null,
  runtimes: Map<string, GameRuntime>,
  stats: Record<string, GameStats>,
  settings: { cardBack: 'classic'|'modern', autoFlip: boolean },
  isPaused: boolean
}
```
- visibilitychange で `isPaused` 更新。
- 各ゲームは `hubContext` 経由で stat 更新要求 (`commitStats(delta)`) を発行。

## テスト指針
- Hub レンダリング：ゲーム切替10回でメモリリークが無いことをコンソールで確認。
- 神経衰弱：全難易度でペア総数が合っているか、タイマーが正しく停止するか。
- ブラックジャック：デッキが自動再シャッフルされるか、ディーラーが H17/HARD-S17 を遵守するか。
- ババ抜き：ペア成立ロジック（ジョーカーはどのカードともペア不可）。プレイヤーターンが正しく進むか。

## 今後の拡張
- Phase 2/3 でカードドラッグ操作が増えるため、`DragService` を追加予定。
- マルチプレイヤー視点切替（AIでなく人間操作）にも対応できるよう設計。
- テーマ切替（和柄/洋柄）や BGM の導入余地あり。

