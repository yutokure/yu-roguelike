<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuローグライク</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Yuローグライク</h1>
    <div id="selection-screen">
        <div class="selection-card">
            <h2>ダンジョン選択</h2>
            <div class="row">
                <label for="difficulty-select">難易度</label>
                <select id="difficulty-select">
                    <option value="Very Easy">Very Easy</option>
                    <option value="Easy">Easy</option>
                    <option value="Normal" selected>Normal</option>
                    <option value="Second">Second</option>
                    <option value="Hard">Hard</option>
                    <option value="Very Hard">Very Hard</option>
                </select>
            </div>
            <div class="tabs" role="tablist" aria-label="ダンジョン選択タブ">
                <button id="tab-button-normal" class="tab-button active" role="tab" aria-selected="true" aria-controls="tab-normal">通常</button>
                <button id="tab-button-blockdim" class="tab-button" role="tab" aria-selected="false" aria-controls="tab-blockdim">ブロック次元</button>
                <button id="tab-button-miniexp" class="tab-button" role="tab" aria-selected="false" aria-controls="tab-miniexp">ミニゲー経験</button>
                <button id="tab-button-tools" class="tab-button" role="tab" aria-selected="false" aria-controls="tab-tools">ツールズ</button>
            </div>
            <div id="tab-normal" class="tab-content active" role="tabpanel" aria-labelledby="tab-button-normal">
            <div class="row">
                <div class="worlds">
                    <span>世界</span>
                    <div id="world-buttons"></div>
                </div>
            </div>
            <div class="row">
                <div class="dungeons">
                    <span>ダンジョン</span>
                    <div id="dungeon-buttons"></div>
                </div>
            </div>
            <div class="row">
                <div id="dungeon-detail-card" class="dungeon-detail-card" style="display: none;">
                    <h3 id="dungeon-name">ダンジョン名</h3>
                    <div class="detail-row">
                        <span class="label">種類:</span>
                        <span id="dungeon-type">フィールド</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">推奨レベル:</span>
                        <span id="dungeon-recommended-level">1</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">ダメージ倍率:</span>
                        <span id="dungeon-damage-multiplier">与: 1.6x / 被: 0.5x</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">説明:</span>
                        <span id="dungeon-description">ダンジョンの説明</span>
                    </div>
                    <button id="start-dungeon-btn" class="start-btn">ダンジョンに入る</button>
                </div>
            </div>
            </div>
            <div id="tab-blockdim" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="tab-button-blockdim">
                <div class="row">
                    <div class="bdim-field">
                        <label for="bdim-nested">NESTED次元</label>
                        <input id="bdim-nested" type="number" min="1" max="99999999" step="1" value="1" title="NESTED次元: 推奨Lvが2600*(N-1)増加します" />
                    </div>
                </div>
                <div class="row">
                    <div class="bdim-grid">
                        <div class="bdim-field">
                            <label>次元</label>
                            <div id="bdim-list-dimension" class="bdim-list" role="listbox" tabindex="0" aria-label="次元"></div>
                        </div>
                        <div class="bdim-field">
                            <label>1st</label>
                            <div id="bdim-list-1st" class="bdim-list" role="listbox" tabindex="0" aria-label="1st"></div>
                        </div>
                        <div class="bdim-field">
                            <label>2nd</label>
                            <div id="bdim-list-2nd" class="bdim-list" role="listbox" tabindex="0" aria-label="2nd"></div>
                        </div>
                        <div class="bdim-field">
                            <label>3rd</label>
                            <div id="bdim-list-3rd" class="bdim-list" role="listbox" tabindex="0" aria-label="3rd"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div id="bdim-card" class="bdim-card">
                        <h3>合成プレビュー</h3>
                        <div class="bdim-card-row"><span class="label">選択</span><span id="bdim-card-selection">-</span></div>
                        <div class="bdim-card-row"><span class="label">推奨Lv</span><span id="bdim-card-level">-</span></div>
                        <div class="bdim-card-row"><span class="label">タイプ</span><span id="bdim-card-type">-</span></div>
                        <div class="bdim-card-row"><span class="label">深さ</span><span id="bdim-card-depth">-</span></div>
                        <div class="bdim-card-row"><span class="label">サイズ</span><span id="bdim-card-size">-</span></div>
                        <div class="bdim-card-row"><span class="label">宝箱</span><span id="bdim-card-chest">-</span></div>
                        <div class="bdim-card-row"><span class="label">ボス階</span><span id="bdim-card-boss">-</span></div>
                        <small class="bdim-note">同一選択は同一生成（固定シード）</small>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                            <button id="bdim-start-button" class="start-btn" disabled>Gate</button>
                            <button id="bdim-add-bookmark" title="現在の組み合わせをブックマーク">★ ブックマーク追加</button>
                            <button id="bdim-clear-history" title="Gate履歴を全消去">履歴クリア</button>
                        </div>
                        <!-- ランダム選択（等確率）ボタン（Gateボタンの下） -->
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                            <button id="bdim-random-button" title="1st/2nd/3rd をランダムに選択">🎲 ランダム選択（1st/2nd/3rd）</button>
                        </div>
                        <!-- 重み付きランダム設定 -->
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                            <label for="bdim-random-target">目標Lv(ブロック合計)</label>
                            <input id="bdim-random-target" type="number" min="-10" max="102" step="1" value="0" style="width:96px" title="次元の基準Lvは無視し、ブロック3つのLv合計のみ" />
                            <label for="bdim-random-type">タイプ優先</label>
                            <select id="bdim-random-type" title="一致タイプを優先的に選びます">
                                <option value="">指定なし</option>
                                <option value="field">field</option>
                                <option value="cave">cave</option>
                                <option value="grid">grid</option>
                                <option value="open-space">open-space</option>
                                <option value="maze">maze</option>
                                <option value="rooms">rooms</option>
                                <option value="single-room">single-room</option>
                                <option value="circle">circle</option>
                                <option value="narrow-maze">narrow-maze</option>
                                <option value="wide-maze">wide-maze</option>
                                <option value="snake">snake</option>
                                <option value="circle-rooms">circle-rooms</option>
                            </select>
                            <button id="bdim-weighted-random-button" title="目標Lvとタイプ優先でランダム選択">🎯 重み付きランダム</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="bdim-card" style="background:linear-gradient(135deg,#764ba2,#667eea);">
                        <h3>Gate履歴</h3>
                        <div id="bdim-history" aria-live="polite"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="bdim-card" style="background:linear-gradient(135deg,#764ba2,#667eea);">
                        <h3>ブロックブックマーク</h3>
                        <div id="bdim-bookmarks" aria-live="polite"></div>
                    </div>
                </div>
            </div>
            <div id="tab-miniexp" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="tab-button-miniexp">
                <div class="row">
                    <div class="miniexp-layout">
                        <div id="miniexp-cat-list" class="miniexp-cat-list" role="listbox" aria-label="カテゴリ一覧" tabindex="0"></div>
                        <div id="miniexp-display-modes" class="miniexp-display-toolbar" role="group" aria-label="表示形式"></div>
                        <div id="miniexp-list" class="miniexp-list" role="listbox" aria-label="ミニゲーム一覧" tabindex="0"></div>
                        <div class="miniexp-panel">
                            <div class="miniexp-toolbar">
                                <label for="miniexp-difficulty">難易度</label>
                                <select id="miniexp-difficulty">
                                    <option value="EASY">EASY</option>
                                    <option value="NORMAL" selected>NORMAL</option>
                                    <option value="HARD">HARD</option>
                                </select>
                                <button id="miniexp-start">開始</button>
                                <button id="miniexp-pause" disabled>一時停止</button>
                                <button id="miniexp-restart" disabled>再開/再起動</button>
                                <button id="miniexp-quit" disabled>終了</button>
                            </div>
                            <div id="miniexp-container" class="miniexp-container" aria-live="polite"></div>
                            <div id="miniexp-hud" class="miniexp-hud" aria-live="polite"></div>
                            <div id="miniexp-player-hud" class="miniexp-player-hud" aria-live="polite">
                                <div class="mini-stat-line"><span>Lv</span><span id="miniexp-hud-level">1</span></div>
                                <div class="mini-bar exp">
                                    <div class="mini-bar-label">EXP <span id="miniexp-hud-exp-text">0/1000</span></div>
                                    <div class="mini-bar-track"><div id="miniexp-exp-bar" class="mini-bar-fill"></div></div>
                                </div>
                            </div>
                            <div id="miniexp-placeholder" class="miniexp-placeholder">左の一覧からミニゲームを選択してください。</div>
                            <div id="miniexp-records" class="miniexp-records" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-tools" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="tab-button-tools">
                <div class="row">
                    <div class="tools-layout">
                        <aside class="tools-sidebar" aria-label="ツール一覧">
                            <button id="tool-button-modmaker" class="tool-item active" type="button" data-tool-target="mod-maker">ダンジョンタイプMod作成</button>
                            <p class="tool-hint">構造や生成アルゴリズムを組み立てて `registerDungeonAddon` ファイルを出力します。</p>
                            <button id="tool-button-sandbox" class="tool-item" type="button" data-tool-target="sandbox-editor">サンドボックスダンジョン</button>
                            <p class="tool-hint">自由なマップと敵配置でテスト用ダンジョンを組み立てられます（経験値は獲得できません）。</p>
                            <button id="tool-button-blockdata" class="tool-item" type="button" data-tool-target="blockdata-editor">BlockData編集</button>
                            <p class="tool-hint">BlockDim向けのブロック定義をGUIで確認・編集し、JSONをエクスポートできます。</p>
                            <button id="tool-button-image-viewer" class="tool-item" type="button" data-tool-target="image-viewer">画像ビューア</button>
                            <p class="tool-hint">スクリーンショットなどを拡大・回転・遠近表示しながらメタ情報を確認できます。</p>
                            <button id="tool-button-state-manager" class="tool-item" type="button" data-tool-target="state-manager">状態管理</button>
                            <p class="tool-hint">ゲームとツールの全データをまとめてエクスポート／インポートします。</p>
                        </aside>
                        <section id="tool-mod-maker" class="tool-panel active" data-tool-panel="mod-maker" aria-label="ダンジョンタイプMod作成ツール">
                            <header class="tool-panel-header">
                                <h3>ダンジョンタイプ追加Mod作成ツール</h3>
                                <p>メタ情報、構造パターン、生成アルゴリズム、BlockDimブロック定義をまとめてアドオンJSとして出力します。</p>
                            </header>
                            <section class="modmaker-section" aria-labelledby="modmaker-meta-title">
                                <div class="section-title-row">
                                    <h4 id="modmaker-meta-title">アドオン情報</h4>
                                </div>
                                <div class="modmaker-form-grid">
                                    <label>アドオンID
                                        <input id="modmaker-addon-id" type="text" placeholder="例: custom_pack">
                                    </label>
                                    <label>表示名
                                        <input id="modmaker-addon-name" type="text" placeholder="例: Custom Dungeon Pack">
                                    </label>
                                    <label>バージョン
                                        <input id="modmaker-addon-version" type="text" value="1.0.0">
                                    </label>
                                    <label>作者
                                        <input id="modmaker-addon-author" type="text" placeholder="あなたの名前">
                                    </label>
                                    <label class="full">説明
                                        <textarea id="modmaker-addon-description" rows="2" placeholder="アドオン全体の説明"></textarea>
                                    </label>
                                </div>
                            </section>
                            <section class="modmaker-section" aria-labelledby="modmaker-structures-title">
                                <div class="section-title-row">
                                    <h4 id="modmaker-structures-title">構造ライブラリ</h4>
                                    <div class="section-actions">
                                        <button id="modmaker-add-structure" type="button">+ 構造を追加</button>
                                        <button id="modmaker-remove-structure" type="button">選択を削除</button>
                                    </div>
                                </div>
                                <div class="modmaker-structures">
                                    <div id="modmaker-structure-list" class="modmaker-list" role="listbox" aria-label="構造一覧"></div>
                                    <div class="modmaker-structure-editor">
                                        <div class="modmaker-form-grid">
                                            <label>ID
                                                <input id="modmaker-structure-id" type="text" placeholder="例: custom_room">
                                            </label>
                                            <label>名前
                                                <input id="modmaker-structure-name" type="text" placeholder="表示用の名前">
                                            </label>
                                            <label>アンカーX
                                                <input id="modmaker-structure-anchor-x" type="number" min="0" value="0">
                                            </label>
                                            <label>アンカーY
                                                <input id="modmaker-structure-anchor-y" type="number" min="0" value="0">
                                            </label>
                                            <label>タグ（カンマ区切り）
                                                <input id="modmaker-structure-tags" type="text" placeholder="例: rooms,geo">
                                            </label>
                                            <label class="checkbox-row"><input id="modmaker-structure-allow-rotate" type="checkbox" checked> 回転を許可</label>
                                            <label class="checkbox-row"><input id="modmaker-structure-allow-mirror" type="checkbox" checked> 反転を許可</label>
                                            <label>幅
                                                <input id="modmaker-structure-width" type="number" min="1" value="7">
                                            </label>
                                            <label>高さ
                                                <input id="modmaker-structure-height" type="number" min="1" value="7">
                                            </label>
                                        </div>
                                        <div class="modmaker-grid-toolbar">
                                            <span>セルをクリックして「空白 → 床 → 壁」の順で切り替え</span>
                                            <div class="toolbar-buttons">
                                                <button id="modmaker-fill-empty" type="button">全て空白</button>
                                                <button id="modmaker-fill-floor" type="button">全て床</button>
                                                <button id="modmaker-fill-wall" type="button">全て壁</button>
                                            </div>
                                        </div>
                                        <div id="modmaker-grid" class="modmaker-grid" role="grid" aria-label="構造パターン"></div>
                                        <label class="full">パターンプレビュー
                                            <textarea id="modmaker-pattern-preview" class="code" rows="4" readonly></textarea>
                                        </label>
                                    </div>
                                </div>
                            </section>
                            <section class="modmaker-section" aria-labelledby="modmaker-fixed-title">
                                <div class="section-title-row">
                                    <h4 id="modmaker-fixed-title">固定マップ</h4>
                                    <label class="checkbox-row">
                                        <input id="modmaker-fixed-enabled" type="checkbox"> 固定マップを利用
                                    </label>
                                </div>
                                <div id="modmaker-fixed-container" class="modmaker-fixed">
                                    <div class="modmaker-form-grid">
                                        <label>フロア数
                                            <input id="modmaker-fixed-floor-count" type="number" min="1" max="60" value="1">
                                        </label>
                                        <label>ボス階層（カンマ区切り）
                                            <input id="modmaker-fixed-boss-floors" type="text" placeholder="例: 5,10">
                                        </label>
                                        <p class="modmaker-fixed-note">アルゴリズムで <code>ctx.fixedMaps.applyCurrent()</code> を呼ぶと、その階層の固定マップが適用されます。</p>
                                    </div>
                                    <div class="modmaker-fixed-editor">
                                        <div id="modmaker-fixed-floor-list" class="modmaker-list fixed-floor-list" role="listbox" aria-label="固定マップ階層"></div>
                                        <div class="modmaker-fixed-grid-panel">
                                            <div class="modmaker-fixed-sizebar">
                                                <label>幅
                                                    <input id="modmaker-fixed-width" type="number" min="5" max="75" value="21">
                                                </label>
                                                <label>高さ
                                                    <input id="modmaker-fixed-height" type="number" min="5" max="75" value="15">
                                                </label>
                                                <button id="modmaker-fixed-copy-prev" type="button">前の階層をコピー</button>
                                            </div>
                                            <div class="modmaker-grid-toolbar">
                                                <span>セルをクリックして「壁 → 床 → 空白」の順に切り替え</span>
                                                <div class="toolbar-buttons">
                                                    <button id="modmaker-fixed-fill-wall" type="button">全て壁</button>
                                                    <button id="modmaker-fixed-fill-floor" type="button">全て床</button>
                                                    <button id="modmaker-fixed-fill-void" type="button">全て空白</button>
                                                </div>
                                            </div>
                                            <div id="modmaker-fixed-grid" class="modmaker-grid" role="grid" aria-label="固定マップパターン"></div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section class="modmaker-section" aria-labelledby="modmaker-generators-title">
                                <div class="section-title-row">
                                    <h4 id="modmaker-generators-title">生成アルゴリズム</h4>
                                    <div class="section-actions">
                                        <button id="modmaker-add-generator" type="button">+ 生成タイプを追加</button>
                                        <button id="modmaker-remove-generator" type="button">選択を削除</button>
                                    </div>
                                </div>
                                <div class="modmaker-generators">
                                    <div id="modmaker-generator-list" class="modmaker-list" role="listbox" aria-label="生成タイプ一覧"></div>
                                    <div class="modmaker-generator-editor">
                                        <div class="modmaker-form-grid">
                                            <label>ID
                                                <input id="modmaker-generator-id" type="text" placeholder="例: custom-dungeon">
                                            </label>
                                            <label>名前
                                                <input id="modmaker-generator-name" type="text" placeholder="ダンジョン名">
                                            </label>
                                            <label>説明
                                                <input id="modmaker-generator-description" type="text" placeholder="一覧に表示する説明">
                                            </label>
                                            <label>Normal混合参加率
                                                <input id="modmaker-generator-normal-mix" type="number" step="0.05" min="0" max="1" value="0">
                                            </label>
                                            <label>Block次元混合参加率
                                                <input id="modmaker-generator-blockdim-mix" type="number" step="0.05" min="0" max="1" value="0">
                                            </label>
                                            <label>タグ（カンマ区切り）
                                                <input id="modmaker-generator-tags" type="text" placeholder="例: rooms,organic">
                                            </label>
                                        </div>
                                        <div class="modmaker-template-bar">
                                            <label for="modmaker-template-select">テンプレート</label>
                                            <select id="modmaker-template-select">
                                                <option value="blank">空のテンプレート</option>
                                                <option value="rooms">部屋と通路サンプル</option>
                                                <option value="structure">構造配置サンプル</option>
                                                <option value="fixed">固定マップ適用テンプレート</option>
                                            </select>
                                            <button id="modmaker-apply-template" type="button">選択テンプレートを適用</button>
                                        </div>
                                        <label class="full">アルゴリズムコード
                                            <textarea id="modmaker-generator-code" class="code" rows="12" spellcheck="false"></textarea>
                                        </label>
                                    </div>
                                </div>
                            </section>
                            <section class="modmaker-section" aria-labelledby="modmaker-blocks-title">
                                <div class="section-title-row">
                                    <h4 id="modmaker-blocks-title">BlockDimブロック定義</h4>
                                    <div class="section-actions">
                                        <button class="modmaker-add-block" type="button" data-tier="blocks1">+ 1st</button>
                                        <button class="modmaker-add-block" type="button" data-tier="blocks2">+ 2nd</button>
                                        <button class="modmaker-add-block" type="button" data-tier="blocks3">+ 3rd</button>
                                    </div>
                                </div>
                                <div class="modmaker-blocks">
                                    <div class="modmaker-block-tier" data-tier="blocks1" aria-label="1st Blocks">
                                        <h5>1st Blocks</h5>
                                        <div class="modmaker-block-list" id="modmaker-blocks1"></div>
                                    </div>
                                    <div class="modmaker-block-tier" data-tier="blocks2" aria-label="2nd Blocks">
                                        <h5>2nd Blocks</h5>
                                        <div class="modmaker-block-list" id="modmaker-blocks2"></div>
                                    </div>
                                    <div class="modmaker-block-tier" data-tier="blocks3" aria-label="3rd Blocks">
                                        <h5>3rd Blocks</h5>
                                        <div class="modmaker-block-list" id="modmaker-blocks3"></div>
                                    </div>
                                </div>
                            </section>
                            <section class="modmaker-section" aria-labelledby="modmaker-output-title">
                                <div class="section-title-row">
                                    <h4 id="modmaker-output-title">出力</h4>
                                </div>
                                <div class="modmaker-output">
                                    <div id="modmaker-errors" class="modmaker-errors" aria-live="polite"></div>
                                    <textarea id="modmaker-output" class="code" rows="14" readonly></textarea>
                                    <div class="modmaker-output-actions">
                                        <button id="modmaker-copy" type="button">クリップボードにコピー</button>
                                        <button id="modmaker-download" type="button">.jsファイルとしてダウンロード</button>
                                    </div>
                                </div>
                            </section>
                        </section>
                        <section id="tool-state-manager" class="tool-panel" data-tool-panel="state-manager" aria-label="状態管理ツール">
                            <header class="tool-panel-header">
                                <h3>状態管理</h3>
                                <p>ダンジョン探索の進行状況やMiniExp、BlockDimの履歴、ツールズタブ各ツールのデータを一括でバックアップ／復元します。</p>
                            </header>
                            <div class="state-manager-body">
                                <p class="state-manager-description">「全体エクスポート」で現在の状態を1つのJSONファイルとして保存し、「全体インポート」でそのファイルを読み込むと完全に復元できます。</p>
                                <div class="state-manager-actions">
                                    <button id="state-manager-export" type="button">全体エクスポート</button>
                                    <button id="state-manager-import" type="button">全体インポート</button>
                                    <input id="state-manager-import-file" type="file" accept="application/json" hidden>
                                </div>
                                <div id="state-manager-status" class="state-manager-status" role="status" aria-live="polite"></div>
                                <pre id="state-manager-summary" class="state-manager-summary" aria-live="polite"></pre>
                            </div>
                        </section>
                        <section id="tool-sandbox-editor" class="tool-panel" data-tool-panel="sandbox-editor" aria-label="サンドボックスダンジョンツール">
                            <header class="tool-panel-header">
                                <h3>サンドボックスダンジョン</h3>
                                <p>自由にマップと敵を配置して、経験値に影響しないテスト用ダンジョンをその場で試走できます。</p>
                            </header>
                            <div class="sandbox-layout">
                                <div class="sandbox-config">
                                    <section class="sandbox-section" aria-labelledby="sandbox-map-title">
                                        <div class="sandbox-section-header">
                                            <h4 id="sandbox-map-title">マップ設定</h4>
                                            <div class="sandbox-map-actions">
                                                <button type="button" id="sandbox-fill-floor">全て床</button>
                                                <button type="button" id="sandbox-fill-wall">全て壁</button>
                                                <button type="button" id="sandbox-clear-markers">階段/開始位置をリセット</button>
                                            </div>
                                        </div>
                                        <div class="sandbox-form-grid">
                                            <label>幅
                                                <input id="sandbox-width" type="number" min="5" max="60" value="21">
                                            </label>
                                            <label>高さ
                                                <input id="sandbox-height" type="number" min="5" max="60" value="15">
                                            </label>
                                        </div>
                                        <div class="sandbox-brush-select" role="radiogroup" aria-label="ブラシ選択">
                                            <button type="button" class="sandbox-brush" data-brush="select" aria-pressed="false">選択</button>
                                            <button type="button" class="sandbox-brush" data-brush="floor" aria-pressed="true">床</button>
                                            <button type="button" class="sandbox-brush" data-brush="wall" aria-pressed="false">壁</button>
                                            <button type="button" class="sandbox-brush" data-brush="start" aria-pressed="false">開始位置</button>
                                            <button type="button" class="sandbox-brush" data-brush="stairs" aria-pressed="false">階段</button>
                                            <button type="button" class="sandbox-brush" data-brush="enemy" aria-pressed="false">敵配置</button>
                                        </div>
                                        <p id="sandbox-selected-cell" class="sandbox-selected-cell" aria-live="polite">セルをクリックして編集します。</p>
                                        <div class="sandbox-brush-options" aria-labelledby="sandbox-brush-options-title">
                                            <h5 id="sandbox-brush-options-title">ブラシオプション</h5>
                                            <div class="sandbox-brush-option-grid">
                                                <label class="sandbox-field-group">床タイプ
                                                    <select id="sandbox-brush-floor-type">
                                                        <option value="normal">通常</option>
                                                        <option value="ice">氷</option>
                                                        <option value="poison">毒</option>
                                                    </select>
                                                </label>
                                                <label class="sandbox-field-group">床の色
                                                    <div class="sandbox-color-control">
                                                        <input id="sandbox-brush-floor-color" type="color" value="#ced6e0" data-has-custom="false">
                                                        <button type="button" id="sandbox-brush-floor-color-clear" class="sandbox-color-clear">自動</button>
                                                    </div>
                                                    <span class="sandbox-color-hint" id="sandbox-floor-color-hint">自動</span>
                                                </label>
                                                <label class="sandbox-field-group">壁の色
                                                    <div class="sandbox-color-control">
                                                        <input id="sandbox-brush-wall-color" type="color" value="#2f3542" data-has-custom="false">
                                                        <button type="button" id="sandbox-brush-wall-color-clear" class="sandbox-color-clear">自動</button>
                                                    </div>
                                                    <span class="sandbox-color-hint" id="sandbox-wall-color-hint">自動</span>
                                                </label>
                                            </div>
                                            <p class="sandbox-note small">選択セルや塗りつぶすマスに色・床タイプを適用できます。</p>
                                        </div>
                                    </section>
                                    <section class="sandbox-section" aria-labelledby="sandbox-player-title">
                                        <div class="sandbox-section-header">
                                            <h4 id="sandbox-player-title">プレイヤー設定</h4>
                                        </div>
                                        <div class="sandbox-form-grid">
                                            <label>プレイヤーレベル
                                                <input id="sandbox-player-level" type="number" min="1" max="999" value="1">
                                            </label>
                                            <div class="sandbox-player-preview" aria-live="polite">
                                                <span class="label">想定ステータス</span>
                                                <span id="sandbox-player-preview">HP 100 / 攻撃 10 / 防御 10</span>
                                            </div>
                                        </div>
                                        <p class="sandbox-note">サンドボックス中は経験値が増えず、終了後に本来のレベルへ戻ります。</p>
                                    </section>
                                    <section class="sandbox-section" aria-labelledby="sandbox-enemy-title">
                                        <div class="sandbox-section-header">
                                            <h4 id="sandbox-enemy-title">敵配置</h4>
                                            <button type="button" id="sandbox-add-enemy">+ 敵を追加</button>
                                        </div>
                                        <div id="sandbox-enemy-list" class="sandbox-enemy-list" aria-live="polite"></div>
                                        <p class="sandbox-note">敵を選択し「敵配置」ブラシでマップ上の位置を更新できます。</p>
                                    </section>
                                </div>
                                <div class="sandbox-map-wrapper">
                                    <div class="sandbox-map-header">
                                        <h4>マッププレビュー</h4>
                                    </div>
                                    <div id="sandbox-grid" class="sandbox-grid" role="grid" aria-label="サンドボックスマップ">
                                        <canvas id="sandbox-grid-canvas" role="presentation" aria-hidden="true"></canvas>
                                        <div id="sandbox-grid-aria" class="visually-hidden" aria-live="polite"></div>
                                    </div>
                                    <dl class="sandbox-legend">
                                        <div><dt>■</dt><dd>壁</dd></div>
                                        <div><dt>□</dt><dd>床</dd></div>
                                        <div><dt>★</dt><dd>開始位置</dd></div>
                                        <div><dt>⬆</dt><dd>階段</dd></div>
                                        <div><dt>✦</dt><dd>敵</dd></div>
                                        <div><dt class="legend-ice">■</dt><dd>氷床</dd></div>
                                        <div><dt class="legend-poison">■</dt><dd>毒床</dd></div>
                                    </dl>
                                </div>
                            </div>
                            <section class="sandbox-section sandbox-start" aria-labelledby="sandbox-start-title">
                                <div class="sandbox-section-header">
                                    <h4 id="sandbox-start-title">起動</h4>
                                </div>
                                <div id="sandbox-validation" class="sandbox-validation" aria-live="polite"></div>
                                <div class="sandbox-start-actions">
                                    <button type="button" id="sandbox-start-button" class="sandbox-start-button">サンドボックスを開始</button>
                                    <span class="sandbox-warning">※ サンドボックスでは経験値を獲得できません。</span>
                                </div>
                            </section>
                        </section>
                        <section id="tool-blockdata-editor" class="tool-panel" data-tool-panel="blockdata-editor" aria-label="ブロックデータ編集ツール">
                            <header class="tool-panel-header">
                                <h3>BlockDataビジュアルエディタ</h3>
                                <p>blockdata.json を読み込み、BlockDimブロックの一覧・編集・書き出しを行います。</p>
                            </header>
                            <div class="blockdata-editor">
                                <aside class="blockdata-sidebar" aria-label="ブロック一覧">
                                    <div class="blockdata-group">
                                        <span class="blockdata-group-label">対象セット</span>
                                        <div class="blockdata-group-buttons" role="tablist" aria-label="BlockDataセット">
                                            <button type="button" class="blockdata-group-button active" data-block-group="blocks1" aria-pressed="true">1stブロック <span class="count" aria-hidden="true">0</span></button>
                                            <button type="button" class="blockdata-group-button" data-block-group="blocks2" aria-pressed="false">2ndブロック <span class="count" aria-hidden="true">0</span></button>
                                            <button type="button" class="blockdata-group-button" data-block-group="blocks3" aria-pressed="false">3rdブロック <span class="count" aria-hidden="true">0</span></button>
                                        </div>
                                    </div>
                                    <label class="blockdata-search" for="blockdata-search-input">
                                        <span>検索</span>
                                        <input id="blockdata-search-input" type="search" placeholder="名前 / キーで絞り込み">
                                    </label>
                                    <div class="blockdata-sidebar-actions">
                                        <button type="button" id="blockdata-create" class="blockdata-primary">+ 新規ブロック</button>
                                    </div>
                                    <div id="blockdata-list" class="blockdata-list" role="listbox" aria-label="ブロック候補"></div>
                                </aside>
                                <div class="blockdata-main">
                                    <div class="blockdata-filebar">
                                        <label class="blockdata-version">
                                            <span>バージョン</span>
                                            <input id="blockdata-version" type="number" min="1" step="1" value="1">
                                        </label>
                                        <div class="blockdata-file-actions">
                                            <button type="button" id="blockdata-reload">再読込</button>
                                            <button type="button" id="blockdata-import">インポート</button>
                                            <button type="button" id="blockdata-copy">コピー</button>
                                            <button type="button" id="blockdata-download">ダウンロード</button>
                                        </div>
                                        <input type="file" id="blockdata-import-file" accept="application/json" hidden>
                                    </div>
                                    <p id="blockdata-dirty-indicator" class="blockdata-dirty" aria-live="polite"></p>
                                    <p id="blockdata-status" class="blockdata-status" role="status"></p>
                                    <form id="blockdata-form">
                                        <fieldset data-blockdata-fieldset disabled>
                                            <legend id="blockdata-form-legend">ブロック詳細</legend>
                                            <div class="blockdata-form-grid">
                                                <label>
                                                    <span>キー</span>
                                                    <input id="blockdata-field-key" type="text" required placeholder="例: b3999">
                                                </label>
                                                <label>
                                                    <span>名前</span>
                                                    <input id="blockdata-field-name" type="text" required placeholder="ブロック名">
                                                </label>
                                                <label>
                                                    <span>推奨Lv</span>
                                                    <input id="blockdata-field-level" type="number" step="1" value="0">
                                                </label>
                                                <label>
                                                    <span>サイズ</span>
                                                    <input id="blockdata-field-size" type="number" step="1" value="0">
                                                </label>
                                                <label>
                                                    <span>深さ</span>
                                                    <input id="blockdata-field-depth" type="number" step="1" value="0">
                                                </label>
                                                <label>
                                                    <span>宝箱</span>
                                                    <select id="blockdata-field-chest">
                                                        <option value="normal">normal</option>
                                                        <option value="more">more</option>
                                                        <option value="less">less</option>
                                                    </select>
                                                </label>
                                                <label>
                                                    <span>タイプ</span>
                                                    <input id="blockdata-field-type" type="text" list="blockdata-type-options" placeholder="例: maze">
                                                </label>
                                                <label class="full">
                                                    <span>ボス階層</span>
                                                    <input id="blockdata-field-bossfloors" type="text" placeholder="カンマ区切り (例: 5,10)">
                                                </label>
                                                <label class="full">
                                                    <span>追加プロパティ(JSON)</span>
                                                    <textarea id="blockdata-field-extras" rows="4" placeholder="{}"></textarea>
                                                </label>
                                            </div>
                                        </fieldset>
                                        <div class="blockdata-form-actions">
                                            <button type="button" id="blockdata-save" class="blockdata-primary" disabled>選択を保存</button>
                                            <button type="button" id="blockdata-delete" class="blockdata-danger" disabled>削除</button>
                                        </div>
                                    </form>
                                    <section class="blockdata-preview-section" aria-label="JSONプレビュー">
                                        <header>
                                            <h4>blockdata.jsonプレビュー</h4>
                                            <span id="blockdata-preview-size" class="blockdata-preview-size"></span>
                                        </header>
                                        <textarea id="blockdata-json-preview" readonly></textarea>
                                    </section>
                                </div>
                            </div>
                            <datalist id="blockdata-type-options">
                                <option value="field"></option>
                                <option value="cave"></option>
                                <option value="grid"></option>
                                <option value="maze"></option>
                                <option value="rooms"></option>
                                <option value="open-space"></option>
                                <option value="circle"></option>
                                <option value="circle-rooms"></option>
                                <option value="single-room"></option>
                                <option value="narrow-maze"></option>
                                <option value="wide-maze"></option>
                                <option value="snake"></option>
                            </datalist>
                        <section id="tool-image-viewer" class="tool-panel" data-tool-panel="image-viewer" aria-label="画像ビューア">
                            <header class="tool-panel-header">
                                <h3>画像ビューア</h3>
                                <p>ユーティリティカテゴリ向けのプレビュー。画像を読み込み、パン・ズーム・回転・伸縮・遠近変換を組み合わせて確認できます（変換はプレビューのみ）。</p>
                            </header>
                            <div class="image-viewer-body">
                                <div class="image-viewer-stage-wrapper">
                                    <div id="image-viewer-stage" class="image-viewer-stage" tabindex="0" aria-label="画像プレビュー領域">
                                        <div id="image-viewer-placeholder" class="image-viewer-placeholder">画像ファイルを選択するか、ここにドラッグ＆ドロップしてください。</div>
                                        <img id="image-viewer-image" alt="選択した画像のプレビュー" draggable="false" />
                                    </div>
                                    <p class="image-viewer-stage-hint">ホイールでズーム、ドラッグでパン、ダブルクリックでビューをリセットします。</p>
                                    <div id="image-viewer-message" class="image-viewer-message" role="status" aria-live="polite"></div>
                                </div>
                                <div class="image-viewer-controls">
                                    <div class="image-viewer-upload">
                                        <label class="image-viewer-file-label">
                                            <span>画像ファイルを選択</span>
                                            <input type="file" id="image-viewer-file" accept="image/*" />
                                        </label>
                                        <div class="image-viewer-upload-actions">
                                            <button type="button" id="image-viewer-reset-view">ビューリセット</button>
                                            <button type="button" id="image-viewer-reset-all">全てリセット</button>
                                        </div>
                                    </div>
                                    <div class="image-viewer-control-group">
                                        <label for="image-viewer-zoom">ズーム</label>
                                        <div class="image-viewer-control">
                                            <input type="range" id="image-viewer-zoom" min="0.1" max="8" step="0.01" value="1">
                                            <span id="image-viewer-zoom-value" class="image-viewer-value">100%</span>
                                        </div>
                                    </div>
                                    <div class="image-viewer-control-group">
                                        <label for="image-viewer-rotation">回転</label>
                                        <div class="image-viewer-control">
                                            <input type="range" id="image-viewer-rotation" min="-180" max="180" step="1" value="0">
                                            <span id="image-viewer-rotation-value" class="image-viewer-value">0°</span>
                                        </div>
                                    </div>
                                    <div class="image-viewer-control-row">
                                        <div class="image-viewer-control-group">
                                            <label for="image-viewer-stretch-x">横伸縮</label>
                                            <div class="image-viewer-control">
                                                <input type="range" id="image-viewer-stretch-x" min="0.2" max="4" step="0.01" value="1">
                                                <span id="image-viewer-stretch-x-value" class="image-viewer-value">100%</span>
                                            </div>
                                        </div>
                                        <div class="image-viewer-control-group">
                                            <label for="image-viewer-stretch-y">縦伸縮</label>
                                            <div class="image-viewer-control">
                                                <input type="range" id="image-viewer-stretch-y" min="0.2" max="4" step="0.01" value="1">
                                                <span id="image-viewer-stretch-y-value" class="image-viewer-value">100%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="image-viewer-control-group">
                                        <label for="image-viewer-perspective">遠近距離</label>
                                        <div class="image-viewer-control">
                                            <input type="range" id="image-viewer-perspective" min="200" max="2000" step="10" value="800">
                                            <span id="image-viewer-perspective-value" class="image-viewer-value">800px</span>
                                        </div>
                                    </div>
                                    <div class="image-viewer-control-row">
                                        <div class="image-viewer-control-group">
                                            <label for="image-viewer-rotate-x">遠近X回転</label>
                                            <div class="image-viewer-control">
                                                <input type="range" id="image-viewer-rotate-x" min="-75" max="75" step="1" value="0">
                                                <span id="image-viewer-rotate-x-value" class="image-viewer-value">0°</span>
                                            </div>
                                        </div>
                                        <div class="image-viewer-control-group">
                                            <label for="image-viewer-rotate-y">遠近Y回転</label>
                                            <div class="image-viewer-control">
                                                <input type="range" id="image-viewer-rotate-y" min="-75" max="75" step="1" value="0">
                                                <span id="image-viewer-rotate-y-value" class="image-viewer-value">0°</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="image-viewer-meta" aria-live="polite">
                                        <h4>メタ情報</h4>
                                        <dl class="image-viewer-meta-grid">
                                            <div class="image-viewer-meta-row">
                                                <dt>ファイル名</dt>
                                                <dd id="image-viewer-meta-name">-</dd>
                                            </div>
                                            <div class="image-viewer-meta-row">
                                                <dt>種類</dt>
                                                <dd id="image-viewer-meta-type">-</dd>
                                            </div>
                                            <div class="image-viewer-meta-row">
                                                <dt>サイズ</dt>
                                                <dd id="image-viewer-meta-size">-</dd>
                                            </div>
                                            <div class="image-viewer-meta-row">
                                                <dt>画像解像度</dt>
                                                <dd id="image-viewer-meta-dimensions">-</dd>
                                            </div>
                                            <div class="image-viewer-meta-row">
                                                <dt>最終更新日</dt>
                                                <dd id="image-viewer-meta-modified">-</dd>
                                            </div>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <div class="selection-card-footer" aria-live="polite">
                <span class="game-brand">Yuローグライク</span>
                <span class="game-version">v1.0.0.0</span>
            </div>
        </div>
    </div>
    <div id="player-summary"></div>
    <div id="toolbar">
        <button id="btn-back">戻る</button>
        <button id="btn-items">アイテム</button>
        <button id="btn-status">ステータス</button>
        <button id="btn-import">インポート</button>
        <button id="btn-export">エクスポート</button>
        <input type="file" id="import-file" accept="application/json" style="display:none" />
        <div id="floor-indicator">1F</div>
    </div>
    <div id="game-screen" style="display:none;">
        <div id="game-container">
        <div id="game-stage"><canvas id="game-canvas"></canvas></div>
        <div id="ui-container">
            <div id="player-stats">
                <div class="card">
                    <div class="stat-line"><span>レベル</span><span id="stat-level">1</span></div>
                    <div class="stat-line"><span>攻撃</span><span id="stat-atk">10</span></div>
                    <div class="stat-line"><span>防御</span><span id="stat-def">10</span></div>
                    <div class="bar hp">
                        <div class="bar-label">HP <span id="stat-hp-text">100/100</span></div>
                        <div class="bar-track"><div id="hp-bar" class="bar-fill"></div></div>
                    </div>
                    <div class="bar exp">
                        <div class="bar-label">EXP <span id="stat-exp-text">0/1000</span></div>
                        <div class="bar-track"><div id="exp-bar" class="bar-fill"></div></div>
                    </div>
                </div>
            </div>
            <div id="message-log"></div>
        </div>
        <!-- 右側ポップアップ用の常時空白スペース -->
        <div id="popup-spacer" aria-hidden="true"></div>
        </div>
    </div>
    <div id="game-over-screen" style="display: none;">
        <div class="game-over-overlay">
            <div class="game-over-card">
                <div class="game-over-icon">☠️</div>
                <h2 class="game-over-title">ゲームオーバー</h2>
                <p class="game-over-message">冒険はここで終わりです...</p>
                <div class="game-over-stats">
                    <div class="final-stat">
                        <span class="stat-label">到達階層</span>
                        <span id="final-floor" class="stat-value">1F</span>
                    </div>
                    <div class="final-stat">
                        <span class="stat-label">最終レベル</span>
                        <span id="final-level" class="stat-value">1</span>
                    </div>
                </div>
                <button id="restart-button" class="restart-btn">もう一度プレイ</button>
            </div>
        </div>
    </div>

    <!-- アイテムモーダル -->
    <div id="items-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>アイテム</h3>
            <div class="item-row">
                <span>HP30%回復ポーション</span>
                <span>x <span id="inv-potion30">0</span></span>
                <button id="use-potion30">使用</button>
            </div>
            <div class="item-row">
                <span>最大HP強化アイテム</span>
                <span>x <span id="inv-hp-boost">0</span></span>
                <button id="use-hp-boost">使用</button>
            </div>
            <div class="item-row">
                <span>攻撃力強化アイテム</span>
                <span>x <span id="inv-atk-boost">0</span></span>
                <button id="use-atk-boost">使用</button>
            </div>
            <div class="item-row">
                <span>防御力強化アイテム</span>
                <span>x <span id="inv-def-boost">0</span></span>
                <button id="use-def-boost">使用</button>
            </div>
            <button class="close-modal" data-target="items-modal">閉じる</button>
        </div>
    </div>

    <!-- ステータスモーダル -->
    <div id="status-modal" class="modal" style="display:none;">
        <div class="modal-content status-modal">
            <h3>プレイヤーステータス</h3>
            <div class="status-section">
                <h4>基本ステータス</h4>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">レベル</span>
                        <span class="status-value" id="modal-level">1</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">経験値</span>
                        <span class="status-value" id="modal-exp">0 / 1000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">HP</span>
                        <span class="status-value hp" id="modal-hp">100 / 100</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">攻撃力</span>
                        <span class="status-value attack" id="modal-attack">10</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">防御力</span>
                        <span class="status-value defense" id="modal-defense">10</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">現在階層</span>
                        <span class="status-value" id="modal-floor">1F</span>
                    </div>
                </div>
            </div>
            <div class="status-section">
                <h4>所持アイテム</h4>
                <div class="inventory-grid">
                    <div class="inventory-item">
                        <span class="item-name">HP30%回復ポーション</span>
                        <span class="item-count" id="modal-potion30">x 0</span>
                    </div>
                    <div class="inventory-item">
                        <span class="item-name">最大HP強化アイテム</span>
                        <span class="item-count" id="modal-hp-boost">x 0</span>
                    </div>
                    <div class="inventory-item">
                        <span class="item-name">攻撃力強化アイテム</span>
                        <span class="item-count" id="modal-atk-boost">x 0</span>
                    </div>
                    <div class="inventory-item">
                        <span class="item-name">防御力強化アイテム</span>
                        <span class="item-count" id="modal-def-boost">x 0</span>
                    </div>
                </div>
            </div>
            <div class="status-section">
                <h4>ゲーム設定</h4>
                <div class="settings-info">
                    <div class="setting-item">
                        <span class="setting-label">選択世界</span>
                        <span class="setting-value" id="modal-world">A世界</span>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">難易度</span>
                        <span class="setting-value" id="modal-difficulty">Normal</span>
                    </div>
                </div>
            </div>
            <div class="status-section" id="modal-dungeon-section">
                <h4>ダンジョン情報</h4>
                <div class="settings-info">
                    <div class="setting-item">
                        <span class="setting-label">構成</span>
                        <span class="setting-value" id="modal-dungeon-summary">-</span>
                    </div>
                    <div class="setting-item" id="modal-dungeon-type-row" style="display:none;">
                        <span class="setting-label">タイプ</span>
                        <span class="setting-value" id="modal-dungeon-type">-</span>
                    </div>
                </div>
            </div>
            <button class="close-modal" data-target="status-modal">閉じる</button>
        </div>
    </div>

    <!-- 敵情報モーダル -->
    <div id="enemy-info-modal" class="modal" style="display:none;">
        <div class="modal-content enemy-modal">
            <h3 id="enemy-modal-title">敵の情報</h3>
            <div class="enemy-stats">
                <div class="stat-row">
                    <span class="label">レベル:</span>
                    <span id="enemy-modal-level">1</span>
                </div>
                <div class="stat-row">
                    <span class="label">HP:</span>
                    <span id="enemy-modal-hp">50/50</span>
                </div>
                <div class="stat-row">
                    <span class="label">攻撃力:</span>
                    <span id="enemy-modal-attack">8</span>
                </div>
                <div class="stat-row">
                    <span class="label">防御力:</span>
                    <span id="enemy-modal-defense">8</span>
                </div>
            </div>
            <div class="damage-simulation">
                <h4>ダメージ予測</h4>
                <div class="damage-row damage-deal">
                    <span class="label">与ダメージ範囲:</span>
                    <span id="damage-deal-range">10-15</span>
                </div>
                <div class="damage-row damage-take">
                    <span class="label">被ダメージ範囲:</span>
                    <span id="damage-take-range">8-12</span>
                </div>
                <div class="hit-rate-info">
                    <div class="hit-rate-row">
                        <span class="label">命中率:</span>
                        <span id="hit-rate">80%</span>
                    </div>
                    <div class="hit-rate-row">
                        <span class="label">敵の命中率:</span>
                        <span id="enemy-hit-rate">80%</span>
                    </div>
                </div>
            </div>
            <button class="close-modal" data-target="enemy-info-modal">閉じる</button>
        </div>
    </div>
    <script src="js/tools/tools-tab.js"></script>
    <script src="js/tools/modmaker.js"></script>
    <script src="js/tools/blockdata-editor.js"></script>
    <script src="js/tools/sandbox.js"></script>
    <script src="js/tools/image-viewer.js"></script>
    <script src="main.js"></script>
    <script src="js/tools/state-manager.js"></script>
</body>
</html>
