# ダンジョンタイプ追加Mod作成ツールの設計

## 目的
トップ画面に「ツールズ」タブを追加し、ダンジョンタイプ追加Modを効率的に作成できる内蔵ツールを提供する。構造（Structure）対応済みの拡張APIを活用し、メタデータ・構造パターン・生成アルゴリズムを一つのアドオンファイルへまとめる作業をガイドすることが目標。

## 要件整理
- 選択画面に新しいタブ「ツールズ」を追加し、既存タブと同等の切り替え操作をサポートする。
- ツールズ内に「ダンジョンタイプ追加Mod作成ツール」を配置する。他ツールが増えても拡張できる構造にする。
- Mod作成ツールでは以下の情報を編集・プレビュー・書き出しできること。
  - アドオンメタ情報（ID・表示名・バージョン・作者・説明）
  - 構造定義（アンカー・タグ・パターン）。クリック操作で床/壁/空白を切り替えられるグリッドエディタを持つ。
  - 固定マップ（階層ごとのレイアウト）。フロア数と各階層の幅/高さ/セルを編集し、`floors.maps` としてジェネレータに埋め込めるようにする。固定マップのみのジェネレータを素早く作れるよう、必要なら自動でテンプレート関数を補完する。
  - 生成アルゴリズムのスケルトン。テンプレートを選ぶとコード断片を挿入でき、複数のジェネレータを束ねる。
  - 出力プレビューは `registerDungeonAddon({...})` 形式のJSとしてリアルタイムに生成し、コピーまたはダウンロード可能とする。
- 生成された構造やジェネレータは後で再編集できるよう、UI側で状態管理を行う。
- 将来的な追加ツールやテンプレート拡充に備えて、サイドバー + メインパネルの二段構成を採用する。

## UI構成
1. **タブ切り替え**: 既存タブボタン群に「ツールズ」を追加。押下で `tab-tools` を表示。
2. **ツールズレイアウト**
   - 左サイドバー: 利用可能なツール一覧をカードまたはボタンとして並べる。現在は「ダンジョンタイプMod作成」のみ。
   - 右メインパネル: 選択中ツールの編集画面を表示。モジュール化しやすいよう `data-tool` 属性で切替。
3. **Mod作成ツールパネル**
   - ヘッダー: タイトルと簡易説明。
   - メタ情報フォーム: ID、表示名、バージョン、作者、説明を入力。
   - 構造エディタ:
     - 構造一覧（追加/削除/選択）。
     - 選択中構造の詳細フォーム（ID、名前、アンカー、タグ）。
     - グリッドエディタ（幅/高さ指定、セルをクリックで「空白」「床」「壁」を循環）。
     - パターンプレビュー（テキスト化）。
  - 固定マップエディタ:
    - 「固定マップを利用」チェックで有効化。フロア数とボス階層（カンマ区切り）を指定。未有効時は `role="note"` 付きのプレースホルダーを表示し、スクリーンリーダーでも切替意図を伝える。
     - 階層リスト（1F,2F,...）を切り替えると専用グリッドが表示され、セルは「壁→床→空白」で循環。
     - 幅/高さの変更、前階層コピー、全床/全壁/全空白ボタンを備える。視覚的には構造グリッドと同サイズのセルを採用。
     - 出力時は `floors: { max, bossFloors, maps:[{floor, layout:[...]}, ...] }` としてジェネレータへ反映する。
  - ジェネレータエディタ:
    - ジェネレータ一覧（追加/削除/選択）。
    - 詳細フォーム（ID、名前、推奨レベル、説明、難易度など）。
    - コードエディタ（`textarea`）。テンプレート挿入ボタンでスケルトンを生成。固定マップ用に `ctx.fixedMaps.applyCurrent()` を呼び出すテンプレートも用意し、固定マップのみのジェネレータは未入力でもテンプレートを自動補完する。
     - 追加オプション: 構造呼び出しのヒントや `ctx.structures` 参照テンプレート、固定マップAPIの概要。
   - 出力セクション:
     - 自動生成されたJS文字列を表示する読み取り専用 `textarea`。
     - 「クリップボードにコピー」「.jsとしてダウンロード」ボタン。
     - 有効性チェック結果（ID未入力など）を警告表示。

## 状態管理とロジック
- `modMakerState` オブジェクトで全入力値を保持し、変更のたびに `renderModMaker()` を再実行。
- 構造グリッドは `matrix[y][x]` 形式で `null`（空白）/`0`（床）/`1`（壁）を保持。描画時にボタンへ変換し、クリックで状態を循環。
- 固定マップはジェネレータごとに `fixed: { enabled, floorCount, bossFloorsText, selected, floors[] }` を持ち、各階層の `matrix` を構造グリッドと同じ形式で管理。`renderModMakerFixed()` でフォームとリストを同期しつつ、非活性時は `aria-disabled` を付与して編集不能であることを明示する。
- ジェネレータコードは文字列で保持し、テンプレート適用時は置き換えまたは追記。
- 出力生成は以下の手順。
  1. メタ情報と状態を検証（ID重複、未入力など）。
  2. 構造は `pattern` をテキスト行配列へ変換、`anchor` を `{x, y}` に整形。
  3. 固定マップが有効なジェネレータは `floors` オブジェクトへ変換し、各階層の `layout` を文字列配列に整形。
  4. 固定マップのみでアルゴリズム未入力の場合は `MOD_MAKER_TEMPLATES.fixed` を自動適用、それ以外は `algorithm(ctx) { ... }` 本体を `new Function` せず文字列として保持。
  5. フォーマット済みJSON風文字列を組み立て、表示/ダウンロードする。
- コピー時は `navigator.clipboard.writeText` を使用し、非対応環境では `document.execCommand` フォールバック。
- ダウンロードは `Blob` + `URL.createObjectURL` + `a` 要素のクリックで実現。

## 今後の拡張余地
- ツール一覧に「構造ライブラリブラウザ」「BlockDimテーブル補助」などを追加しやすい構造。
- 構造グリッドでの矩形塗りつぶし、インポート/エクスポート対応。
- コードエディタへのシンタックスハイライト導入、プリセットテンプレートの増加。
- 作成中データを `localStorage` へ保存し、復帰可能にする。

