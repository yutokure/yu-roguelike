# 計算コンボミニゲーム（仮称: Calculation Combo Mod）設計

## 目的
- 反射神経と暗算力を鍛える高速計算ミニゲームを提供する。
- 足し算/引き算/掛け算/割り算がランダムに出題され、正答を連続させるほど高いEXPを獲得できる「コンボ」感を演出する。
- 難易度ごとに制限時間と配点調整を行い、EASYは練習向け、HARDは瞬発力重視にする。

## 出題仕様
- 問題生成は `generateQuestion(difficulty)` で行う。
- 演算の内訳と値の範囲:
  - 足し算: 0〜99の整数を2つ選び、和を問う。
  - 引き算: 0〜99から2数を選び、大きい方−小さい方に並べ替えて非負解にする。
  - 掛け算: 1〜9の一桁整数同士。
  - 割り算: 10〜99の二桁整数を被除数とし、2〜9の一桁除数で割り切れる組み合わせのみ採用。結果は1〜12に収める。
- 難易度による変化:
  - EASY: 制限時間6秒。足し算/引き算がやや多め（比率 4:3:2:1）。
  - NORMAL: 制限時間5秒。均等比率（1:1:1:1）。
  - HARD: 制限時間4秒。引き算/掛け算/割り算の比率を上げる（2:3:3:2）。
- 全難易度で直前に出題した演算種別は連続で出にくいよう重みを下げる（最低保証は行わない）。

## EXPとコンボ
- 正答時にベースEXP 5 を付与。
- コンボボーナス: `comboCount` を正答後に+1し、`comboBonus = comboCount * 2` を加算。
- スピードボーナス: 残り時間割合 ×4 を切り上げた値を追加（例: 残り50%なら+2EXP）。
- 完全正答（1問もミスせず10連続ごと）にリズムポップを表示し `awardXp(10)` を追加付与。
- ミス/タイムアウト時はコンボを0にリセットし、ペナルティとして `mistakeCount` を加算（EXP減算は行わない）。
- `totalXpEarned` を内部で累積し `getScore()` で返す。

## UI/UX
- 100%サイズのフレックスレイアウト。上部にタイトル・難易度・経過情報（正解数/ミス/コンボ/合計EXP）。
- 中央に大きな問題カードと残り時間のプログレスバーを表示。
- 下部に回答入力欄（数値入力）と送信ボタン、ショートカット説明（Enterで回答 / Escでスキップ）。
- タイムバーは `requestAnimationFrame` で更新し、残り25%を下回ると赤色点滅。
- 正答時はカードをグリーンに一時フラッシュし、獲得EXP内訳をポップ表示。
- ミス時はカードをシェイクさせ、正答を提示して次問へ遷移する。

## 操作と制御
- `start()` で `running = true` にし、ループ開始→次の問題を表示。
- `stop()` はループを停止し、残り時間を保持。
- `destroy()` はリスナー解除・DOM削除・`cancelAnimationFrame` 実行。
- 主要イベント:
  - `form` submitで回答検証。Enterが押されたら即時採点。
  - `keydown` で Esc押下時はコンボリセット＋次問を強制生成（練習用）。EscでのスキップにはEXPなし。

## 内部状態
- `state = { running, combo, totalCorrect, totalMistake, totalXp, bestCombo, question, timeLeft, deadline, pausedAt }`
- `question = { text, answer, type, limit, startedAt, deadline }`
- `lastTimestamp` をtickループで保持し、ポーズ復帰時に時間調整。
- `historyLog` は直近5問の履歴（○/×と演算式・獲得EXP）を表示。

## テスト項目
- 4演算が指示された範囲と難易度比率で生成される。
- 時間切れで自動的にミス扱いとなりコンボが0に戻る。
- スピードボーナスが残り時間に比例し、最大で+4EXP付与される。
- 10連正答ごとに追加ボーナス10EXPが加算され、履歴と表示に反映される。
- Pause/Resume（ホストの`stop/start`呼び出し）で残り時間が保持される。
- `getScore()` が累積EXPを返し、終了時の記録に使える。
