# ミニゲー経験の設計

本ドキュメントは、選択画面に新規タブ「ミニゲー経験」を追加し、いくつかのミニゲームを通じてプレイヤーの経験値（EXP）とレベルのみを成長させる仕組みの詳細設計です。ダンジョン（通常/ブロック次元）とは独立したコンテンツで、取得EXPはプレイヤーと一体化し、そのまま探索に持ち込み可能です。

## 目的 / 要件

- 目的: 戦闘外でも短時間で「遊んで育成」できる導線を提供し、継続モチベーションを高める。
- 範囲: ダンジョン進行・アイテム・敵生成に影響を与えない。影響するのはプレイヤーの `exp` と `level`、および付随する基礎ステータスのみ。
- 互換性: 既存のセーブデータ（`roguelike_save_v1`）と完全互換。新規フィールドは追加読み書きで共存。
- 侵襲度: `index.html` にタブを1つ追加、`main.js` にXP付与の共通APIとタブ切替・モジュラブルなミニゲームホストのみを追加する方針。
- アクセシビリティ: 既存タブ同様、`role="tablist"/role="tabpanel"` と `aria-selected` を付与。

## 用語

- ミニゲー経験タブ: 選択画面の3つ目のタブ。小型ゲームの一覧とプレイ領域を持つ。
- ミニゲームモジュール: 共通インターフェースに従ってホストにマウントされる独立部品（Othello/Snake/Breakout/Pong/Same/Match3 等）。
- EXP付与イベント: ミニゲーム内からホストへ「XPをN付与して」と伝えるコールバック。

## UI 仕様

### タブ追加（index.html）

- 既存: `通常` / `ブロック次元`
- 追加: `ミニゲー経験`

```html
<!-- タブボタン（既存の直後） -->
<button id="tab-button-miniexp" class="tab-button" role="tab" aria-selected="false" aria-controls="tab-miniexp">ミニゲー経験</button>

<!-- タブパネル -->
<div id="tab-miniexp" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="tab-button-miniexp">
  <div class="row">
    <div class="miniexp-layout">
      <div id="miniexp-cat-list" class="miniexp-cat-list" role="listbox" aria-label="カテゴリ一覧" tabindex="0"></div>
      <div id="miniexp-list" class="miniexp-list" role="listbox" aria-label="ミニゲーム一覧" tabindex="0"></div>
      <div class="miniexp-panel">
        <div class="miniexp-toolbar">
          <label for="miniexp-difficulty">難易度</label>
          <select id="miniexp-difficulty">
            <option value="EASY">EASY</option>
            <option value="NORMAL" selected>NORMAL</option>
            <option value="HARD">HARD</option>
          </select>
          <button id="miniexp-start">開始</button>
          <button id="miniexp-pause" disabled>一時停止</button>
          <button id="miniexp-restart" disabled>再開/再起動</button>
          <button id="miniexp-quit" disabled>終了</button>
        </div>
        <div id="miniexp-container" class="miniexp-container" aria-live="polite"></div>
        <div id="miniexp-hud" class="miniexp-hud" aria-live="polite"></div>
        <div id="miniexp-player-hud" class="miniexp-player-hud" aria-live="polite">
          <div class="mini-stat-line"><span>Lv</span><span id="miniexp-hud-level">1</span></div>
          <div class="mini-bar exp">
            <div class="mini-bar-label">EXP <span id="miniexp-hud-exp-text">0/1000</span></div>
            <div class="mini-bar-track"><div id="miniexp-exp-bar" class="mini-bar-fill"></div></div>
          </div>
        </div>
        <div id="miniexp-placeholder" class="miniexp-placeholder">左の一覧からミニゲームを選択してください。</div>
        <div id="miniexp-records" class="miniexp-records" aria-live="polite"></div>
      </div>
    </div>
  </div>
</div>
```

#### スタイル（style.css 追加方針）

- `.miniexp-layout`: 左から「カテゴリ列（約180px）」「ゲーム一覧（約220px）」「プレイ領域（flex:1）」の3ペイン構成。
- `.miniexp-cat-list`/`.miniexp-list`: スクロール可能なリスト。選択項目は `.selected` で強調。
- `.miniexp-container`: 600x400 目安のキャンバス/DOM領域（レスポンシブ）。内部ゲームに合わせて幅を調整。
- `.miniexp-hud`: 獲得EXPの一時的バッジ表示（コンテナに重ね、右上固定）。
- `.miniexp-player-hud`: 常時表示の小型ステータス（右上固定、ゲーム中も一覧でも常に見える）。
  - `position:absolute` で `miniexp-panel` の右上にピン留め、半透明カード、影、小さめのEXPバー。
  - 既存EXPバーに準拠した `.mini-bar`/`.mini-bar-fill`/`.mini-bar-label` を使用。
- `.miniexp-records`: 選択中ゲームのベストスコア/通算プレイ/通算EXPをカード状に表示。

### タブ切り替え（main.js）

- 既存 `setupTabs()` に以下を追加:
  - `tab-button-miniexp` / `tab-miniexp` の表示切替
  - 初回クリックで `initMiniExpUI()` を Lazy 初期化
  - 終了時は進行中のミニゲームがあれば `stop()` して後始末

### リアルタイム表示要件（本要件の反映）
- ミニゲー経験タブ配下の全画面（一覧・プレイ中・記録表示）で、プレイヤーの「レベル」「EXP（数値/バー）」を常時表示する。
  - UI要素: `#miniexp-player-hud`（Lv表示、EXPバー、EXPテキスト）。
  - 値更新: `updateUI()` または `renderMiniExpPlayerHud()` により `player.level` と `player.exp/1000` を即時反映。
  - バー演出: 既存EXPバー同様の幅アニメーション（~250ms）。
- EXP獲得時（例: オセロで石反転）には `#miniexp-hud` 上へ「+N EXP」バッジを即時表示・自動フェード。ゲーム側から `window.showTransientPopupAt()` を呼ぶと任意位置にポップを追加できる。
- アクセシビリティ: `aria-live="polite"` でXP変動を読み上げ可能にし、視覚に頼らない伝達を担保。
- キーボードショートカット: ミニゲー経験タブが表示中は `P` で一時停止/再開、`R` で再起動。ホストが `start()`/`stop()` を直接呼ぶ。
  - アクセシビリティ: `aria-live="polite"` でXP変動を読み上げ可能にし、視覚に頼らない伝達を担保。

## データモデル

### 既存 Player との関係

- 取得EXPは `player.exp` に直接加算（1000到達でレベルアップ）。
- 小数のEXP（例: ×0.5）は「内部保持OK、表示は整数丸め（floor）」とするのが自然。
  - 実装案: 表示時のみ `Math.floor(player.exp)`、レベルアップ判定はそのまま `>= 1000`。

### 追加型（擬似TS）

```ts
type MiniGameId = string; // manifest上の id をそのまま使用

type MiniGameRecord = {
  id: MiniGameId;
  bestScore?: number;      // 例: 最大連鎖、最高スコア
  totalPlays?: number;     // 通算プレイ回数
  totalExpEarned?: number; // 通算獲得EXP
  lastPlayedAt?: number;   // epoch ms
};

type MiniExpState = {
  selected?: MiniGameId;
  difficulty?: 'EASY'|'NORMAL'|'HARD';
  category?: string; // '__ALL__' を含むカテゴリキー
  records: Record<MiniGameId, MiniGameRecord>;
};
```

### 永続化

- 既存 `saveAll()` に `miniExp` を追加保存。

```js
localStorage.setItem('roguelike_save_v1', JSON.stringify({
  // 既存...
  miniExp: {
    selected: miniExpState.selected || null,
    difficulty: miniExpState.difficulty || 'NORMAL',
    category: miniExpState.category || '__ALL__',
    records: miniExpState.records || {}
  }
}));
```

- ロード時は `miniExpState` を復元（存在しなければデフォルト生成）。

## EXP 付与の共通API

### 新設: `grantExp(amount, opts)`

```js
function grantExp(amount, opts={ source:'misc', reason:'', popup:true }) {
  const v = Math.max(0, Number(amount)||0);
  if (v <= 0) return 0;
  player.exp = (player.exp || 0) + v;
  let leveled = 0;
  while (player.exp >= 1000) {
    player.exp -= 1000;
    const beforeLevel = player.level;
    const beforeMaxHp = player.maxHp;
    const beforeAttack = player.attack;
    const beforeDefense = player.defense;
    player.level += 1;
    player.maxHp += 5;
    player.attack += 1;
    player.defense += 1;
    player.hp = player.maxHp;
    leveled++;
    try { showLevelUpPopup(); } catch {}
    try {
      const msg = `レベルアップ！レベル：${player.level}(+${player.level - beforeLevel})|最大HP：${player.maxHp}(+${player.maxHp - beforeMaxHp})|攻撃力：${player.attack}(+${player.attack - beforeAttack})|防御力：${player.defense}(+${player.defense - beforeDefense})`;
      addMessage(msg);
    } catch {}
    if (expBar) {
      expBar.style.transition = 'width 0.25s';
      expBar.style.width = '100%';
      setTimeout(() => {
        expBar.style.width = '0%';
        setTimeout(() => { updateUI(); }, 260);
      }, 260);
    }
  }
  if (opts.popup) {
    try {
      addMessage(`経験値を ${Math.floor(v)} 獲得！（${opts.source}${opts.reason ? ': ' + opts.reason : ''}）`);
    } catch {}
  }
  try { updateUI(); } catch {}
  try { renderMiniExpPlayerHud(); } catch {}
  try { saveAll(); } catch {}
  return v;
}
```

- 既存 `grantExpFromEnemy()` は内部で `grantExp(gained,{source:'battle',reason:isBoss?'boss':''})` を呼ぶよう置換（互換維持）。
- ミニゲームは全てこのAPI経由で付与する。

## ミニゲームのインターフェース

```ts
interface MiniGame {
  id: MiniGameId;
  name: string;
  description?: string;
  create(root: HTMLElement, awardXp: (n:number, meta?:any)=>void, opts:{difficulty:'EASY'|'NORMAL'|'HARD'}): MiniGameRuntime;
}

interface MiniGameRuntime {
  start(): void;
  stop(): void;       // 破棄直前にも呼ばれる
  destroy(): void;    // DOM/イベント完全解放
  getScore?(): number;// 記録用途
}
```

### ホスト（main.js 側）

- `games/manifest.json.js` を `<script>` として読み込み、`window.MINIEXP_MANIFEST` から定義を取得。失敗時は内蔵のデフォルト配列を使用。
- マニフェストからカテゴリ一覧（`__ALL__` 含む）を生成し、`#miniexp-cat-list` に描画。カテゴリ選択で `miniExpState.category` を更新。
- ゲーム一覧は `#miniexp-list` にカード/ボタンとして描画し、選択で `miniExpState.selected` を更新。選択状態や難易度は `saveAll()` に反映。
- `開始` ボタンで `loadMiniGameScript(def.entry)` → `<script>` 追加 → `window.registerMiniGame` を待ち、`create()` の戻り値を保持して `start()` を実行。
- `一時停止`: `runtime.stop()`、`再開`: 再度 `runtime.start()`。UIは Pause ボタンのトグルと `__miniPaused` で管理。
- `再開/再起動`: 現在のランタイムを `quitMiniGame()` で破棄→`startSelectedMiniGame()` を再呼び出し。
- `終了`: `stop()`→`destroy()`→記録更新→UIリセット。記録は `totalPlays`/`totalExpEarned`/`lastPlayedAt`/`bestScore` を更新。
- XP付与は `awardXpFromMini(n, reason)` を経由し、`grantExp(n,{source:'mini',reason:def.id})` を呼ぶ。HUDバッジや記録更新もここで実施。
- ショートカット: `P` キーで Pause、`R` キーで Restart。タブが非表示なら無効。

## EXP獲得ルール（確定仕様）

- 各モジュールは `create()` 内で `awardXp(amount, meta)` を呼び、即時にプレイヤーEXPへ反映する。`meta` には `type`/`combo` などゲーム固有の情報を入れる想定（記録用途）。
- EXPテーブルはゲームごとに独立しており、Manifest v0.1.0 時点で 30 タイトル以上を収録。
- 主なジャンルと代表的な付与ルール:
  - **ボードゲーム**（`othello`/`checkers`/`gomoku`/`ultimate_ttt` など）: 石/駒の裏返し・配置で少量、勝利時に難易度別ボーナス。連続リーチやライン成立時は `meta` に `combo` を入れて `showTransientPopupAt` を利用。
  - **アクション/シューティング**（`snake`/`breakout`/`pong`/`aim`/`dodge_race`/`falling_shooter`/`flappy_bird`/`dino_runner` など）: アイテム取得・敵撃破・距離/生存時間で加算。多くがコンボ（短時間内の連続成功）で倍率を付けている。
  - **パズル**（`same`/`match3`/`tetris`/`triomino_columns`/`ten_ten`/`2048` など）: ライン消去や合成で基礎EXP、連鎖で乗算ボーナス。`tetris` はRENやT-Spinを倍率評価。
  - **ユーティリティ**（`todo_list`/`notepad`/`paint`/`calculator`）: タスク完了や保存操作など日常アクションでEXPを付与。
  - **その他**（`minesweeper`/`sudoku`/`river_crossing`/`steady_wire` 等）: クリアや進捗節目（チェックポイント、段階クリア）にまとまったEXPを支給。
- 各ゲームの詳細設計は個別ドキュメント（例: 「2048ミニゲームの設計.md」「パックマン風ミニゲームの設計.md」など）および本リポジトリの `games/*.js` 実装を参照。追加実装分（的あて/回避レース等）の仕様は「追加アクション系ミニゲーム仕様.md」を参照。

## Manifest v0.1.0 で新規追加された代表的ミニゲーム

- **2048 (`game2048`)**: タイル合成で `log2` を加点。2048達成で +777 ボーナス。
- **テトリス風 (`tetris`)**: ライン消去数とREN/T-Spinを評価し、連鎖で倍率上昇。
- **モグラ叩き (`whack_a_mole`)**: 命中で+1〜3EXP。連続命中時は `combo` バッジで強調。
- **神経衰弱 (`trump_games` 内 memory)**: ペア成立でEXP、連続成功で倍率UP。
- **的あて (`aim`) / 回避レース (`dodge_race`) / 落下シューター (`falling_shooter`)**: 新規アクション群。コンボ継続やチェックポイントで高EXP。
- **川渡り (`river_crossing`) / イライラ棒 (`steady_wire`) / フラッピーバード風 (`flappy_bird`)**: 距離・完走を基準にボーナスを付与。

## 実装方針（段階）

1) ホスト基盤

- `index.html` にタブ/パネル/コンテナ/ツールバー/一覧/記録領域を追加。
- `style.css` に `.miniexp-*` の基本スタイルを追加。
- `main.js`
  - `setupTabs()` に `ミニゲー経験` の切替を追加。
  - `initMiniExpUI()` / `ensureMiniManifest()` を新設し、マニフェスト読込・カテゴリ生成・リスト描画を担当。
  - `grantExp()` を新設し、`grantExpFromEnemy()` を内部委譲に置換（後方互換）。
  - `miniExpState`（selected/difficulty/category/records）のロード/セーブを `saveAll()` に統合。

2) ゲーム別モジュール（最小版）

- `games/` ディレクトリに各ミニゲームを配置し、`window.registerMiniGame({ id, name, create })` で登録。
- `games/manifest.json.js` に内蔵/追加MODのメタデータを記載し、カテゴリ/説明を提供。

3) 記録/HUD/演出

- `#miniexp-hud` に「+N EXP」バッジを短時間表示（既存 `playSfx('pickup')` 再利用）。`showTransientPopupAt` で任意位置表示をサポート。
- `#miniexp-records` に各ゲームのベスト/通算を小カードで表示。Pause/Restart ボタンの状態管理を追加。

4) QA/テレメトリ（ローカル）

- 暗黙の同時実行禁止: 1つのミニゲームのみ起動可能にする。
- `visibilitychange` でタブが非表示になったときは `stop()` を呼び、復帰時に `start()` を再度呼ぶ。
- パフォーマンス: requestAnimationFrame + 1/60sec 目安で `update/render` サイクル。

## 主要ロジック擬似コード

### initMiniExpUI()

```js
let miniExpState = { selected:null, difficulty:'NORMAL', category:'__ALL__', records:{} };
let __miniManifest = null;
let __currentMini = null;

async function ensureMiniManifest(){
  if (__miniManifest) return __miniManifest;
  await injectScript('games/manifest.json.js');
  __miniManifest = Array.isArray(window.MINIEXP_MANIFEST) ? window.MINIEXP_MANIFEST : getFallbackManifest();
  return __miniManifest;
}

function renderMiniExpCategoryList(list){ /* ...カテゴリボタン生成... */ }
function renderMiniExpList(list){ /* ...カテゴリ/選択状態に基づき一覧を生成... */ }

async function initMiniExpUI(){
  await ensureMiniManifest();
  renderMiniExpCategoryList(__miniManifest);
  renderMiniExpList(__miniManifest);
  bindToolbar(); // start/pause/restart/quit/difficulty変更
  renderMiniExpPlayerHud();
  renderMiniExpRecords();
}

function awardXpFromMini(n, reason){
  ensureAudio(); playSfx && playSfx('pickup');
  const gained = grantExp(n, { source:'mini', reason });
  showMiniExpBadge(`+${Math.floor(gained)} EXP`);
  renderMiniExpPlayerHud();
  updateMiniExpRecord(reason, gained);
  return gained;
}

async function startSelectedMiniGame(){
  if (__currentMini || !miniExpState.selected) return;
  const list = await ensureMiniManifest();
  const def = list.find(x => x.id === miniExpState.selected);
  if (!def) return;
  const mod = await loadMiniGameScript(def);
  const runtime = mod.create(miniexpContainer, (n, meta)=>awardXpFromMini(n, def.id), { difficulty: miniexpDifficulty.value });
  runtime.start();
  __currentMini = runtime;
  toggleToolbar({ running:true });
}

function quitMiniGame(){
  if (!__currentMini) return;
  try { __currentMini.stop && __currentMini.stop(); } catch {}
  try { __currentMini.destroy && __currentMini.destroy(); } catch {}
  updatePlayRecord();
  __currentMini = null;
  toggleToolbar({ running:false });
  miniexpContainer.innerHTML = '';
}
```

### showMiniExpBadge()

```js
function showMiniExpBadge(text, opts=null) {
  const hud = document.getElementById('miniexp-hud');
  if (!hud) return;
  const el = document.createElement('div');
  el.className = 'exp-badge';
  if (opts && opts.variant === 'combo') {
    el.classList.add('combo');
    const tier = (opts.level||1) >= 5 ? 'c3' : (opts.level||1) >= 3 ? 'c2' : 'c1';
    el.classList.add(tier);
  }
  el.textContent = text;
  hud.appendChild(el);
  setTimeout(()=>{ try { el.remove(); } catch {} }, 1200);
}

// Lv/EXPの常時HUD描画
function renderMiniExpPlayerHud() {
  const lv = document.getElementById('miniexp-hud-level');
  const expText = document.getElementById('miniexp-hud-exp-text');
  const bar = document.getElementById('miniexp-exp-bar');
  if (!lv || !expText || !bar) return;
  const expMax = 1000;
  const exp = Math.max(0, player?.exp||0);
  lv.textContent = String(player?.level||1);
  expText.textContent = `${Math.floor(exp)}/${expMax}`;
  const pct = Math.max(0, Math.min(1, exp/expMax));
  bar.style.width = `${Math.round(pct*100)}%`;
}
```

## 既存コードへの統合ポイント

- `index.html`
  - タブボタン/パネル追加（IDは上記固定）。
- `style.css`
  - `.miniexp-*` の追加。`tabs`/`tab-content` は既存スタイルを流用。
- `main.js`
  - `setupTabs()` にミニゲー経験タブの分岐を追加。
  - `grantExp()` の追加と `grantExpFromEnemy()` の内部委譲化。
  - `miniExpState` のロード/セーブ（`saveAll()`/初期ロード部）。
  - `ensureAudio()` をミニゲーム開始時にも呼び、効果音を有効化。

## リスク / ガード

- 小数EXP表示ゆれ: 表示は整数丸めに統一（UIのみ）。
- タブ離脱時のリソースリーク: `stop()`/`destroy()` を必ず呼ぶ（イベント/タイマー解除）。
- キーバインド衝突: ゲーム画面の矢印抑止は `game-screen` 表示時のみ。ミニゲームは選択画面内なので干渉しないが、各ミニゲームは `preventDefault()` を適切に使用。
- セーブ肥大化: 記録は最小限（ベスト/通算）。プレイログは持たない。

## テスト計画（要点）

- 付与精度: オセロ1手での反転数を固定盤面で検証（例: 2/3/4反転 → +1/+1.5/+2）。
- レベルアップ: 1000到達と端数保持の両方を自動/手動で確認。
- パフォーマンス: Snake/Breakout/Pong で 60FPS 近傍を維持（中サイズCanvas）。
- 終了フロー: タブ切替/終了ボタン/SPA遷移でタイマー/イベントが残らないこと。

## 導入手順（サマリ）

1. `index.html` にタブ/パネル/コンテナを追加。
2. `style.css` に `.miniexp-*` を追加。
3. `main.js` に `grantExp()` とミニゲー経験タブの初期化/切替処理を追加。
4. `games/` 以下に各ミニゲームの最小実装を順次追加（Othello→Snake→Breakout→Pong→Same→Match-3 の順を推奨）。
5. 表示丸め/セーブ/ロード/効果音の動作を確認し、数値チューニング。

---

以上で、ミニゲームで獲得した経験値がそのままプレイヤー育成につながる「ミニゲー経験」機能を、既存UI/データモデルへ低侵襲に統合可能です。

## 付録: MOD形式での導入手順（簡易）

### 目的
ミニゲームをMODのように追加・配布・導入できる仕組みを提供します。基本は「games/ 配下にJSファイルを置き、`manifest.json.js` に定義を追記」だけで一覧に出ます。

### ディレクトリ構成（例）
```
games/
  manifest.json.js
  othello.js
  snake.js
  breakout.js
  pong.js
  same.js
  match3.js
  assets/
    icons/
      othello.png
```

### manifest.json.js（例）
```js
window.MINIEXP_MANIFEST = [
  { id: 'othello', name: 'オセロ', entry: 'games/othello.js', version: '0.1.0', author: 'you', icon: 'games/assets/icons/othello.png', description: '石をひっくり返してEXP' },
  { id: 'snake',   name: 'スネーク', entry: 'games/snake.js',   version: '0.1.0', author: 'you', description: '餌でEXP' }
];
```

### ホストの発見ロジック
1. `games/manifest.json.js` を `<script>` として読み込み、`window.MINIEXP_MANIFEST` を参照。
2. フォールバック: 失敗時は内蔵のデフォルト定義（manifest未配置でも最低限の内蔵リスト）を使用。

### ランタイム登録
ミニゲームJSは読込完了時に `window.registerMiniGame({ id, name, description, create })` を呼びます。`create()` の戻り値は `start/stop/destroy/getScore` を持つランタイムオブジェクト。

### MiniGameインターフェース（再掲）
```ts
interface MiniGame {
  id: string;
  name: string;
  description?: string;
  create(root: HTMLElement, awardXp: (n:number, meta?:any)=>void, opts:{difficulty:'EASY'|'NORMAL'|'HARD'}): MiniGameRuntime;
}
interface MiniGameRuntime { start(): void; stop(): void; destroy(): void; getScore?(): number; }
```

### 導入ステップ（MOD作者）
- JSファイル内で即時関数などから `window.registerMiniGame({ id, name, create })` を呼ぶ。
- `manifest.json.js` に `{ id, name, entry, category, description }` を1行追加。
- 難易度は `opts.difficulty` で受け取り、XPは `awardXp(n)` を呼ぶだけ。

### 一覧UI（今回の実装範囲）
- タブ: `ミニゲー経験` を追加。
- 左リスト: マニフェストからミニゲームの `name/description/version/author/category` をカードで表示。`選択` ボタンで `miniExpState.selected` を保存。
- 右パネル: 選択状態やガイド文を表示（起動・終了は後続実装）。
