# 見下ろし型レースミニゲーム（仮称: Aurora Circuit）設計

## 目的
- ミニゲームModにおいて、上から見下ろす視点の周回レース体験を提供する。
- シンプルな操作（アクセル・ブレーキ・ステアリング）で心地よい慣性とグリップ変化を味わえるようにする。
- 難易度ごとにライバル車の台数や速度、獲得EXP量を調整し、周回タイム短縮を促す。

## 仕様概要
- コース
  - 円形トラックをベースにしたドーナツ状のコース。内径と外径を用いて走行路/芝生/アウト領域を判定する。
  - スタート/フィニッシュラインは上側（北側）。時計回りに周回する。
  - 特徴づけとして3か所にターボゾーンを配置。通過すると一時的な最高速上限と加速が上昇する。
- 難易度
  - EASY: ライバル2台、勝利条件3周。AI巡航速度は時速換算で約180。ラップ完走+20EXP、ベスト更新+8EXP、優勝+60EXP。
  - NORMAL: ライバル3台、勝利条件4周。AI巡航速度200〜210。ラップ完走+25EXP、ベスト更新+12EXP、優勝+80EXP。
  - HARD: ライバル4台、勝利条件5周。AI巡航速度220〜235。ラップ完走+30EXP、ベスト更新+18EXP、優勝+120EXP。
  - 難易度設定は`opts.difficulty`を参照し、指定が無ければ`NORMAL`。
- 操作
  - `↑ / W`: アクセル
  - `↓ / S`: ブレーキ（停止後はバック）
  - `← / A`, `→ / D`: ステアリング
  - `Space`: ターボエネルギーの解放（ターボゾーン通過後10秒以内で使用可能）
  - `R`: リスタート
- EXP
  - ラップ完了時にベースEXPを付与（難易度で変化）。
  - ベストラップ更新で追加EXP。
  - ターボゾーン通過時に+2EXP、ゾーン毎にクールタイムを設け多重取得を防ぐ。
  - レース完走順位に応じたボーナス（1位/2位/3位以下）。

## UI
- 640x480キャンバスを中央配置。背景は夜の都市をイメージしたカラーリング。
- 画面右上にHUDパネルを配置し、以下を表示。
  - 現在ラップ/目標周回、ラップタイム、ベストラップ
  - ターボエネルギー残量とクールタイム
  - ライバル順位と差分（秒）
- 画面中央にカウントダウン演出 → スタート後は走行描画。
- ゴール時はオーバーレイで順位・総合タイム・獲得EXPサマリを表示し、`R`案内。

## 内部構造
- `create(root, awardXp, opts)`で初期化。`return { start, stop, destroy, getScore }`。
- 状態管理
  - `player`: `{ x, y, angle, speed, lap, lapTime, bestLap, turboGauge, turboActive, finished }`
  - `aiCars`: `[{ laneOffset, progress, speed, lap, lapTime, finishTime }]`
  - `inputs`: 押下状態。
  - `state`: `idle | countdown | running | finished`。
  - `countdown`: 残り秒。
  - `boostZones`: `[{ start, end, id, cooldown }]` 正規化角度区間。
  - `totalTime`: レース経過時間。
- 主要処理
  1. `reset()`で状態初期化、カウントダウン値をセット。
  2. `loop(ts)`で`update(dt)`→`draw()`を実行。`running`のときに物理計算。
  3. `updatePlayer(dt)`で入力→加速度→位置、サーフェス判定による摩擦、ターボ状態管理。
  4. `updateAi(dt)`で巡航速度にランダム変動を加えつつ進行角を更新。周回完了でラップ処理。
  5. `checkLap(entity)`で角度正規化を使いラップ完了を判定し、EXP処理と順位更新。
  6. `applyBoostZones(entity)`でゾーン通過判定。
  7. `updateHud()`でHTML表示を更新。
- `awardXp(amount, meta)`をイベント毎に呼び出し。`meta`には`{ type:'lap'|'best'|'boost'|'finish', difficulty }`などを付加。

## 描画
- Canvas 2Dでトラック（外円/内円/芝生/ブーストマーカー/スタートライン）を描画。
- 車は矩形＋ヘッドライト風の三角形、ターボ中は青色グロー。
- AI車は配色を変えて重なりを避けるため微妙に半径をずらす。
- HUDはDOM要素で、レース結果は半透明オーバーレイのDIVを使用。

## テスト項目
1. 難易度ごとにAI台数・周回数・EXPが変化する。
2. ラップ完了時にEXPが付与され、ベスト更新時は追加EXPが入る。
3. ターボゾーン通過でゲージ充填とEXP+2が行われ、クールタイム中は追加されない。
4. `Space`でターボを発動すると一定時間最高速が上昇し、その後クールダウンする。
5. 壁（内外円）に衝突すると速度が減衰し、外に出ない。
6. AIが規定周回でフィニッシュし、順位表に反映される。
7. プレイヤーがゴールするとレースが停止し、`R`でリスタートできる。
