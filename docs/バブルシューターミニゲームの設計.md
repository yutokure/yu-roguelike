# バブルシューターミニゲーム（仮称: Bubble Shooter Mod）設計

## 目的
- クラシックなバブルシューターを再現し、狙い撃ちと連鎖消去の爽快感を提供する。
- 3個以上同色が接触したグループを消去し、上部に接していない浮遊クラスタは落下させる。
- ミニEXPフレームワークの`create(root, awardXp, opts)`仕様に合わせ、難易度別の色数・ペナルティを実装する。

## 仕様概要
- フィールド構成
  - 六角格子（偶数行は左寄せ、奇数行は半セル右シフト）で管理。
  - ベース列数: 12列。奇数行は末尾セルを無効化して自然な幅を保つ。
  - 初期行数: 5行（難易度HARDのみ6行）。
- バブル
  - 半径: 18px。水平間隔: 36px。垂直間隔: 31px（`radius * sqrt(3)`に基づく）。
  - EASY: 色5種、NORMAL: 色6種、HARD: 色7種。
- シュート
  - マウス移動で照準角を決定。クリックまたはスペースキーで発射。
  - 壁反射対応。発射済みバブルが既存バブルまたは天井に接触すると格子にスナップ。
  - 発射キューを2発先まで表示。次弾はランダム色で補充。
- 消去
  - 着弾地点から同色連結クラスタ（上下左右+斜めに相当する6方向）が3個以上の場合に消去。
  - 消去後、天井（最上段）から到達可能でないクラスタを探索し、該当バブルを落下状態にしてフィールドから除去。
- ペナルティ/ゲームオーバー
  - 発射回数カウントを管理。EASYは8発、NORMALは6発、HARDは5発打つたびに新しい行を最上段へ追加。
  - 新行追加後、バブルが発射ラインより下に到達するとゲームオーバー。
  - ゲームオーバー時は結果表示とリスタート案内（`R`キー）。

## EXP設計
- 基礎: バブル消去1個につき1EXP。
- 同時消去ボーナス: `max(0, 消去個数-3) * 0.5EXP`を上乗せ。
- 浮遊クラスタ落下: 落下個数 × 1.5EXP。
- 行追加時のサバイバルボーナス: 新行投入後に残弾カウンタをリセットするタイミングで+1EXP（継続のご褒美）。

## UI
- Canvas中央配置。上部にタイトル・難易度・消去数・残り発射数を表示。
- 下部中央にシューター砲台円と照準ラインを描画。
- 右下に次弾・待機弾の小バブル表示。
- 消去・落下時は簡易なフェード/落下アニメーション。
- ゲームオーバー時は半透明オーバーレイでメッセージ表示。

## 内部構造
- エクスポート: IIFE内で`create(root, awardXp, opts)`を定義し、`return { destroy }`形式でリスナーを破棄できるようにする。
- 状態管理
  - `grid`: 行ごとの配列。セル値は`null`または `{ color }`。
  - `current`: 発射中バブル。 `{ x, y, vx, vy, color, active }`。
  - `queue`: 次弾色を保持する配列。
  - `floating`: 落下アニメーション中のバブル配列。
  - `shotsLeft`, `shotsCycle`, `totalCleared`, `running`, `gameOver`等。
- 主要処理
  1. 初期化: `grid`にランダム配置。`refillQueue()`でキューを用意。
  2. `loop(timestamp)`で`update(dt)`→`draw()`。
  3. `update`内で発射中バブルの移動、壁反射、衝突検出（最近傍セルスナップ）を処理。
  4. `placeBubble`後に`resolveMatches(row,col)`→`resolveFloating()`を実行。
  5. 発射完了時に`shotsLeft`を減少。0になると`pushNewRow()`。
  6. 落下バブルは独立配列で重力加速度を与え、画面外で破棄。
- ユーティリティ
  - `cellCenter(row,col)`・`neighbors(row,col)`・`clusterFrom(row,col,color)`。
  - `addRow()`で新行生成。奇数行は右端セル無効。
  - `reset()`で状態リセットしリスタート対応。

## テスト項目
- 3個以上接続で確実に消える（斜め方向を含む六方向連結）。
- 浮遊クラスタが全て落下し、落下EXPが加算される。
- 壁反射で角度が維持される。
- 発射カウントで新行が追加され、追加タイミングでEXP+1。
- 新行追加後に下端へ到達するとゲームオーバーになり、`R`でリセット可能。
- EASY/NORMAL/HARDで色数・初期行数・行追加周期が変わる。
