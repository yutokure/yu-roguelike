# ダイアグラムメーカーの設計

MiniExp MOD のユーティリティカテゴリへ、draw.io ライクな図表作成ツール「ダイアグラムメーカー」を追加する設計。ノード配置・コネクタ編集・レイヤー管理を備え、図の作成/削除やファイル操作ごとに EXP を付与する。draw.io 互換の XML 読み書き、および PNG/JPG/BMP での書き出しもサポートする。

- ID: `diagram_maker`
- 表示名: ダイアグラムメーカー
- エントリ: `games/diagram_maker.js`
- バージョン: 0.1.0
- カテゴリ: ユーティリティ
- 目的: ワークフロー図や UML、ネットワーク構成図など多様な図表をブラウザ上で作成し、既存の draw.io ファイル資産とも往復可能にする。

## 画面レイアウト
1. **ウィンドウシェル**: 既存ユーティリティと統一したカード型。上部にタイトルバー、左にツールパレット、右にプロパティパネル、中央にキャンバスを配置。フッターにはズームスライダーと現在の EXP を表示。
2. **タイトルバー**: ファイル名と変更状態（* 表示）。「新規」「開く」「保存」「書き出し」ボタンを右寄せに配置し、ドロップダウンから書き出し形式を選択可能にする。
3. **ツールパレット**: アイコンボタンで図形カテゴリ（基本図形/矢印/フローチャート/UML/ネットワーク/テキスト/画像）を縦並び。カテゴリ選択で下部にサブグリッドを展開し、ドラッグ＆ドロップでキャンバスへ追加。
4. **キャンバス**: `svg` ベースの描画領域。スナップグリッド（10px 単位）とガイドラインを表示。パン/ズームはホイール + 修飾キー、ドラッグで矩形選択。コンテキストメニューでコピー/ペースト/整列。
5. **プロパティパネル**: 選択要素のサイズ、位置、色、線種、テキスト等をフォームで編集。複数選択時は共通プロパティのみ表示。タブ切り替えで「スタイル」「配置」「レイヤー」「履歴」を切り替え。
6. **履歴パネル**: 最大 100 アクションの Undo/Redo スタックを視覚化し、タイムラインから任意ポイントへジャンプできる UI。

## 状態管理
- `state = { documentId, fileName, diagram, selection, zoom, gridVisible, snapToGrid, history, xp, lastActionAwardAt }` を保持。
- `diagram` はノードリスト（`nodes[]`）、エッジリスト（`edges[]`）、レイヤー定義、ページ設定を含む。
- `history` は Undo/Redo 用のコマンドスタック。1 コマンドで複数要素の追加/変更をまとめる。
- ローカルストレージキー `mini_diagram_maker_state_v1` に直近 5 件の自動保存スナップショットを保持。アプリ起動時に最新を復元する。

## 描画機能
- 図形の追加: パレットからドラッグ時にノードを生成し、キャンバス上へ配置。スナップを適用して座標を丸める。
- 変形: 選択ボックスのハンドルでリサイズ・回転。Shift で等比、Alt で中心基準。
- コネクタ: ノードのポートに吸着し、矢印スタイルや折れ線/直線/曲線を切り替え。コネクタのルーティングは簡易的なマンハッタン方式。
- テキスト編集: ダブルクリックでインライン編集。フォント、サイズ、装飾をプロパティパネルで変更。
- レイヤー: パネルから新規/複製/ロック/非表示を制御。レイヤー毎に要素をグループ化。
- グリッド/ガイド: 表示切替とスナップの ON/OFF をトグルボタンで制御。

## ファイル操作とフォーマット
- **新規**: 空キャンバスを生成。未保存変更がある場合は確認ダイアログ。
- **開く**: `input[type=file]` で `.drawio`, `.xml`, `.dio`, `.png` (draw.io 埋込 XML) を受け付け。PNG の場合はメタデータから XML を抽出し、`diagram` へ変換。
- **保存**: 内部状態を draw.io 互換 XML（`<mxfile><diagram>...</diagram></mxfile>`）で Blob 化しダウンロード。複数ページにも対応し、現行ページのみ出力。
- **書き出し**: キャンバスをレンダリングし PNG/JPG/BMP を生成。SVG → `<canvas>` へ描画し `toDataURL()` で変換。透過背景は PNG のみに適用。
- **自動保存**: 60 秒ごとまたは重大操作（保存/書き出し）後に `localStorage` へ最新 XML を保存。

## draw.io XML 対応
- インポート: `DOMParser` で XML を解析し、`mxGraphModel` 内の `mxCell` をノード/エッジにマッピング。スタイル文字列をパースして色・線幅・フォント等を再現。
- エクスポート: 内部ノード/エッジ情報から `mxCell` を組み立て、レイヤー（`<root>` 階層）とジオメトリ（`<mxGeometry>`）を構築。不要属性は省略し、互換性確保のため `version="21.6.5"` とする。
- 互換検証: 代表的な図（フローチャート・UML・ネットワーク）で round-trip を確認し、draw.io 側での表示を検証するテストデータを準備。

## EXP 仕様
- アプリ起動時に `awardXp(5, { type: 'open' })` を呼び、1 セッションにつき 1 回のみ。
- 図形の追加・削除・複製でそれぞれ `awardXp(2, { type: 'shape_edit' })`。同一 5 秒間での連続操作は 1 回に集約（スロットル）。
- コネクタ作成/削除は `awardXp(2, { type: 'connector_edit' })`。
- ファイル読み込み成功時に `awardXp(8, { type: 'import' })`。
- XML 保存完了時に `awardXp(10, { type: 'save_xml' })`。上書き保存も対象。
- 画像書き出し（PNG/JPG/BMP）完了時に `awardXp(6, { type: 'export_image', format })`。
- 履歴操作（Undo/Redo）は EXP を付与しない。`lastActionAwardAt` を使って 5 秒ルールを実装。

## API 実装方針
- `create(root, awardXp, opts)` で DOM 構築と状態初期化。`opts` には初期テンプレート ID や読み込みデータを受け取れるようにする。
- 内部ユーティリティ: `importMxFile(xmlString)`, `exportMxFile()`, `renderCanvas()`, `exportImage(type)`, `scheduleAutosave()`, `applyCommand(cmd)`。
- イベントバインドは `start()` でまとめて行い、`stop()` で解除。`destroy()` で autosave タイマーとストレージ書き込みをクリア。
- `getScore()` はセッション中の EXP 合計を返却し、MiniExp の統計に利用。

## 実装手順
1. `games/diagram_maker.js` を新規作成。UI テンプレート、状態管理、draw.io 互換処理、エクスポート処理を実装。
2. `games/manifest.json.js` にユーティリティカテゴリの新エントリを追加し、サムネイル・説明文・対応ファイル形式を記載。
3. `main.js` で必要ならアイコンアセット（SVG）を登録し、カテゴリ一覧に表示。
4. 代表的な draw.io サンプルを `bak/samples/diagram_maker/` に保存し、ラウンドトリップ検証を行う。
5. UI/UX チェック（ズーム・パン・レイヤー・ショートカット）と EXP 付与のスロットル動作を確認。

## 互換性とガード
- draw.io XML のバージョン差異に備えて未対応属性は保持したまま `mxCell` へ透過する（`data-` プレフィクスで退避）。
- 画像書き出しで `toDataURL('image/jpeg')` を用いる場合、背景色設定が無い場合は白塗りを適用。BMP は `image/bmp` MIME が使えない環境では警告トーストを表示。
- 大規模図面（ノード 500+）ではレンダリング負荷が高いため、ズームレベルに応じた描画最適化（`requestAnimationFrame` バッチ）を行う。
- ブラウザ互換: 最新 Chrome/Edge/Firefox をサポート。`<foreignObject>` の利用は避け、テキストは標準 `<text>` のみで表現。

